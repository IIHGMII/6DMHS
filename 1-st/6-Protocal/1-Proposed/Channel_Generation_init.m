function [ h , e0 , theta, phi , theta_scatterer , phi_scatterer , IOTA , eta , Omega ] = Channel_Generation_init( K,B,M,Mx,My,normal_vector,K_rice,Coor_Ele,lambda , Rot_Matrix )

    dx = lambda/4;   %x轴方向天线间隔
    dy = lambda/4;  %y轴方向天线间隔
    delta_x = ( 2 * [0:(Mx-1)].' - Mx + 1 )/2; delta_y = ( 2 * [0:( My-1)].' - My + 1 )/2;
%% 针对初始6DMA位置，生成无线信道
PL    = 32.4 + 17.3 * log10( 6 ) + 20 * log10( 30 ) - 26 ; % Path-loss,包含20dB天线增益
Omega = 10^( -PL/10 ) * ones(K,B);  % path-loss
IOTA  = 10;         % 散射体数量
theta =  rand(K,1) * 2 * pi; phi = rand(K,1) * 2 * pi; % K个用户的水平角和俯仰角
% theta = 5.263863993147139 ; phi =  1.057064847365129;
theta_scatterer = rand(K,IOTA) * 2 * pi; phi_scatterer = rand(K,IOTA) * 2 * pi; % K个用户的水平角和俯仰角
% NLoS链路信道
for k = 1:K
    for iota = 1:IOTA
        eta(k,iota) = 1/sqrt(IOTA) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
    end
end

theta = [2.27428375349665
2.14767004150145
3.73580545672550
2.67349180693560
4.31753930426782
5.95839228916405];
phi = [2.49355122604204
1.21623810790910
5.89308946717690
4.03812477387363
3.68453710669960
4.86725963859615];
theta_scatterer = [1.76684413581649	4.62272026465501	0.375731936739646	4.66032165726127	5.99753646982665	2.58769473508340	5.29039780753036	4.37748746197965	1.61547081960221	5.52562316768736
4.14390670612859	4.90395645339518	4.19730135294095	2.05046713903122	0.0683170752978759	1.61650683567071	0.379075235036596	3.28380667364753	2.52852293024770	5.63320641141254
1.95124500345246	2.74521303320084	5.52731730466685	2.88103775756949	1.86441750409057	6.21949094653841	4.76380689564765	4.99679469814591	3.96006971468889	4.81623883752616
1.98641222690321	2.36952760514261	0.0454576465835545	3.41640138981427	4.65629513183143	2.16069036451762	1.26774985655504	4.99543506614870	0.452914158665481	4.11659749471210
5.24858239889462	4.08267229448299	3.46211051902311	3.79225710587950	1.09974003114598	1.16294718424398	1.03358691571993	6.05491898433725	3.14500014853166	5.92884473491094
1.69482679076170	4.86954527284953	5.45224510332672	1.63247921756746	2.13392983979420	5.87044638586696	2.10076229586752	0.284596469316465	0.118273849130503	3.67329284652231];
phi_scatterer = [5.76018798431498	0.933849224577497	2.22102909772429	4.62230209512382	5.80465086757005	3.84639457995521	4.18203142157279	6.15170818655638	6.06913484257145	1.98675155192100
5.35298131416045	2.52413163778560	1.36961916466999	4.70882431271625	2.16147070963727	6.05353528947222	3.73133363349588	0.357564018997427	4.67591298597618	0.233352656593571
0.889624580155674	1.73841868796919	1.66453956753382	4.56626638969965	6.19296753105892	2.25302696215716	1.76767247234096	2.02993373406157	5.84507228070784	2.95944522135835
5.35700896901694	3.34224697460607	3.57514186865749	2.70615657224438	5.78808036701129	4.73863363824753	5.93282847551791	4.73019546719209	1.63633071484973	0.789516084853624
5.69480440248331	3.62584137819553	4.90304531513942	3.19267735149770	4.26129837114025	5.97591002634156	3.14629878685444	0.957624710903693	5.80027628730814	3.13812800199843
4.60545514523444	5.68598903292003	0.249894659921830	1.78399184984988	0.874641848761954	5.85533370575838	1.57119928949835	5.37217378653945	4.08264649321720	2.46553769338984];
eta = [-0.172459826283410 - 0.236905214311042i	-0.0770907796691612 + 0.268955661271319i	-0.110706287869476 - 0.107189840092550i	0.0229244058965988 + 0.288874879323819i	-0.189687950358087 - 0.211586093856964i	-0.271760187073740 + 0.0853612848418200i	0.142076770712123 - 0.141328793597830i	-0.0737386086853378 - 0.229991131621631i	-0.0436332106476139 + 0.175650478869777i	0.209734655730070 - 0.138288692928696i
0.0465397273635513 - 0.174940768125979i	0.679120556078597 - 0.182383257103850i	0.00545015136409704 + 0.230589676251710i	0.0543812218753669 - 0.490773455931107i	-0.122572840059765 + 0.105910131682219i	0.294839237097052 + 0.147478383454368i	0.222808744403064 - 0.129763030866573i	-0.0273866156671642 + 0.0607868248505932i	-0.254932710439810 + 0.163236052054506i	0.518276018898494 - 0.141195694720972i
0.0276088402016335 + 0.0399055527908859i	0.236266503756895 - 0.202840909174340i	-0.0284499253913525 + 0.112824804364795i	-0.242003776586087 + 0.0707375902023586i	0.150899623910512 + 0.222857717649074i	0.0885431032726849 - 0.0193521289798144i	-0.0871618489900216 - 0.324082045531531i	-0.0850331223702959 - 0.136726839939829i	-0.263274873842536 + 0.0722983786744651i	-0.189719965655881 + 0.126219902225571i
-0.480246498667947 + 0.172396767605580i	0.0320293470262099 + 0.180332235660876i	0.0897690440602448 - 0.275979037583644i	-0.214783468421726 - 0.0250187419885269i	0.110596585110361 - 0.141584797817709i	0.0102536799900890 + 0.0190829642273321i	0.367714516226483 - 0.0720420318949185i	-0.0585706207888484 - 0.243193944415071i	0.0848940289443819 - 0.277340203158137i	-0.686005084185161 - 0.414586280686960i
0.00435942762559454 + 0.0212195793745940i	-0.132797860961402 + 0.159633423064384i	-0.00203548385866404 + 0.0258212992324782i	0.0341957139302022 + 0.332708257338544i	-0.0556651393908914 + 0.121209386544445i	0.0118344342619865 - 0.829869753263746i	-0.157653424241899 - 0.0613981479302910i	-0.269252322731459 - 0.314295417753885i	0.0265203939639012 - 0.565038482462767i	0.218165870410374 + 0.229778236626459i
-0.229595831523941 + 0.606985057907317i	-0.311739907828032 + 0.0244963336754475i	0.419939915970307 + 0.237152552244700i	0.479853858407496 - 0.0254476112704363i	0.0614925939137659 - 0.332100954768346i	-0.0341509538251418 - 0.00617979348390805i	0.184806938117401 - 0.507628101734042i	-0.452069254877950 + 0.0423885615722217i	-0.0230186164953957 - 0.145304112108213i	-0.128385124839096 - 0.216059108226022i];




%% 生成无线信道
% LoS链路信道
for k = 1:K
    for b = 1:B
        h{k,b} = sparse(M,1);%%%%%%%%%%%%%%%%%%%%%注意
            e0{k} = [ sin(phi(k)) * cos(theta(k)) ; sin(phi(k)) * sin(theta(k)) ; cos(phi(k)) ];
            % e = Rot_Matrix{b}.' * e0;
            if dot( normal_vector{b} , e0{k} ) > 0
                Lambda_LoS(k,b) = 1;
            else
                Lambda_LoS(k,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(K_rice/(K_rice+1)) * sqrt(M) * sqrt(Omega(k,b)) * Lambda_LoS(k,b) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e0{k} ) );
    end
end

%% 测试
for b = 1:B

    Px{b}    = dx * Rot_Matrix{b} * [1;0;0];
    
    Py{b}    = dy * Rot_Matrix{b} * [0;1;0];
    
    T{b}     = exp( 1j * 2*pi/lambda * ( kron( delta_x * ( Px{b}.' * e0{1} ) , ones(1,My) ) + kron( ones(Mx,1) , delta_y.' * ( Py{b}.' * e0{1} ) ) ) );

end








for k = 1:K
    for b = 1:B
        % h{k,b} = 0;%%%%%%%%%%%%%%%%%%%%%注意
        for iota = 1:IOTA
            % eta(k,iota,b) = 1/sqrt(IOTA) * Omega(k,b) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
            e1{k,iota} = [ sin(phi_scatterer(k,iota)) * cos(theta_scatterer(k,iota)) ; sin(phi_scatterer(k,iota)) * sin(theta_scatterer(k,iota)) ; cos(phi_scatterer(k,iota)) ];
            % e = Rot_Matrix{b}.' * e;
            if dot( normal_vector{b} , e1{k,iota} ) > 0
                Lambda(k,iota,b) = 1;
            else
                Lambda(k,iota,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(1/(K_rice+1)) * sqrt(M) * sqrt(Omega(k,b)) * Lambda(k,iota,b) * eta(k,iota) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e1{k,iota} ) );
        end
    end
end
% for k = 1:K
%     H{k} = [];
%     for b = 1:B
%         H{k} = [H{k} ; h{k,b} ];
%     end
% end








end