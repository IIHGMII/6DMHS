function [ h , e0 , theta, phi , theta_scatterer , phi_scatterer , IOTA , eta , Omega ] = Channel_Generation_init( K,B,M,Mx,My,normal_vector,K_rice,Coor_Ele,lambda , Rot_Matrix )

    dx = lambda/4;   %x轴方向天线间隔
    dy = lambda/4;  %y轴方向天线间隔
    delta_x = ( 2 * [0:(Mx-1)].' - Mx + 1 )/2; delta_y = ( 2 * [0:( My-1)].' - My + 1 )/2;
%% 针对初始6DMA位置，生成无线信道
PL    = 32.4 + 17.3 * log10( 6.5 ) + 20 * log10( 30 ) - 26 ; % Path-loss,包含20dB天线增益
Omega = 10^( -PL/10 ) * ones(K,B);  % path-loss
IOTA  = 60;         % 散射体数量
theta =  rand(K,1) * 2 * pi; phi = rand(K,1) * 2 * pi; % K个用户的水平角和俯仰角
% theta = 5.263863993147139 ; phi =  1.057064847365129;
theta_scatterer = rand(K,IOTA) * 2 * pi; phi_scatterer = rand(K,IOTA) * 2 * pi; % K个用户的水平角和俯仰角
% NLoS链路信道
for k = 1:K
    for iota = 1:IOTA
        eta(k,iota) = 1/sqrt(IOTA) * Omega(1) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
    end
end

theta = [ 2.03263718751901
4.07058266912980
0.679045774840504
1.29801111980956
2.11054963551253
3.92893090179790 ];

phi   = [ 1.93863532175536
1.09092295946302
2.82235689967111
0.654229967795399
2.18959901836448
6.18194350026911 ];

theta_scatterer = [ 1.05531809252226	3.16590812120694	4.87096383949649	2.90367826183905	2.73473860159712	1.74438600996055	0.484114557784296	2.12472526285426	2.77754329661239	3.47056852302315	5.96935485273438	0.0384210702122958	2.50301172446121	0.463843025759462	3.17064800510018	2.92437722251924	3.09595222834560	0.639446872318923	1.08312547041707	5.62322491435546	1.80063672899917	3.18909357240540	6.06387206215103	1.02892175945896	4.28460579747968	4.63455904663941	4.87282703621898	4.02807483398543	3.16074115461996	5.07144564295282	3.04091738238454	0.441093281921468	1.10428300319982	6.00846815700581	3.81222377209680	4.76159461019614	1.61667250396296	3.30761363495901	1.52094569338808	0.492496127663851	4.71679029930739	1.08968056770398	2.10949484115289	2.91621041644502	1.88940041454025	2.04497015032246	3.45093474778319	5.77651999256175	3.48061420960920	2.87342328613882	3.00612352679953	0.913979396097019	0.0863073667827679	6.23366886197306	4.09526604931474	3.30639945919046	0.797676854155866	2.25972629779711	4.09907621779891	2.08602466539245
4.83153725793074	1.54040758620250	1.95668522550547	4.34490883724470	2.50564021824355	5.82102130221051	2.83090664885851	5.57046916557386	3.13693067716687	3.03863276082072	1.52095868313999	5.66752801250787	3.17791534164321	4.47087739249792	4.26415805892083	1.54384218628736	5.74041457719063	4.81793453024683	5.02761592222987	3.83892258456990	0.363461870677749	3.64144088364657	5.96303248596930	4.57287283246949	0.737816503504576	4.57493829313801	1.68597440316913	1.10483793433064	0.967950085869322	4.75534238906549	0.505219785506316	2.56440194005734	1.59114928397287	5.49793005043357	1.41953000415489	3.19371632155618	4.93643327662548	3.34767479455275	4.19148457754187	2.20678004752377	0.245018035986172	0.943515818124193	3.91230376206541	5.69023588657733	5.44770216580227	2.06168939423333	0.813521810919286	3.75490554292065	2.27749626065513	5.92681570641158	4.26785380555203	1.35241267338799	0.293147021760608	5.30433310248472	5.28930506514637	3.30096101875732	4.06060585833964	5.01700047315784	2.41803145494238	2.24527195148427
1.87012857355897	2.11236921904354	4.48083982877682	2.92442002450719	0.597990517611603	4.90631341692083	2.90952357144049	2.65086642703067	0.725351194758197	1.24095289986019	2.81773280516396	3.99981206596459	2.58130384741804	3.39452592453718	3.93507090408642	1.92937857224809	4.06878550902748	6.07619183517785	0.606371415634196	3.69700029194720	0.507160213479461	4.03197128119359	0.272821268190511	5.41199918630365	2.69963456006392	6.19467699013405	4.50375655448769	2.67600412553373	4.59576772211677	2.97633081683772	2.50157705589382	0.906025071376548	1.73573694218507	5.17644078398689	2.60962737091762	4.55431913259807	4.59621450812955	5.26872632311883	5.43751908888864	1.29680622455124	6.01913244839695	3.23363556185183	1.40774589666296	4.14526904263330	0.0237622995968236	6.21427165529734	3.97848549977211	0.204329123072039	0.330569894904193	1.82059117510591	3.32531480660307	4.23846965590154	0.250947745070834	5.25930277215013	5.20189321685596	2.50911913867621	2.35609584520452	3.77599072418392	2.63990489061849	6.19632007626317
4.66097968166312	3.28289522187751	5.99692075166699	2.87729495350900	1.62509427374293	0.274413990403625	2.68289862298322	4.98382676941520	3.72298683626292	1.61248363451200	5.54894537162001	3.65177094709427	2.36179645071579	1.55412327005116	5.53358527242572	1.11081964307744	0.286527345989692	2.72215940432472	6.11917344418958	0.0604266867231283	1.38080825089571	3.98891367747665	4.14245668007207	4.61553513267027	3.54093521227520	0.884114201295073	4.43882111944942	0.887501755770392	3.95153090433708	2.26893872586311	5.24490438926948	2.69895282542481	4.91247811509489	2.18585703164473	2.23142279056818	1.44318666494938	4.27768721660531	0.252138532921970	4.51163218909665	5.84188779495549	5.37830352787842	6.21423968677551	3.20618902772967	5.65954517040086	1.29443222179420	3.47792739433137	4.00834732816370	4.87360350564783	0.127804871413628	1.11317714052891	3.35393831239841	1.90917910765894	1.55959433394571	3.14592177100199	5.40301250567175	1.15827519854679	0.541457520410641	4.99048692788172	3.84201394409690	4.24909040657947
2.74927663136694	4.28973224926372	0.572049538429625	1.32697323349444	5.76849746474098	2.30363828136696	0.771900868834886	0.358646344564210	3.18255856338309	3.98305731596724	1.48456156119200	1.77284351222773	3.64690560774024	2.19645152163834	1.13063827680045	1.63756578881901	4.20934085520595	1.50329345021283	4.89417646062590	0.675683390890636	3.83259016958793	0.139386744836562	1.11478802177026	5.90973489413150	2.72068219101420	2.96817760547361	3.59322051829257	0.200357832437350	6.02949612695167	4.36914934680410	6.02429376022803	3.53535810328711	2.07778683911256	2.13620549377584	5.28150465656886	2.34953821209782	3.63320094112667	3.66918450457019	3.57917199824500	5.72172728986624	2.89254012214310	2.51311724388794	4.00066417127412	2.51566224924004	3.32041398641270	2.54897061920454	1.97648271770871	5.22828704543265	0.249431797445104	0.236440548606075	5.90682770707774	1.09938382541482	2.59111003969099	4.60761424246321	1.25868020435272	1.14616740346443	5.94970913699337	2.31486701704267	0.923740034782973	3.55811818081968
3.72377193480037	3.49165569766504	4.84481845478737	2.53001454751151	1.81792634449246	6.19195940155202	4.42242690585376	4.17254136488101	4.41418946501580	5.00231139563848	2.80335270847738	5.33416792548386	4.79054228444871	5.59218764473939	5.80800599468531	2.05426801685434	1.06978073562334	6.07637507773052	2.47508933254333	0.523041527278492	3.60766631604896	2.63858641367026	0.313593717447438	5.48431555461940	1.33335786803082	1.15871611981613	3.01191326310203	5.52259417605948	2.65011052316835	4.47648919867312	1.66607022044775	1.84671710258151	2.76712454175894	5.54003996312053	2.44615951166237	6.21941531042431	4.23961836860077	4.32204134758883	1.48257442339235	5.79814913347393	4.75107873491732	0.0770182291404503	2.75355689924255	3.32194451245556	4.15746993342307	3.28743071350524	3.56111081440218	4.68493285536519	3.70770860562960	4.12848214798030	1.64165531563155	5.82929034718374	0.953705241750014	3.24827212935644	1.25798633344609	1.00168176666790	2.28193195912801	4.71725455062320	0.380633385539462	5.65543543045951 ];

phi_scatterer   = [ 5.71360384382728	0.810683178636804	3.39805251008714	5.03212818794037	0.535365781924020	3.74827887403316	0.485523996698856	0.0229928712749704	0.859978669688808	1.86018033140960	0.194358567200188	5.87798924743553	1.90521340400373	0.298912176933103	4.89060138308683	6.13482308511508	0.0922306455261804	1.23129693660320	0.398034311120627	0.804380696277850	4.53954415770066	5.78428651456385	4.70015856299485	6.13925387689371	6.14920067379466	4.72718082847139	4.84441204994091	2.87585231953922	0.624603500611279	5.69498904969488	4.70276783896370	2.41415954036133	3.65474469265723	6.27366586191933	0.140425007812100	4.87880863039789	3.90963540951157	2.36055426176969	1.12618213763226	2.06512309937273	3.47921183919305	4.36190711245036	5.15655633965802	4.10068508337267	4.79939029188017	0.872210374913414	1.76979706484036	0.983045568714243	2.53822949439298	5.26884448825479	0.939563421271890	2.36728597688359	3.68001746374162	4.85301793379860	4.04044870456866	0.0686586124602489	5.18828966560103	2.23944760629371	1.99549887043822	1.79233220984965
0.350433883667134	0.209125216044113	4.77504673534356	3.98258822586213	4.78338065476962	4.92911822044681	5.50454696156193	4.81915424410480	0.172645267165058	0.385942667703864	2.16339878528068	0.962998516768821	2.58076311353854	2.57084923543651	0.575822493977036	1.73066059942300	1.01171871426908	5.49299616274097	4.37284143233190	0.246414597910146	5.79564334873903	2.73037058977476	0.754277697383948	3.07667968508473	0.193646001960648	1.04591354273777	5.85455714036680	0.532108318936570	1.18603050305615	2.62109882307224	5.95602598490111	3.43454949583505	5.69077905538846	2.44461198857321	4.18544790762781	5.84912370769276	4.86742619367413	6.12483343271909	4.49186215824488	2.69757061023917	3.08232986366469	5.47895648065024	4.05220091382391	3.15793839308581	4.71972102164154	1.73650499440792	5.12114977158229	4.77203006960523	0.258172939635238	2.61928312268827	3.06975709629842	4.88495287008211	3.48599591307190	5.32789047870174	1.78250820794364	2.22235362811039	4.70451189384425	5.24378335227523	5.68418674711128	5.99914530245614
1.03982796751155	5.83337036756514	2.54219128670885	2.20170676483251	5.11641148633729	1.85449619555133	3.14854324290310	5.70558224419966	2.77890450053078	5.52150681750938	4.56224962269454	2.29677558776479	1.61628335998377	1.72050038209933	1.55285131845273	2.32073409699783	4.36902328141918	1.25175292530539	3.37082521518841	0.788782016525991	4.20533178034053	3.69225298497555	0.120376536093009	6.06647219966263	1.44115916629883	5.25739305884660	1.82339332784171	3.68873360732302	0.316754200890339	1.94530404983946	2.04751421623109	0.644695392707421	4.77441777941704	1.31523920761581	2.79099908400874	5.72951679739745	4.35471263190381	1.88390559349454	1.51602572684128	2.74343125740042	2.43971577989959	1.40653236519902	5.30192816197438	6.24468942859358	4.64318708070882	1.54845445678567	4.75648276782463	1.39699563316179	3.48070424531099	1.20797754357361	1.29121416963468	3.20645891554999	1.92603814460305	1.76470725683704	2.75586599750835	0.307248235010847	3.52353724706490	2.20587323606368	1.95956644445245	0.985706894925424
0.938751771439813	1.11777743486927	3.28487699609694	1.23998692078090	3.30505212574341	3.59852742812749	2.61021159840434	2.00450777059838	5.79865807922548	3.70658471029506	1.62941581721365	5.64795569386908	1.56384229163401	1.13399034007135	1.85849028210231	3.51758839001827	5.12003751235854	3.88196425186859	1.19379435184670	2.20536531586712	1.78896022289016	1.79629664807614	3.87148364656585	0.730050026327189	4.31192987950507	1.61512947755178	3.03582312678482	4.20575396916662	1.97349223959673	4.38631463939164	6.06217545020399	0.377174365695306	6.04545164171979	1.99861382143497	5.27130536316956	6.20859615231700	4.79214819552119	4.62542268908017	4.19555211094835	1.46073319271000	3.60903590148143	5.51179423712410	5.70014880893727	2.36487885481924	3.66711258298691	6.05055527362509	5.40614631679029	5.26259430914701	2.68655512743556	2.72007927961799	2.90874035955972	3.05681716805296	1.51113822802039	6.05579140556854	0.853894664605360	5.41950652896657	5.43670925491982	2.54143874205700	0.375398814488361	1.23063954817994
0.792942197169114	0.794654990294526	2.35211054473789	2.75933984882893	0.439146925116524	1.37526824072944	0.409823066898200	5.88479848572966	2.06062961989628	6.17007285199171	1.14211542447315	3.81203568624651	1.52437205150929	5.85743569051551	3.36215724119817	0.0191156807200907	4.84089773456672	5.11332016803339	3.75528336879532	4.32104436643757	1.06387681133493	0.693169763954324	5.75545987169365	4.80303693969320	3.43649058067673	0.585754232480833	4.81263442001459	4.41159013113654	4.64098438459321	4.15601203970362	2.01288348106614	3.27744579363149	5.40707962900649	0.549005435986604	0.474972206964034	0.467546462075930	5.77919664060909	1.17370671149770	0.954722161919716	5.48428394876400	3.97133185003307	4.51523842435682	4.30119211606349	2.00603699287193	2.91485897427352	1.97088750900053	0.406167520080641	4.90709529979854	2.94068136514656	5.72035798777800	6.01631626713515	6.16917611724783	0.177058992028832	4.40167569109651	5.30968867341870	2.95879321546714	1.60882423676788	4.67646426668295	4.70884102414199	0.962445237819738
3.02755027531820	0.726413151529360	5.05041554457162	5.28018949908201	3.78665872165036	3.11044849408976	3.16675349080131	0.185499892145655	6.20234162568232	4.82876608685403	2.05765105627773	5.66196354662847	0.134701795381200	3.47042306332379	5.60301217494367	0.541889062178663	2.92954085326881	5.42189725785637	3.62456735603586	2.36560045925593	1.59226143310288	2.73451332196851	0.536649270219841	2.57022320423561	0.287580343212081	5.72223659736410	5.16234816826470	2.36562843894465	0.118247553560189	0.974385706381024	3.10964159765843	4.64312530735764	6.06817145012879	0.533948642551083	4.78171267201738	0.111473185856815	4.28833035826751	0.485593070642520	1.39696182626844	1.48296553752464	3.86661103763798	3.28566028004450	3.38291711315461	2.83680080328504	6.12212544720962	3.04636680582975	1.65172629760255	5.24789428341775	0.771945554972987	3.84148538174437	4.09226386180083	5.27556597583764	1.61796400111561	5.06580468751752	4.04766590636251	5.47197540665362	0.0627704208343894	4.35062233130383	5.07652514470893	2.78611542654867 ];

eta = [  ];



%% 生成无线信道
% LoS链路信道
for k = 1:K
    for b = 1:B
        h{k,b} = sparse(M,1);%%%%%%%%%%%%%%%%%%%%%注意
            e0{k} = [ sin(phi(k)) * cos(theta(k)) ; sin(phi(k)) * sin(theta(k)) ; cos(phi(k)) ];
            % e = Rot_Matrix{b}.' * e0;
            if dot( normal_vector{b} , e0{k} ) > 0
                Lambda_LoS(k,b) = 1;
            else
                Lambda_LoS(k,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(K_rice/(K_rice+1)) * sqrt(M) * sqrt(Omega(k,b)) * Lambda_LoS(k,b) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e0{k} ) );
    end
end

%% 测试
for b = 1:B
    Px{b}    = dx * Rot_Matrix{b} * [1;0;0];
    Py{b}    = dy * Rot_Matrix{b} * [0;1;0];
    T{b}     = exp( 1j * 2*pi/lambda * ( kron( delta_x * ( Px{b}.' * e0{1} ) , ones(1,My) ) + kron( ones(Mx,1) , delta_y.' * ( Py{b}.' * e0{1} ) ) ) );

end








for k = 1:K
    for b = 1:B
        % h{k,b} = 0;%%%%%%%%%%%%%%%%%%%%%注意
        for iota = 1:IOTA
            % eta(k,iota,b) = 1/sqrt(IOTA) * Omega(k,b) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
            e1{k,b} = [ sin(phi_scatterer(k)) * cos(theta_scatterer(k)) ; sin(phi_scatterer(k)) * sin(theta_scatterer(k)) ; cos(phi_scatterer(k)) ];
            % e = Rot_Matrix{b}.' * e;
            if dot( normal_vector{b} , e1{k,b} ) > 0
                Lambda(k,iota,b) = 1;
            else
                Lambda(k,iota,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(1/(K_rice+1)) * sqrt(M) * sqrt(Omega(k,b)) * Lambda(k,iota,b) * eta(k,iota) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e1{k,b} ) );
        end
    end
end
% for k = 1:K
%     H{k} = [];
%     for b = 1:B
%         H{k} = [H{k} ; h{k,b} ];
%     end
% end








end