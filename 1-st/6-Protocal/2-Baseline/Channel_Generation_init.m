function [ h , e0 , theta, phi , theta_scatterer , phi_scatterer , IOTA , eta , Omega ] = Channel_Generation_init( K,B,M,Mx,My,normal_vector,K_rice,Coor_Ele,lambda , Rot_Matrix )

    dx = lambda/4;   %x轴方向天线间隔
    dy = lambda/4;  %y轴方向天线间隔
    delta_x = ( 2 * [0:(Mx-1)].' - Mx + 1 )/2; delta_y = ( 2 * [0:( My-1)].' - My + 1 )/2;
%% 针对初始6DMA位置，生成无线信道
PL    = 32.4 + 17.3 * log10( 8.5 ) + 20 * log10( 30 ) - 26 ; % Path-loss,包含20dB天线增益
Omega = 10^( -PL/10 ) * ones(K,B);  % path-loss
IOTA  = 60;         % 散射体数量
theta =  rand(K,1) * 2 * pi; phi = rand(K,1) * 2 * pi; % K个用户的水平角和俯仰角
% theta = 5.263863993147139 ; phi =  1.057064847365129;
theta_scatterer = rand(K,IOTA) * 2 * pi; phi_scatterer = rand(K,IOTA) * 2 * pi; % K个用户的水平角和俯仰角
% NLoS链路信道
for k = 1:K
    for iota = 1:IOTA
        eta(k,iota) = 1/sqrt(IOTA) * Omega(1) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
    end
end

theta = [5.84549301637174
0.828654268110077
5.77593574956867
1.88783501410535
0.185686876062554
0.521711490507633];
phi = [4.00104648786550
0.943443244933384
2.40375532965242
0.702520034316327
2.76751835890459
5.42553648052349];
theta_scatterer = [1.99698021257993	3.24722902832533	1.44574888827673	3.10864867866399	4.07768236839985	4.27549193465593	1.01421845932568	5.82738056167125	1.30855278891923	2.92133106963123	6.27067816324118	5.92262812769170	2.23308567750652	2.72891521266915	1.53611399734863	1.13188896290439	3.19876299240197	5.49109915412276	3.74353433318526	5.58765782120665	4.12482827892311	6.12345121714782	2.78570276324092	1.53152202652785	0.552391177243535	3.33907190618804	1.74395739425718	5.89440542443921	5.57362052438210	5.96575488789699	1.33992818910285	2.03240487005596	6.19543529151857	4.24817887265579	2.74567840942826	5.63568299235984	4.86718317214686	0.999833295408549	1.29805167608274	1.00304513774878	4.51257851717704	1.61801853052821	5.81067700886727	1.96861425194102	6.09665206808576	4.99094597471251	1.79680025854319	3.21362176740149	2.09104561087837	5.31117708592144	2.77122628591668	2.13874122722204	4.20697690808409	1.35783733226734	5.94639845953797	5.89277726450198	3.78595176724865	5.24162411888820	5.94040893567548	3.11986591114010
4.36776487126571	1.29212810310106	0.155200794141794	4.39876068030725	2.54438846902894	5.82427283554653	0.961031719270778	5.45504239861547	4.53152059749518	5.80090270168777	4.55976120199902	4.29603537450822	0.891091621457078	4.12911360593076	4.54932001713811	1.52164452139164	0.514338275172083	4.23295083633413	0.724500837315357	1.30895849037100	2.43127074132794	5.30435502166278	0.232596254809883	4.97011224617837	3.40744130700639	4.90234921963006	1.98523044404091	2.16089024748158	1.89036510902887	1.62530959003223	4.31297009770529	1.26938379463204	4.75361678753910	5.99204433736327	0.876470976836332	5.21312512619457	2.91424448112867	2.06196814912939	5.43863974819439	4.11288172335903	3.16615884115577	0.483759578955784	2.06636642811666	5.98639819144824	0.458140824856212	1.36095403241342	4.27821211939035	4.43926966193757	0.906213521746091	4.09123767083827	3.42592057363053	5.03477935519335	2.00974624837010	0.440791720377900	5.73696270837797	0.623617211840322	2.87315885646551	3.24123758104710	5.02329095914793	6.16526554212178
5.65299142614927	1.15722376038998	5.03488894525300	1.68518606800410	3.20211435247124	5.89021627190075	0.281244619051963	0.554368655099307	0.351055964200374	5.02304332489268	4.03291658379739	4.82903904309770	5.63882596400641	2.85069345311996	1.41328532508015	3.61632982408435	1.53203906871540	4.95175930599706	3.13369852971784	2.83953263252561	3.27098364116088	6.12049328097030	5.23502918063345	0.972133415252720	4.40308002301343	2.45414172448769	2.85818967197476	0.458206120451104	5.82618085204072	3.82308234053284	2.00995888222868	2.06897857952316	2.29893888387906	5.89084362320859	1.95375826402385	0.917201198916664	2.10648527357911	5.39358521825457	0.917886713237962	0.520144694802251	0.726095653536438	3.72282241557368	6.06262231677876	1.89848796439825	5.22956551561298	0.437080752375479	1.40811690492565	4.06863452410048	4.53158251836557	1.68079464712899	0.755365985001749	0.207968680937439	2.48491184153486	1.16281112792598	5.07019510517522	2.75473049595360	0.944918721732034	1.66392312555551	5.11127922181568	0.832610565108841
4.55648063627629	2.18221519620682	2.67411808870952	3.01280415856672	2.27668464565703	1.66496145719153	3.66014086826027	2.56689187026664	1.04695413146052	2.14496557015230	3.70282289710639	0.613031984523507	3.33417175145712	3.70093533435911	4.39450244047832	3.25944429220820	3.15586799409417	0.700336705425902	4.65825659821558	4.17681078220651	4.64038749321502	4.54087041345716	2.31010234616443	6.22753544741080	2.03445870522166	5.79730124802920	6.13058911904721	0.516627662236526	2.88644808931323	2.50123405569631	4.67134039453293	3.16761570676540	4.63918316621297	0.573688833129241	0.503976178917260	3.71545051815482	1.70053863747861	2.00635327416688	4.53372919779371	2.36872543231389	2.51418734220348	2.03127007736341	4.35442138415922	0.122747881725078	3.07956726595924	0.997062731891197	3.95508432538499	4.75646160569292	4.55004003628988	3.63428551090135	0.885462453136689	4.54348970156213	2.28992930740468	1.36523862556190	5.87776448282851	2.27107388498242	4.75685945969202	1.38979033614069	4.55828065284524	2.18537286513889
3.58205964134372	3.52697166104610	4.87103937142630	4.00491181977838	4.99825504586577	1.05691433943552	3.34111282767004	0.343436502982884	2.59010856275935	1.09065533108268	5.50419729885972	2.79675412209467	6.02018145466919	2.55596016593453	3.46581745527458	4.97798195354942	2.09117597536478	5.24422992591444	2.26725353631442	4.95953021527247	4.95926626433022	2.36684509306721	1.51427676528580	5.61421114388198	2.65006964252595	3.72343323618997	2.03207691483119	2.80685461071141	5.01944824919640	4.68156296948019	5.47208695907967	3.22615740586714	3.05808679976892	1.54234821703884	5.71676386303986	0.849239445147634	5.51940681368393	0.115775528028257	4.89726549464250	4.00523121002579	4.14525239778771	1.73662374652029	4.96092240300414	1.30712229824431	4.25421987974545	5.71523285401042	3.29296842099603	1.74992899220800	1.94789127345886	3.91468370754359	5.04695786408655	1.56739295501161	0.568657309837778	5.03127063807808	0.276693547538712	4.12537889055825	5.82321474368269	4.13977242350540	5.50503475615829	3.09770393181691
3.10659899226475	1.89109772199783	5.52039887173915	0.297668519652901	0.461312546679140	2.09226976259692	3.07770962051562	3.67254230631974	4.48311033110630	5.17358631866618	2.88115600710155	0.615209673248913	5.23561117538347	4.89293248765069	0.721525674138887	4.09881200050955	1.71064387993323	5.80529066636136	2.82819298832641	1.04273286784016	5.01413389070974	4.75583012453077	3.28073153105584	3.28987470527633	0.156624507796872	4.14188049960400	1.41375287230694	4.61845991035244	2.14016148564433	5.98385088033382	3.17197396824990	1.74968062610563	1.45861827767955	4.22721443017604	4.29129634291178	0.0377517644782271	1.35982250359432	3.20031697313832	0.428481431147481	4.24589678355464	1.94966570757326	4.41579044738277	3.55596657851710	0.446034660265445	0.195273132662528	2.84559045010565	3.84238369236398	2.29648481799762	2.58201485692948	0.829661040597624	2.81089613245879	4.05208723515113	2.82960805268706	5.21507406263025	1.46945249820739	1.27442438348475	2.72855035203840	2.06532876187623	3.13609033514571	2.21850646632761];
phi_scatterer = [3.56711831548752	2.81334616570350	2.20620990841280	0.842055418167149	3.13572984866537	0.317406762458723	3.42109792627611	1.00119324752273	0.360884830091173	1.22695431328141	5.13045377820291	4.92377792849325	1.98608288108027	4.11167739718202	5.49257732320873	4.12796621847083	1.20336275113443	1.63893025451255	5.30040482820337	5.75459403969302	5.33040602278026	3.42559489432286	4.47241647618364	3.50912741931044	5.84420623202553	0.207104709819359	1.99829256875530	3.50207972708252	4.95711008411020	5.94960163118533	4.18044960798403	5.22694087303056	3.96558267648107	1.25154527535888	3.96904352554316	5.23772740244449	3.07052746009079	2.24459501436575	5.57419952159285	3.58244903366726	4.89847683573823	2.18658182336556	0.522506512203901	4.29824462658133	2.26333284069371	2.87185717679317	6.03661746312476	4.05807798389293	5.50438304257460	5.36624694560195	2.59703664819845	0.372002850554109	5.44830290795306	5.38341586932459	3.20218376886797	3.01398247675272	6.15010071462191	3.03393460372342	3.09909471029694	1.68146963366629
0.359134730364776	0.214716358656168	2.46348518812560	5.85812113892339	1.85074571794716	0.377306280676832	5.59272945323865	1.07161347527917	5.14343782089243	4.59544190496448	3.38831402491109	0.415573078068798	4.59384749866395	1.18051292849139	5.25522959122541	6.03419109140412	0.627835824151221	4.12869069822242	5.78753140874403	3.40888163334168	2.00128377422409	4.86570483607541	5.86480894514582	1.50703358190030	6.23376075117629	2.73107599718283	3.20892969397232	5.56450925373597	4.93815128893905	1.96629563043440	1.80476574986991	1.81608621793687	3.28440565446267	3.24686370933973	5.22377371922618	5.17071547405351	5.86101672900885	4.93737848362855	6.09352535544775	2.75060599218621	1.52263842226944	4.44512943142995	1.77479009602690	1.33052881161439	0.628885596011416	2.36695961586382	2.78620850906124	0.776665825551623	3.01677762006882	3.49144812502410	2.94125471554199	5.18640094667909	3.31100562913635	2.61342940118277	3.99170775017706	0.322632930400697	3.04542170733668	3.89040827605263	4.29066344333416	2.26940871736341
0.490587574057399	0.214009137243705	3.94765594162842	1.67410331414814	0.336703923803688	1.88367684425204	5.22661938296595	3.44195835686746	1.70018135158405	3.86407717019378	0.669000937941329	5.69191715859054	0.910693574669569	1.76407656965042	3.77833707284262	0.711486731905464	5.95698754224186	0.644778214543847	4.33709439822022	0.105671843815608	2.88895151767102	0.256403523855475	1.56355155031979	4.22610326361261	0.474916268805484	4.89914205767937	1.47028399266692	3.52511959359813	1.54161727820619	5.87351747469061	4.59968233325074	3.59631968248851	0.141526443768021	4.20008366813441	5.80663513604464	3.15010590284675	5.51141128853685	3.62815829342114	0.0628958102999462	5.10409928821294	2.45151151897612	1.74172401685421	5.83321377349610	0.0326088251291208	5.71270491962451	4.06632496138178	2.15581532383955	5.74962162473527	2.28369320002787	0.917062912671868	4.08071240970260	0.563537412012531	2.08165565234909	0.583363972999432	2.14528090136121	0.0642872202516076	0.376682428673449	6.12662880878898	4.63100159520801	0.209555029175179
0.790800863748790	0.703888985085086	1.66397244873840	1.16738906998362	3.36319284226030	2.52123563163651	5.17062871103699	3.33617712307755	2.98490160562773	2.05938983002536	2.38963035882786	1.52811849383851	4.47385247251064	3.10138439888056	0.388523344643252	2.02294104677745	5.47178431515629	2.54568936380802	0.936335443105676	1.54226920652165	4.27902135824203	0.456114630424757	2.07582931195657	4.37846294433859	0.319503398131909	0.192825580212552	5.58572463933300	0.504622066603926	2.84841924506873	4.86017729354926	3.48657830516272	5.34684916069279	1.73459137938163	1.55821573551188	2.01438635302210	4.59339025712301	3.63456686389702	3.29924639347707	5.03661636113046	5.46086980295922	2.68566582485273	5.82177133909304	2.54367840496674	3.99735845841064	3.28310210656462	1.77511220408969	3.11276610270172	0.201826979647038	1.29131588570222	5.35308639405960	4.96246600631254	3.72759405923870	4.00360264050534	4.94767668615113	2.53312270825362	5.73281074983896	3.61993547031921	3.83303353665154	4.27320629028162	2.16769583449533
5.50779891016038	3.23645800495401	4.77924322779022	1.47003474213999	4.97199823396629	4.12582942258767	3.46053380969258	5.74481227903404	1.61494522072423	2.60616515996728	1.41476341155777	3.25188938577037	4.25781983617027	4.59249177331387	2.37305091446432	4.87481055136170	0.728724536845011	1.03483880452171	2.91181222487113	5.90051583930183	5.93972901469790	0.628013609636290	5.28368444923154	2.32244411239330	0.668452913982755	4.91765732170488	0.780647538834500	1.22278522855354	0.153361766537932	5.11944114302300	5.12128081405592	6.15352587559790	4.95842544621464	2.30001113668948	3.08419806063030	4.23069421858848	1.47703394846939	2.43657946466905	4.38969936771977	3.32818429659499	1.26892834550397	0.634217418632168	4.93559645041596	4.51463659238304	1.83122185135847	0.860758616063981	3.57130368284148	2.82479921498360	1.51057719968582	4.33059945591578	5.32805089665063	2.38897008639965	0.335023544838760	1.13068908956160	0.483397202362924	4.13164907502327	4.12492448126552	3.04886597818727	3.17791158585464	6.17128700482479
0.0380119255752175	1.34257045541952	2.01710735766289	3.40320319448455	2.29694024641446	3.61097168548063	3.62538628565982	3.96284810498607	1.06279333701497	1.00162828618635	0.937840019539229	5.72518718915011	3.09579619983276	0.532535356599074	4.38828741944911	2.72976681264073	6.12344064563157	3.42306346316673	4.83594915336678	4.28540357586083	0.818077733538359	3.05316954088306	2.15762050352251	4.52629826370862	3.85643339401236	1.50087120516913	4.62460434581899	4.00003658712397	3.25399556557196	2.30284339445672	0.386448740181228	0.379272761997157	0.359345209173573	2.69075291906254	6.15229627226965	1.83319401239957	5.29520502692839	3.65076264320702	5.78207780311594	3.28528689731302	5.37183391235456	3.70643876189261	2.85754049717200	2.62971970033156	5.40078992672047	2.07073705296633	0.0982584744549848	4.03594749421025	1.83263028411128	3.59865176551807	0.879505179354679	5.71427415753032	2.87637676448862	4.36827705755153	0.913051146439689	3.81044109522447	0.599430350539994	4.62628736069084	2.27390865072904	3.31003275262200];
eta = [-4.94677163323812e-07 + 2.80687477142597e-09i	-3.61889947987742e-07 + 5.63848310682740e-07i	6.94442709387847e-08 + 5.33659555784225e-08i	7.21383992025774e-07 - 1.85881412872528e-07i	4.10636259874050e-07 - 8.51588956975137e-07i	-2.75223268363005e-08 + 1.91185016283595e-07i	5.13106160867668e-07 - 2.78404698117219e-08i	6.53774947331044e-07 - 1.60035612450145e-07i	-1.68849496754560e-07 - 3.77954865776322e-07i	-1.22118718373606e-06 + 2.55978433646827e-07i	-9.15050187212643e-07 - 6.23989797458832e-08i	-1.05972169477535e-06 + 9.91347214806131e-07i	-2.93973439338610e-07 - 3.50992395035722e-08i	6.99782978264306e-07 + 3.10171479363561e-09i	5.31381970255198e-07 + 4.27455486013297e-07i	-7.70513638711424e-07 - 3.43759672027928e-07i	4.69096833350480e-07 + 5.83428937547164e-07i	-4.65291452293044e-07 - 5.76624088783394e-07i	2.02391874584801e-07 - 3.88458615459199e-07i	-6.57202480484355e-07 + 6.33344047893563e-07i	-1.67438466380421e-07 + 3.69438827037813e-07i	4.86170884764573e-07 - 1.55306802573443e-07i	-2.76138286602025e-07 + 1.02332217637223e-07i	-4.59421411390769e-07 - 9.28855451824938e-07i	-5.42881435867254e-07 + 3.46041284966396e-07i	1.54929792398903e-07 - 2.62532179497996e-07i	5.79397285299244e-07 + 7.96061536397531e-08i	-9.38443401776225e-07 - 3.63406118075621e-07i	8.37294567699142e-07 - 1.73784914146147e-07i	-9.48486779127554e-07 - 5.83173539328638e-07i	2.58163019754575e-07 + 6.61237432463908e-07i	4.97772448633291e-07 - 9.88868344250307e-08i	-8.82048556491729e-07 + 9.37042561577127e-07i	6.29656683827006e-07 + 4.54492400450277e-08i	-3.64180747611607e-07 + 1.11275890106898e-06i	-5.59016543437274e-07 + 1.49278552070776e-07i	-7.02719739853892e-08 - 5.76324730363861e-07i	-5.04566662584670e-07 - 5.17527295522580e-08i	-1.05068387447524e-06 - 1.07512913728903e-06i	-3.44328459386291e-07 + 6.51639955311956e-08i	4.28909219810661e-07 + 5.62733502989148e-07i	-4.91979921312359e-07 + 4.03246828985355e-07i	-8.76094652597036e-08 + 2.25038415119169e-07i	2.12646544151315e-07 + 3.79797399014291e-07i	-5.57752434014326e-07 - 5.97920846312472e-07i	9.79213328716776e-08 + 6.16474408638488e-07i	-2.97698131147157e-07 + 5.92286351574249e-07i	1.06194264683388e-07 - 3.60997645759126e-08i	2.89588814043550e-07 + 7.89242491864072e-08i	-1.61113924624709e-07 - 5.72430561982618e-07i	-4.63408490301079e-07 + 1.14299040459874e-06i	3.85748013636552e-07 + 4.20862935736147e-07i	-1.07569705273948e-07 + 1.97692220403091e-07i	1.06889332060801e-07 - 7.31930152784532e-07i	9.04288066421674e-08 - 1.14464958308357e-06i	-4.73710295548162e-09 + 1.04628575998740e-06i	-6.17163815811930e-07 + 8.59715442124490e-08i	4.45365539246237e-07 + 1.09916748283635e-06i	-4.64987459281788e-07 - 1.07825604477632e-06i	1.02485320206528e-06 - 3.49683303560185e-07i
-7.80652232768215e-07 + 5.96728286024173e-07i	-8.12875340824281e-08 + 1.74326100961850e-08i	-4.23260358051759e-07 + 5.95128123769355e-07i	-1.05091769229659e-07 + 4.58595316107562e-07i	2.75483115514575e-07 + 3.96450036790082e-07i	9.28618990550680e-07 - 4.99156614666483e-07i	-8.67653587822299e-07 + 1.51887790178001e-06i	4.62571776071223e-07 + 1.36299772303084e-07i	-2.37857503455721e-08 - 4.18150430791587e-07i	-7.32980536999753e-08 + 4.31569043903383e-07i	1.05594016366270e-06 - 5.33301850296063e-07i	2.36551741646561e-07 + 5.44543939489992e-07i	-2.47479703103029e-07 - 5.22772190122306e-07i	4.28061507579626e-07 + 9.31144580255274e-07i	-6.94785630808918e-07 - 1.98532114186814e-07i	7.12247865524922e-07 + 6.88161569625359e-07i	-5.69199484989291e-07 + 1.18803996113778e-07i	-6.78657733140645e-07 - 8.39098373763307e-07i	-1.83113702733258e-09 - 8.77054011049032e-07i	-3.84315165130730e-07 + 1.34536273287948e-06i	-8.37308859621698e-07 - 5.02383365841183e-07i	2.65878970188750e-07 + 1.73712116377824e-07i	4.87895834365386e-07 + 6.46784698596180e-07i	3.26882036309333e-07 - 4.04329425098381e-07i	-7.33968318327101e-07 - 3.72545454163855e-07i	3.88697971571215e-07 + 7.99525003004293e-07i	2.13215594519564e-07 + 1.75686941837291e-06i	-7.92692129864450e-07 + 3.60304143843142e-07i	2.62932039815881e-07 + 3.86738566356755e-07i	-6.69911519256915e-07 - 7.86307063624716e-07i	2.27236430984475e-07 + 3.50455760287686e-07i	-2.89513289433615e-07 - 1.64819248306780e-08i	-2.77311593243681e-07 - 1.52263333263190e-07i	-8.67891383322865e-07 - 5.37315186731553e-08i	-2.35247027739079e-07 - 8.93429113958507e-07i	3.78152412350331e-07 + 5.71518447942819e-07i	-2.35186100195950e-07 - 5.91840001926652e-07i	9.14611270724871e-07 - 8.13468282087627e-07i	-7.06099134819394e-07 - 6.18486406774629e-07i	-1.58292819431905e-06 - 2.24715894221613e-07i	-4.10674645605870e-08 - 1.41465596961919e-07i	1.65482399865666e-07 - 4.98360094761750e-07i	5.03158020719410e-07 - 1.55657982512641e-07i	-1.01987911419419e-06 - 6.42823898782988e-07i	1.05223545135506e-06 - 3.76465722612188e-07i	3.91587108164147e-07 + 8.15493560333468e-08i	-1.29664850108441e-07 + 4.93023272946009e-07i	-1.34936944826836e-06 - 1.84955589120406e-07i	-1.37904138678856e-06 - 4.42397641290053e-07i	4.67576733989393e-07 - 1.03100377442813e-06i	5.42007236942193e-07 + 3.14717327964223e-07i	-1.96715939833994e-07 - 2.52422639489780e-08i	-5.73438770371846e-07 - 3.50645331466644e-08i	3.13725083828086e-07 + 1.81681617328036e-07i	8.05471400485402e-07 - 6.07698519717696e-08i	4.43950728390221e-07 + 3.58416501018102e-07i	3.17531611273268e-07 + 1.86176782937611e-07i	9.54062684289041e-07 + 3.75883334091673e-07i	-2.00680208204905e-07 - 4.45271306973494e-07i	-3.47224811960267e-07 + 4.08778511803012e-07i
-5.73325180577701e-07 - 2.98619194658518e-07i	-7.39650959878940e-07 - 2.41785485952089e-07i	-5.11277733519551e-07 - 2.46161021136849e-07i	1.30798494902780e-07 - 2.65982662299716e-07i	2.33391995043416e-07 + 5.98810316356411e-08i	-1.98849154545874e-07 + 4.41185339045648e-07i	5.02735345261456e-07 - 4.26659577277308e-07i	-5.09245180271196e-07 + 7.49893366548937e-07i	3.57908003900176e-07 - 1.18623801567631e-08i	3.18660217114915e-07 + 2.80574850538330e-07i	3.94999937246966e-07 - 8.64424156138031e-07i	7.43362780705340e-08 + 3.36050809874773e-07i	-3.58846837604162e-07 + 1.49898247176713e-06i	-1.33147298874147e-06 + 2.37983718091282e-07i	2.75824383739112e-08 + 5.02895865418912e-07i	6.62995061219070e-07 - 2.29896055680610e-07i	-3.52110879025264e-07 + 1.48818145966794e-06i	-3.38108188599960e-07 + 1.47605056683857e-07i	4.41729221579540e-07 + 2.75291959556660e-07i	9.18270465497027e-07 - 1.30065036161410e-06i	-5.93245526177077e-07 + 4.55185517439715e-07i	-4.60233847870243e-07 + 1.71039755123671e-07i	-6.16344786273661e-07 + 6.43912054071521e-08i	3.89228368055022e-07 + 1.71308940028778e-07i	3.21288383759077e-09 - 7.16787586312422e-07i	-9.33529560675959e-07 + 5.44013496773764e-07i	9.74714316164398e-07 + 2.26835290676718e-07i	-1.88707825891294e-07 + 3.23510018558193e-07i	-1.08263930688060e-06 - 2.65940851298065e-07i	-3.38223405765873e-07 - 5.31728844982135e-07i	-6.64303675918801e-07 - 6.20521539298699e-07i	2.00404404671283e-07 - 2.16645706304078e-07i	1.59200893411462e-07 + 4.36535267009680e-07i	-4.03769485940878e-07 - 6.89669514164159e-07i	-1.09321607083677e-06 + 2.12846717321033e-07i	1.35028666519041e-07 - 1.37515707126000e-06i	1.14735464862930e-06 - 1.08988348196150e-06i	2.22466081701216e-08 - 6.26350771346358e-07i	-2.77857403231394e-07 + 3.35215570151982e-07i	3.13606786061105e-08 - 1.26607398808046e-07i	-5.89420294059024e-07 + 1.25441095696810e-07i	-2.70030718651324e-07 + 8.84095205034840e-08i	-3.93884088903963e-07 + 5.22797159670858e-07i	-5.37405333663174e-07 + 1.60680308932526e-07i	-3.07922529978819e-07 - 5.56411205314770e-07i	8.94021121011408e-07 - 5.65472745526747e-07i	3.69405210910318e-07 + 2.54871150523543e-07i	1.10854155467640e-07 + 2.52138968760276e-07i	-4.41791794910851e-07 - 7.86131023613669e-07i	-4.62678313594030e-07 - 7.57505281123171e-07i	-9.50321009161326e-09 - 1.10452551517510e-07i	1.10209501219087e-06 + 2.17168877477698e-07i	-9.54301537798109e-07 - 1.93180870758383e-07i	-3.12463926586823e-07 - 5.39097491262242e-07i	1.12598346052396e-07 - 5.98818802287273e-07i	8.08208498163589e-07 + 2.12818857198407e-07i	-2.24427627207404e-07 + 9.26682856061747e-07i	-4.55836156551992e-07 + 4.54948722965350e-07i	-5.14792067243958e-08 + 1.76064453577867e-07i	8.63319036724972e-07 + 1.05046663159713e-07i
-2.05182211433786e-07 - 3.11255955380836e-07i	8.91928127443103e-07 + 5.82332452415812e-07i	1.11079209423317e-06 + 7.12690139269370e-07i	1.54355428000673e-07 - 1.96142231168296e-07i	-2.23374849300124e-07 + 4.11206447485162e-07i	5.83459804901037e-07 - 7.95604406226963e-07i	-3.77386372674624e-07 + 8.60953405691425e-07i	8.68953370557195e-09 - 5.44946058036126e-07i	9.49140493049901e-08 + 8.02087849030512e-07i	1.19740616930829e-08 - 3.47774875482781e-07i	-4.51876128559492e-07 + 1.84581992498083e-09i	1.78484518175766e-07 - 6.57156925292956e-07i	5.34368855953068e-08 - 8.66863343497322e-07i	3.10289114715817e-07 - 2.14152856189040e-07i	1.28645606457942e-07 + 3.36475123207714e-07i	2.76361689701003e-07 + 7.60358536138291e-07i	5.87670985591419e-07 + 1.16264438764518e-08i	8.81491913469685e-08 + 9.78948298903837e-07i	-3.00377178799969e-07 + 6.26043946255246e-07i	2.86701821473277e-07 - 1.76279092012752e-07i	-1.01015353676114e-06 - 3.68445102087556e-07i	1.76553925782450e-07 - 1.86676486267008e-07i	2.98176469920728e-07 - 1.03398879552322e-06i	8.30531431853038e-07 + 5.16562969214056e-07i	3.79859755636210e-08 + 5.88763444391413e-07i	-7.29775942657897e-07 + 2.06041971942213e-07i	-2.89713054597666e-07 + 3.68426215215189e-08i	-4.06784958241046e-07 - 5.63639794995714e-07i	8.18608790084871e-07 - 2.02567845549913e-07i	1.88308108695298e-07 + 7.35521946912839e-07i	3.03578347516476e-07 - 1.04704543838157e-07i	2.13811187719188e-07 - 3.84525113359379e-07i	-6.95316203868804e-07 - 2.90025190197693e-07i	-6.59178782410364e-08 + 2.47005259495368e-07i	8.56181897286406e-08 + 7.74185657850389e-07i	1.76253638288351e-07 + 1.02918854343076e-06i	-7.01921454587947e-07 - 2.36630971277421e-07i	-6.01259505194016e-07 - 2.21558073853410e-07i	-2.82177548294562e-07 - 5.27753515460132e-07i	-3.75250549846398e-07 - 1.28834769130102e-07i	5.07278331354036e-07 - 3.20638958165913e-07i	-3.74988046733362e-07 + 1.18415599858475e-07i	3.48326969668705e-07 + 1.29213350857993e-06i	3.76147291462294e-07 - 2.80866114974811e-07i	5.15177428042011e-07 - 1.68501191949838e-07i	8.89512125210670e-08 + 2.01466640400698e-07i	-7.04778011794955e-07 - 8.96333582575925e-07i	7.72008404888299e-07 + 3.65998313374785e-07i	3.50340876202325e-08 + 2.18020799410821e-07i	4.05680078952310e-07 + 4.59308998846698e-07i	-1.14423228212400e-06 - 8.10007604736370e-07i	3.11731176102488e-07 - 1.69840317211436e-07i	-2.49470538655513e-07 + 2.91626957389640e-07i	1.37326281429402e-06 - 5.65628437556884e-08i	-2.94727054546806e-07 + 9.17233473166180e-07i	6.84756561310267e-07 + 5.82048013538064e-08i	3.14494270244593e-08 + 3.89073592747667e-07i	2.23687684530136e-07 - 8.28020814707768e-08i	-1.66897245743954e-07 + 5.10204938434147e-07i	-4.57624481938747e-07 - 9.19757514490363e-07i
-2.98366847708696e-08 + 1.04643724730806e-06i	-1.36421307405745e-07 + 2.47612112726562e-07i	3.09373066038956e-07 - 4.60076894685512e-07i	4.05532753526410e-07 + 6.23965090059170e-07i	3.21099218670515e-07 - 6.10516824949549e-07i	1.53421957623566e-07 + 5.45229213897126e-07i	9.95849945587401e-08 + 7.50038148153795e-07i	1.37222567303598e-07 + 6.41962476832348e-07i	4.20917098587966e-07 + 8.81090437674726e-07i	-7.75434786143385e-07 + 1.81415593828384e-07i	7.56805300120650e-07 + 1.21879817093325e-06i	8.25130674425060e-07 + 2.71748601261312e-07i	1.23535524340016e-06 - 1.84004050774903e-07i	1.77384275790470e-07 + 3.70955929259454e-07i	-4.27911597968853e-07 - 8.08130790403060e-07i	-4.09321165540398e-08 - 1.37827249400143e-07i	8.76184968812999e-07 + 5.96228667884243e-07i	7.13909136158683e-07 + 3.37624214733343e-07i	-7.27987334175711e-07 - 1.17228566040242e-06i	-3.71496240291302e-07 + 8.95340091206590e-07i	-1.23105083314251e-07 + 9.18657181233124e-07i	-1.08061229840015e-06 + 2.24416413649918e-07i	-1.08512232168583e-07 - 6.00351361750833e-07i	-3.65495605009484e-07 - 1.04793658787141e-06i	5.28127818280401e-07 - 1.93474497361062e-07i	-6.34510614925762e-07 - 7.84161261516546e-07i	8.26099828070335e-07 + 1.38441189530520e-07i	-7.01343217822655e-07 + 3.00195770094613e-07i	-2.56910066154844e-07 + 4.63278750407662e-07i	1.47718203070121e-08 + 3.45393787908314e-07i	-5.42702138320177e-07 - 5.09779137270075e-09i	1.51942928382863e-07 + 6.04953422565429e-07i	-6.41921797907070e-07 - 8.57195533982357e-07i	-7.01675421625007e-07 + 6.69925904028237e-07i	-5.22703477167540e-07 + 2.96332023879282e-07i	6.97053948490111e-07 + 4.72932096769146e-07i	4.40945848337475e-08 - 6.53455528118388e-07i	-2.22077812080473e-07 - 3.99939325653506e-07i	8.15171184225711e-07 + 1.47313500433124e-07i	8.35484049843510e-07 + 3.11589265653937e-07i	1.29067223809099e-06 + 2.32849453806189e-08i	-1.28607682498229e-06 - 7.53577662684544e-08i	-9.67813774101150e-07 + 1.18261984150017e-06i	-1.02018844995699e-07 + 5.19380932635126e-07i	-3.24907664642445e-07 - 2.54709944097486e-07i	5.19218439497363e-07 + 7.74470058615394e-07i	2.57545477300511e-07 - 2.35422613015521e-07i	4.50580240755049e-07 + 2.30906761587062e-07i	2.03783972428069e-08 + 1.47474192702383e-06i	-5.08102071127335e-07 - 4.99999155584353e-07i	6.33975824578931e-07 - 2.35661067746216e-07i	3.27683283063894e-07 - 5.09679529236318e-07i	-7.22161727178129e-07 - 3.67546582293091e-07i	-3.46345150980611e-07 - 2.77932806013778e-07i	-5.91777704373536e-07 - 4.31409442023218e-07i	-1.13155211736873e-06 - 5.81132424517404e-07i	1.13295415094566e-07 - 1.25195046301645e-07i	-1.65122573466204e-07 - 4.12479187374714e-07i	1.71849292169413e-07 - 3.90103948764852e-07i	3.44637623819654e-07 + 3.46803680899042e-07i
3.81628092579823e-07 + 8.91858251853924e-07i	-5.54168868612580e-07 - 6.14334887165491e-07i	-3.86219571654610e-07 + 1.43914885601078e-07i	-9.19576656716265e-07 - 2.34209781291145e-07i	4.09433395196025e-07 - 5.61641587833623e-08i	-3.95101764912787e-07 - 1.20691300851324e-06i	1.02373441634911e-06 + 6.33783267611438e-07i	9.61322889436838e-08 - 1.07400789528517e-07i	6.10529709975218e-07 + 1.30840047944605e-06i	2.03370920675382e-07 - 3.45743890925958e-07i	-1.70501551304664e-07 + 3.28848457309860e-07i	8.00012324135742e-07 + 8.48299599474028e-07i	1.47090064335503e-07 - 5.77366730011927e-07i	-1.12067142376421e-06 - 8.72391728449139e-07i	8.51402395207276e-07 + 8.01054150656437e-07i	4.87928874155637e-07 - 1.96057433271310e-08i	-2.44697029471307e-08 + 3.17370246438604e-07i	-1.16079546390769e-07 + 2.68821775325159e-07i	-1.71862607002608e-07 + 6.23193706619526e-07i	-3.63767519158324e-07 + 9.87763971358834e-08i	-9.13357656337659e-07 + 9.18442571674781e-07i	-2.27585509863690e-07 - 9.69434352676363e-08i	1.44467915225790e-07 - 2.47693690913869e-07i	-2.89642287529002e-08 - 5.65573601565977e-07i	-1.84878498390483e-07 - 4.19117905032295e-07i	6.14960698349525e-07 + 1.03480664771987e-06i	-6.74609875056453e-07 - 6.35730126062322e-07i	3.99986940635367e-07 + 2.43650741205708e-07i	9.23674703617797e-07 - 3.54952514228460e-07i	1.09471273203031e-07 - 4.39909141458306e-08i	-1.29733805791988e-08 + 3.87895673512502e-07i	1.39054071854143e-07 - 1.42392613982186e-06i	1.24131092133137e-06 + 2.54089549324559e-07i	7.45011125165810e-07 - 3.33854816529310e-07i	-3.52029727140568e-07 + 5.79382631607362e-07i	1.07558592829543e-07 - 1.75113773718291e-08i	-5.61441009812029e-07 + 1.85851321337727e-07i	4.41782902478738e-07 + 1.47290899245300e-07i	1.18198769968419e-07 + 3.36968546896632e-07i	-6.41867634744046e-07 + 1.96257639608588e-07i	1.00522957870414e-07 - 2.34532647567642e-07i	-1.47979559581613e-07 - 1.06859710058926e-07i	6.89233077932422e-07 - 7.93437185164421e-07i	-3.10527906542537e-07 + 1.44457250190704e-08i	-2.95818726961017e-07 + 2.13898329023771e-08i	-1.03097743570348e-06 - 1.36859180863720e-06i	2.46637073504849e-07 - 2.04074710517737e-07i	-9.27527362175876e-08 + 3.79816751460104e-07i	-5.94286888274211e-08 + 3.26727986887401e-07i	-2.89711540599372e-07 + 1.12387103678508e-06i	8.81265527157722e-07 + 2.84776360860915e-07i	9.02324744206083e-09 + 1.96793430633640e-07i	-1.55129107848239e-07 - 2.08653183056460e-07i	-7.32665612421635e-07 + 9.25187042948253e-07i	7.51178297985508e-07 + 8.35150423116821e-07i	1.31131889309107e-07 - 6.41488501122066e-08i	-2.79849379705690e-07 - 4.22963986021826e-07i	2.53901400496193e-07 + 8.41091675944738e-07i	-8.70279571681428e-09 + 3.06921146711026e-07i	-8.54264516853132e-07 + 1.85324820908593e-07i];





%% 生成无线信道
% LoS链路信道
for k = 1:K
    for b = 1:B
        h{k,b} = sparse(M,1);%%%%%%%%%%%%%%%%%%%%%注意
            e0{k} = [ sin(phi(k)) * cos(theta(k)) ; sin(phi(k)) * sin(theta(k)) ; cos(phi(k)) ];
            % e = Rot_Matrix{b}.' * e0;
            if dot( normal_vector{b} , e0{k} ) > 0
                Lambda_LoS(k,b) = 1;
            else
                Lambda_LoS(k,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(K_rice/(K_rice+1)) * sqrt(M) * sqrt(Omega(k,b)) * Lambda_LoS(k,b) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e0{k} ) );
    end
end

%% 测试
for b = 1:B
    Px{b}    = dx * Rot_Matrix{b} * [1;0;0];
    Py{b}    = dy * Rot_Matrix{b} * [0;1;0];
    T{b}     = exp( 1j * 2*pi/lambda * ( kron( delta_x * ( Px{b}.' * e0{1} ) , ones(1,My) ) + kron( ones(Mx,1) , delta_y.' * ( Py{b}.' * e0{1} ) ) ) );

end








for k = 1:K
    for b = 1:B
        % h{k,b} = 0;%%%%%%%%%%%%%%%%%%%%%注意
        for iota = 1:IOTA
            % eta(k,iota,b) = 1/sqrt(IOTA) * Omega(k,b) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
            e1{k,b} = [ sin(phi_scatterer(k)) * cos(theta_scatterer(k)) ; sin(phi_scatterer(k)) * sin(theta_scatterer(k)) ; cos(phi_scatterer(k)) ];
            % e = Rot_Matrix{b}.' * e;
            if dot( normal_vector{b} , e1{k,b} ) > 0
                Lambda(k,iota,b) = 1;
            else
                Lambda(k,iota,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(1/(K_rice+1)) * sqrt(M) * sqrt(Omega(k,b)) * Lambda(k,iota,b) * eta(k,iota) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e1{k,b} ) );
        end
    end
end
% for k = 1:K
%     H{k} = [];
%     for b = 1:B
%         H{k} = [H{k} ; h{k,b} ];
%     end
% end








end