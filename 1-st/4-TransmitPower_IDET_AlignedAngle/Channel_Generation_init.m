function [ h , e0 , theta, phi , theta_scatterer , phi_scatterer , IOTA , eta , Omega ] = Channel_Generation_init( K,B,M,Mx,My,normal_vector,K_rice,Coor_Ele,lambda , Rot_Matrix )

    dx = lambda/4;   %x轴方向天线间隔
    dy = lambda/4;  %y轴方向天线间隔
    delta_x = ( 2 * [0:(Mx-1)].' - Mx + 1 )/2; delta_y = ( 2 * [0:( My-1)].' - My + 1 )/2;
%% 针对初始6DMA位置，生成无线信道
PL    = 32.4 + 17.3 * log10( 9.5 ) + 20 * log10( 30 ) - 26 ; % Path-loss,包含20dB天线增益
Omega = 10^( -PL/10 ) * ones(K,B);  % path-loss
IOTA  = 60;         % 散射体数量
theta =  rand(K,1) * 2 * pi; phi = rand(K,1) * 2 * pi; % K个用户的水平角和俯仰角
% theta = 5.263863993147139 ; phi =  1.057064847365129;
theta_scatterer = rand(K,IOTA) * 2 * pi; phi_scatterer = rand(K,IOTA) * 2 * pi; % K个用户的水平角和俯仰角
% NLoS链路信道
for k = 1:K
    for iota = 1:IOTA
        eta(k,iota) = 1/sqrt(IOTA) * Omega(1) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
    end
end

theta = [5.92177111807206
1.09081497161508
6.03232508115865
2.62959534558712
5.76807166253734
1.83142301064590
0.144216581258464];

phi = [4.40595475452568
3.57449469055254
5.54694876814013
2.99897402063148
5.99068292939539
4.87719197650062
4.64274446282434];

theta_scatterer = [5.44756900475905	1.86594737826219	1.97933171255876	1.64837932637930	3.13963151147115	3.77956825572122	5.82271562725996	2.52863341412834	4.11181525176737	2.26331880081934	1.98214066313422	1.36195202549713	2.76529274205077	5.38636411403694	2.14035017906300	0.958098893180284	5.76004643936515	3.86365927652320	4.40457656007322	1.08036381689438	4.48747747992213	2.88045220141294	2.11893013725328	3.79358309625857	2.62105131197676	1.45853008567373	6.21897882984001	2.74772175860911	2.58305933543637	5.44991183499540	5.89400120927374	4.02733092274171	4.19319484750528	2.49965992752034	1.84854240681178	5.67573777093291	5.48518165245869	1.53962945781930	5.02501347560725	3.26214792706035	4.88120776928599	4.77400727432742	2.84928696149630	0.899376153370719	0.959221981834839	5.80876520439317	1.80567634003416	2.57660884951339	0.434139267142312	4.96235808493096	5.44345616900932	5.87302770191343	3.93907024812183	3.68799843358478	4.08736252751540	5.49857422309394	4.17595736989037	0.352898364900731	0.0742356978216337	5.27478703211708
3.46594403422449	3.09291020323522	3.35340348890068	5.48493355611347	3.53531074606691	1.79320352177839	4.12014342419433	3.01655158961078	3.22124284239218	5.38222028896289	3.71870654027969	0.289891284599105	3.71953142612468	4.85919297650307	0.493159232838641	1.31901338893654	3.12207705111995	3.74861764675003	5.43373278715352	3.05589118730815	0.453988156701090	6.07658156917244	4.35519489101386	4.08919550659504	5.41239210468508	5.97572893958395	5.59449802385602	3.22344010485243	1.72613563634349	4.73401164701259	2.28532212735197	1.78190271924908	4.01106012665788	2.69005141789445	4.30012816485311	4.88815832142334	4.51278235920433	0.989363018650049	5.07904107700884	2.67443366628079	1.35572960053685	0.232774705739075	3.11606094285240	2.88487082749264	2.05844326521087	0.0963405908357130	2.08606809211387	1.90759953491306	2.86946455675545	6.16116195851646	1.75860665684541	4.12924733030685	1.57749543411883	1.89185010729111	3.12706900606526	1.88978766050659	0.448453466073410	0.363319091197288	3.00059709322979	4.60369227707475
4.55275186806315	5.92688690565961	5.37781625559582	2.13221931802134	1.42390494010058	1.72258916794314	1.24524803840053	2.97607896777923	1.91526438872007	3.17053684186217	2.55220278445519	4.01976968244174	0.523968473214934	5.88104349599429	5.95620628314813	1.92459942374930	4.90563940389539	0.0439183803686200	5.76751270580074	0.569710537598948	5.27225657368813	1.24403105749101	5.55868681795711	5.50365506365637	1.72956119329484	5.63121740489123	4.27350906421540	3.01627437690723	5.58603895267981	4.41565323253733	0.240212522115778	1.27034125546267	1.56342185566967	3.24949934995662	5.86105488701830	6.09109194226558	3.36272204074510	2.21780435142486	2.91162803362753	1.47746996675695	5.20994300789578	2.40808048859696	0.411541230444408	2.29660635910214	4.31670426535359	3.14193355700689	2.45017020920650	5.76062237284214	5.27014308543826	2.23072750204338	1.35667324888143	3.11407252506572	0.953814485201988	1.26231322591021	0.286229132620801	3.58047788556309	3.35504256563450	2.41082545191835	3.61059235477513	6.12305951500459
1.41937144531087	1.66676283722072	5.58527758337794	2.03916159612742	4.32233375681857	2.38533780448361	5.72264617804721	4.92816384978733	2.44130651580376	1.48319572484907	4.95595659939912	6.06641792227209	2.07898588456442	0.722493504738289	1.84166667194430	4.12675032369587	3.64845386146246	2.08386743484977	5.90616114927619	2.01508565497993	2.84451954202558	3.98358134222393	3.69529724426966	4.67227782666269	1.75019331674574	0.807513570108562	3.58959682495346	2.33764613525730	5.04521099614496	0.916279023004541	2.16161190191261	2.50842865575934	1.93915087725691	4.55244618466231	3.95537287191005	3.17980810575048	3.16378140475047	0.413536545826223	5.93892805724717	3.01601022136905	0.566267552891267	1.97813409878062	4.28374148063122	5.67965488093134	2.19631557306068	4.56555470945031	1.95133835328454	1.35148323009436	2.36786548533917	5.63189592089093	3.53054547755466	0.546681274311035	4.72464692338624	5.15252133928057	2.44752604987438	1.98241429248953	2.52260811469067	5.86442393060372	4.55032842637358	4.49339620368939
5.21334994359237	2.30311497145837	3.55303237986391	4.31011176740798	3.26185531009371	3.39573699324981	5.70122128128294	2.33288908628568	3.51044007799878	3.60527270019946	3.37869909710483	2.50279347959003	5.77865776815093	1.02637182188424	2.69750681293183	2.89817385216049	1.98461234851021	5.84666197586529	3.41286629809072	5.06384113999226	0.763852231650799	1.83554589352531	0.523505191131409	6.11815917602703	0.0748582704081683	5.02034173054167	3.43640591918138	2.90324297436099	5.32076687447784	5.05648439546831	3.58236445222485	2.69673444079569	0.138530340068576	0.293467625388913	4.52436423128052	5.04729817139514	5.14712894925464	4.94835118876896	4.44495351691936	4.52361221205874	1.14680200565996	3.75674260866724	4.03120797402834	1.12080990560611	0.196380081161507	4.04002969021799	0.110391882995690	2.44815101082797	0.763636210076583	0.579724806192502	3.74789855170891	5.56815656548979	3.18833980376704	3.82703583932546	0.0352539517528355	3.35978902127495	5.55397660869252	3.69615562038567	0.404387767793477	4.04567858463638
4.59570718512788	3.19037892822352	4.54841954720153	2.45760015941649	2.92353295602609	5.89547720653601	2.79887098016405	4.29284542065079	5.84716035691012	2.01749087807320	4.86066134716256	3.92841614684395	0.114567156088410	1.49922041742189	5.33903407943902	4.63221313988973	3.89532658111011	2.33619378289383	2.41349988942805	1.12451621358700	1.92941184584455	2.62447146071294	4.55145878196880	0.603558931642649	5.13768887694781	2.22590833069752	0.799590859598188	3.47190173508881	3.74900158274581	3.26033290374964	5.07042763093840	0.758137750896950	4.12060593228341	4.73567502961201	4.65587885861171	3.90473407774208	4.47443326348805	4.61912126861559	0.648185222031313	5.15998452764649	4.82756923672675	0.604747470522771	4.86181874731865	5.50293880239260	2.62544151472887	1.89074319801423	0.465969857975057	0.562879938827683	4.30930771587123	5.99658531820712	1.19556679882017	5.18027670158942	0.531911422271867	5.05705914335186	2.66021601026405	1.98203963392402	2.97286482467373	0.266589885068996	4.70558969339329	2.82406564532952
4.02219651965377	5.17712452806818	0.288804958548189	5.25545176082496	3.22455088437380	1.66029469139031	6.25271458952157	3.55405013509624	0.913816054712794	4.36355506963065	4.38004629052847	1.61411401076582	3.87217160728402	2.83980698003856	1.56040712645822	0.998536796631774	5.21711118435639	5.81799027555522	0.690582695820590	5.91073930417233	4.83639561716284	1.85842753165403	3.41711603535166	3.25580798955173	4.74545105554579	0.872454627107075	2.32305501610014	4.83958616060844	4.39888725153174	0.525294254632678	4.72985853083963	1.95818089835072	1.21951812233108	4.17643564824915	5.29322682466417	1.72757027870888	5.95002952746865	4.56333092591887	3.87693943041208	6.14186838046886	1.05752984354557	2.64658882237511	2.47423632768518	5.10101179209997	4.07007098235889	3.92902931726734	3.81984585156806	1.30735681836904	2.77215066900752	0.803183953568956	1.35734542806642	0.257440567887882	1.91364323908793	1.49397344940407	1.84005072957602	0.265231305164657	1.08453687113101	5.33284681145139	1.73040487273385	3.31077787195460];

phi_scatterer = [1.94084627994556	4.27651703029845	5.38364519702405	3.96858210598487	2.84559221160454	1.72667564286171	5.83585350888595	3.83131560050366	0.207406776513215	2.42249600302244	5.49709740690396	2.38040358085673	1.79383823780493	5.37333867855630	3.03229455466396	1.66522002609549	6.04687583461196	5.13429385434669	5.36131964312912	3.49901357599964	6.15759286399369	1.28825295051305	1.56391771173498	3.85714694601903	2.34932674561864	4.98235022498174	2.19278949420324	1.30901048597089	4.91971173483559	5.16431595163640	3.06573656188032	4.41425556923392	5.66011476799342	0.257839397318373	4.35803442621941	2.71209057441804	2.60033446137941	3.82142856010674	4.60199787729250	1.16230281423671	0.431587284228409	0.879956149047940	2.28121342930262	3.92121528496285	2.84821830584443	5.77756550237388	4.46538339074815	4.21285607741257	4.42052384598512	0.675191887287665	1.74207555484634	4.58923890291914	0.225581340495624	4.62381899091206	5.71926325172762	2.17957889668869	1.23215192015179	2.34793028870969	5.56694133605238	5.47024257935364
4.64502074115966	1.35761661816661	0.989833634724570	2.30185812711013	2.39209513514945	0.749227261927195	5.50311973795796	0.515809723510393	6.02800641820236	4.92190429634888	0.0850116914903426	1.47163969682272	3.87672560181735	5.97349952799278	0.885224115526943	1.09177140775119	1.52483557993958	6.05741860572205	0.143204594835747	4.05623568068569	3.61082182700264	4.81260868619102	4.41899445033915	3.00274044490213	0.287095172823697	0.365697591315262	4.20033710951618	4.69254694378847	1.83080419876992	1.85720389402019	0.633431630220482	4.38506090703196	1.82924008176309	3.63140200642850	1.75963486028144	6.19665067066093	3.84876870838822	4.99382878354348	1.84045946092779	6.16812701095253	5.30391603358448	0.391570228375349	5.69639088497886	6.07595360760267	0.147660782833910	0.829367025520633	2.94550616868570	4.77941291296903	5.20360060534948	1.44173333236545	4.00984283845946	4.07054129910932	1.82678306703578	1.32830720212329	4.82964030265504	0.362995057166048	1.29601183200767	4.22552310833524	3.75289353491523	0.0208737336610778
0.0821686081471546	2.18480856089405	3.17209761749472	1.79901938220641	1.56275362681749	2.17264571297833	5.93013442876546	4.05111590134759	0.765258972444086	3.51662732231516	4.86260710674593	5.47869035375834	2.91904922552248	1.28133827008535	3.45182168974959	2.46020429084755	1.83143397274107	1.24236392613845	3.95209383341378	4.91724923598124	1.72287652357882	5.41505346354115	3.67511683778651	5.52611069874700	3.05028304023046	3.49249572420616	2.27364524754569	2.84607948537795	1.03616514192525	1.14265906730012	4.56685071330468	0.871634769191847	2.57882628671721	4.70605678308775	4.96264045327507	1.35864931537066	1.13920533864587	1.84432293529296	1.90294622457807	2.90379241239195	4.72928488164438	6.13566614068540	0.276718184052528	2.05070629382244	2.44962811408558	1.35923020079793	1.20064560010343	1.87004525522553	0.605261100531032	3.87939421992159	3.69195834538175	1.03290730066520	5.28933263000320	1.95138757618841	1.01776124615943	0.810968160666937	1.95557800714085	2.29822109292655	5.92613623089636	4.08180632527352
0.192913733732346	2.25976580772768	3.55331230701982	6.06943886569909	1.18350726557157	5.79198423921057	4.76474831803027	5.11299990603070	1.35082744649533	4.00758956084367	2.63361925584360	0.113786845882149	2.14673939387837	2.78065036115731	6.09955858310512	2.32816054292988	4.21036332244167	5.06163360361581	3.69152175074693	4.10133013120120	1.21199736807976	2.12568782711488	2.54393674776974	3.86238269028713	2.60569757950236	4.53999809189526	1.64490300207391	0.344185215374516	0.404991171824313	4.51855701069397	2.09850612139135	2.55372015103309	5.24695361025117	1.33988035293938	5.05945887592529	2.87186987438087	0.165452234135844	5.83139442516815	3.37659694478888	2.08034172418233	3.92949898577978	1.39032669698996	5.52052196136986	1.39648148027676	2.26181176810022	4.72456707944640	5.45250708236040	1.72782144155148	1.75720643616241	0.631742134090019	0.805938404606873	5.28653880658215	3.68471738521130	5.02231219938801	4.59024948905929	2.67238680632362	2.63712155855704	1.53668296502482	1.69611456503369	5.47439749071802
2.88819780563422	2.10602035450443	1.05137177863027	4.78847864645519	1.81337268291818	1.19026987187228	3.23130192736392	4.47062153112362	2.54090269890916	4.99089086021771	6.10224014107979	6.02181579951416	3.18233608041217	5.26890676852136	2.47086755210950	4.02883667526559	5.56620662829902	0.986713279286584	5.41976612854011	0.835927977723500	1.98506622078426	1.35390353222281	4.20794214485621	3.64614000779904	3.35828926780361	2.53958758907544	3.63959171122918	5.78622497501557	5.21533495718331	4.08002867357630	6.18921706631153	1.92214154846261	0.417934191291367	5.82060531070080	3.06073737923524	0.281028163282879	3.12738803866400	5.55502863023856	0.319319923694024	0.624674009754703	4.23638837549558	3.80021043378652	4.14352710843771	2.81838793912180	3.68713265584717	6.25836503445930	0.564585397632882	2.60341164060998	6.17888094542136	4.65658011529444	1.39728457141878	5.77877431614246	0.768614320094624	3.40559334027004	4.54253333135260	2.74508030085357	1.86860250390592	0.602463426053225	5.43091904243947	6.06045733020984
1.16026003111740	4.92211281017301	2.33550772557972	4.54700219488539	5.85876510702970	4.24778228881149	1.51395875462666	0.205201030896188	1.04279469437547	5.47787404898387	4.27355410357659	6.08366662148360	5.33579745726272	5.31485947622515	4.58371758976747	2.82443779536294	4.18038029266802	3.80877590271768	5.84962258467163	1.08241148453111	2.39511210108562	1.05871697893549	3.97086698777365	0.336061999160794	3.13007907225392	2.33589987346766	3.48531295224304	2.14839975893257	2.84197047689376	5.45968121381187	2.21843404179702	4.07410638922276	4.99445795823631	3.42062812857125	6.06665308633672	2.78886425811933	0.420442537900955	5.67306511443761	1.45492697205830	1.89168474403331	3.03057575875676	2.15865360256283	3.05120084740489	1.26780911272561	1.17318192027431	2.33256128042743	3.41217660436862	1.11033332725688	5.38766495068822	4.88090745070056	0.842649534285289	3.53235403797669	3.22641564222305	6.16150192083272	2.01116056230186	0.441333259277832	1.48307710969932	0.767288136592235	2.66984882540497	2.54299342783803
4.16424054041694	4.66543389846820	2.49434423935424	5.42059529823668	4.88709173686149	0.0967863480057883	5.45817687225067	5.92423807055321	4.65715200750768	1.28937465972805	1.33343043463581	4.14953296614653	5.44425023738401	1.30761629768092	4.24914167151066	3.90891325047221	5.22149857711215	3.88458530434366	6.11897155126870	2.91312563662246	5.33968290031306	2.19437017545134	3.13880743518043	2.10194110270352	5.54799697692097	0.201009332875820	0.492083302768831	0.105421357474607	4.75745224883063	3.72039690990672	5.30244340145399	2.32394799127891	4.51183220613342	2.04333154303045	5.00855192106297	2.64517281108013	6.04077019325128	5.12953827998082	4.56587748442460	2.72646910886142	5.19760239322096	2.52251951843477	3.92819916417863	4.51729230578740	1.18443235142741	4.06239706016378	5.89362754947528	3.39258787910969	4.52394317682177	5.03043585819798	4.66579387323743	4.84619191636873	1.66986110169269	0.767864030372990	5.81156280944377	5.46969830445518	1.77477621832166	4.50330497246003	2.12127111170873	0.796346305242145];

eta = [-4.91140959824720e-07 - 9.10565338173367e-08i	-4.03277937203603e-07 + 8.87035281744165e-07i	-3.82837131192050e-07 - 3.64059200228491e-07i	5.27872906782551e-07 + 3.50511658679880e-07i	-1.33360214771272e-07 - 2.43995585230878e-07i	-1.08283239862156e-06 - 1.41729062727174e-07i	1.85634887818822e-07 + 1.13332037577550e-06i	6.33155751769196e-07 - 1.07309151994742e-07i	6.28593062361715e-07 + 4.91691114273031e-07i	2.55565471662893e-07 - 4.35444868518138e-07i	-2.52070697395037e-07 - 5.41527479174021e-07i	-1.76334216342383e-07 + 1.03105381017129e-06i	-6.52954202727930e-07 + 4.79664277511343e-07i	-1.82759562643327e-07 - 9.64125903543763e-07i	-8.55712261300035e-07 + 3.36944383757585e-07i	-2.46405367954716e-07 + 3.46267482356191e-07i	8.89980736854476e-07 - 7.06838933526125e-08i	1.16070828015076e-07 - 2.92145588275531e-08i	3.75925317730593e-07 + 1.41092447455137e-07i	-8.84203384864459e-08 + 8.66357497878153e-08i	-2.27238125063708e-08 + 8.95709395964827e-07i	4.11139765190647e-07 + 1.06692041615933e-07i	-9.95659731199517e-07 + 4.50382813782063e-07i	3.68494919024334e-07 - 2.48658652520164e-07i	1.77986300899808e-07 - 3.19057200671514e-07i	-8.73472913353571e-11 + 1.30371286441390e-07i	5.72633612604518e-07 - 3.89160040922417e-07i	-2.31413914733325e-07 + 2.77458000885495e-07i	5.04695047550498e-07 - 2.77613026186332e-07i	1.50382789178793e-07 - 2.91733876875779e-07i	-4.94768516610003e-07 + 2.43259053359376e-07i	-9.77906735310623e-08 + 2.93126087456654e-09i	9.30698652622040e-07 - 1.64359129261150e-07i	1.97946869209131e-07 + 5.35433094678219e-08i	-8.50611628019674e-07 - 7.47956271694771e-07i	-4.05194653901781e-08 + 1.46850117118206e-07i	5.12762986609729e-07 + 1.39024223275073e-08i	1.52799473020943e-07 + 3.35641409834121e-09i	1.26732115514365e-07 - 6.82935415640700e-07i	-1.75772583714203e-07 - 6.74291857890786e-07i	9.19598779486931e-08 + 4.24192454526621e-07i	-2.20095528778468e-07 - 3.05668831461786e-07i	-2.53382062356465e-07 - 6.16506189664147e-07i	2.92112337488381e-07 + 3.14119896040722e-07i	7.36029442776407e-08 + 5.50655598842745e-07i	4.51049441305908e-07 + 6.43637133036087e-08i	-4.31581653200991e-07 - 2.85505312728599e-07i	-2.77292959344562e-07 - 2.70000396838586e-07i	-3.68472132402377e-07 - 5.39244338179087e-07i	3.72535070684038e-07 - 5.44482261933679e-07i	8.40387088220000e-07 - 1.08326609678604e-07i	-2.23836792552084e-07 - 3.40168025592355e-07i	2.93418494755823e-07 + 5.89142958106010e-07i	-1.03627834735620e-07 - 2.96317004714191e-07i	-3.78403887472298e-07 + 3.45629015705781e-07i	-5.32711605037400e-07 + 2.18940736254048e-07i	-3.51271057437334e-07 + 4.37416294642790e-07i	5.89863581787594e-07 - 5.18989196189236e-07i	2.43334142807740e-07 - 5.27772612552318e-07i	-9.42488064804435e-07 + 7.07045546583909e-07i
-6.68655942146354e-07 + 1.09697898035165e-08i	-4.05274630794084e-07 - 1.89958569319311e-07i	4.75982118052720e-07 - 2.58640854709743e-07i	5.26396517843833e-07 + 1.51247280170485e-07i	7.92393264818206e-07 + 5.55546472506261e-07i	-4.96729049950775e-07 - 2.27071760281559e-07i	4.83687943094416e-07 + 5.70369817916329e-07i	1.18757973884680e-07 - 4.96661084930815e-09i	4.66280114879731e-07 + 5.20250054304522e-08i	6.60875466180285e-07 + 8.93422551792849e-08i	-7.97790320423740e-07 - 2.06037310884755e-07i	3.83683521303071e-07 + 1.34680611161389e-07i	-2.44194861595900e-07 - 5.87231673253032e-07i	1.27522407653722e-07 + 1.91346937260302e-07i	4.07522139435666e-07 + 2.44850864252462e-07i	-2.67146843984458e-07 - 2.12884008700663e-08i	1.69980268101159e-07 - 2.34278208842375e-07i	-7.93134512050745e-07 - 4.51672485057442e-07i	4.30458857649362e-07 - 5.60732303673575e-07i	5.98711279616482e-09 + 5.87186874574794e-07i	-1.52538481953962e-07 + 1.06119268150030e-06i	6.42854200427439e-07 - 3.40487816355795e-07i	6.30186809637493e-07 + 2.24234915388407e-08i	1.38797127927607e-07 - 1.54856923313549e-07i	-3.60482936063546e-07 + 1.14976327395431e-06i	7.01684789829791e-07 - 1.10784879572969e-06i	6.21341744036885e-07 + 9.67595685055560e-07i	-3.24927886778651e-08 - 2.85847791496168e-07i	7.45213488526524e-08 - 4.09292483802554e-07i	1.16198463684584e-06 + 3.55227914947385e-07i	2.87002870940600e-07 + 3.42493613615144e-07i	-4.09190331468901e-07 - 3.63366035495473e-07i	-6.79881991485510e-08 - 5.99286197977496e-07i	2.11198431095983e-07 - 1.39486082709320e-07i	-2.35862939212879e-08 - 3.17049432153041e-07i	-3.43671353955116e-07 + 4.94323213035843e-07i	6.52737467324686e-07 - 8.04094383551680e-08i	1.15457937568088e-06 + 5.64656100705962e-08i	-2.80195950181583e-07 - 3.76809438661313e-07i	-1.85795450271064e-07 - 9.52786192299625e-08i	4.20067726959279e-07 + 3.99081709231678e-07i	6.05638958253834e-08 + 3.82304351505976e-07i	2.10485576896359e-07 + 2.71282641493551e-07i	-1.97214778618817e-08 - 1.13431334938388e-07i	9.20567505693017e-07 + 4.00642942921918e-07i	-1.37987850504680e-06 - 2.66376861257944e-07i	4.66275772115429e-07 - 1.89746247623946e-07i	4.23270179191131e-07 - 7.04023165993311e-07i	-9.48918014373965e-08 - 5.73439231220689e-08i	-6.16284896124572e-07 + 4.73631798709507e-07i	-5.80174275801537e-08 + 6.35837872929134e-07i	-4.67345355597985e-07 + 2.85671505654181e-07i	5.23710958263025e-07 - 4.72952641049089e-07i	-2.04232695296585e-07 + 3.27028622835703e-07i	-6.19871373774281e-08 + 3.59076792742834e-08i	-4.49664589569464e-07 - 1.46842654218154e-07i	-6.18401470964695e-07 - 6.75148129435278e-07i	6.75723768865810e-07 - 6.05064758421571e-07i	-3.58546449696290e-07 + 1.02908548541226e-07i	-1.09179171628084e-07 + 8.66606861342689e-08i
-2.71348349270594e-07 + 1.11936801645710e-07i	-8.56218352338218e-07 + 2.54352404144974e-07i	3.69763728519625e-07 - 2.65264529971594e-07i	5.99878974275568e-08 - 6.00699779027893e-07i	1.55507806857742e-07 - 2.19568391503929e-07i	-4.72813087439908e-08 + 6.95814689867653e-07i	-1.71817775326651e-07 + 1.07798460336942e-07i	1.23971217193500e-06 + 2.21038716838793e-07i	-9.32614746339276e-08 + 2.30081326029647e-07i	-3.16880560356132e-07 + 6.87470088279248e-07i	-1.64691978614036e-07 - 2.78631051392428e-07i	-1.66719172326987e-07 - 7.89910207798331e-08i	7.27304811156498e-07 + 1.82637047878068e-07i	-6.26171917874172e-07 + 1.48701639269720e-07i	3.68533615794521e-07 - 3.01406523163836e-07i	-4.25453699215691e-07 + 9.61976936115408e-07i	-1.23773860442332e-07 + 5.88929154840237e-07i	7.49418964394653e-07 + 8.38877455892672e-08i	1.36032202146179e-08 - 7.02389169658309e-07i	8.41839174077830e-09 + 3.79056077499083e-08i	3.66314679591112e-07 - 4.11741570944304e-07i	6.77773697528523e-08 - 2.00094950765886e-07i	-1.20063343888490e-06 - 6.28104662471122e-10i	-4.01048441869942e-07 - 2.54192120385300e-07i	-7.09534353438633e-07 + 6.29657130262467e-07i	1.86989578234748e-07 + 5.10014946494529e-07i	3.08132724768987e-07 + 7.68737270865447e-07i	8.68497271263167e-07 + 5.16204233205493e-07i	-4.24582724461487e-07 + 1.17513529945207e-08i	1.62635095491623e-07 - 3.81105778793506e-08i	-5.17073486110856e-07 + 1.09312557303265e-06i	7.24011828604556e-07 - 3.90788934796829e-07i	2.45928557354409e-07 + 7.04483686367855e-07i	3.50920050823677e-08 + 4.72470077860972e-07i	-6.15332107103763e-07 + 1.37255829535535e-07i	3.37743135935137e-07 - 1.84977364802948e-07i	7.28497945850252e-07 - 6.25665212251707e-07i	-4.39877609296280e-07 - 6.54054939046091e-07i	-9.33872200644670e-07 + 5.42175677904770e-07i	-2.42173882284911e-07 - 3.57673560903160e-07i	-3.22214861731470e-07 + 2.32913085892326e-07i	-1.55833593700290e-07 + 5.45356150205512e-07i	-1.30056705475393e-07 + 1.07502685746947e-07i	-6.45172974680758e-07 + 2.00288829682298e-07i	-3.85492838036082e-07 - 1.03347652235266e-06i	-6.83701925277349e-07 - 2.78264394840729e-08i	5.59381406228613e-07 + 3.87092715725780e-07i	2.72273927290413e-07 + 3.73115133860592e-07i	-3.83008668681903e-07 + 2.09910535930133e-07i	-2.87266066633744e-07 + 1.62872710675097e-07i	3.89307501459723e-08 - 6.96152302242644e-07i	-1.55109226719926e-07 + 3.69850728428924e-07i	5.79265633558494e-07 + 4.88784574613536e-08i	1.05040928731071e-07 - 1.42171615290991e-07i	8.46918888436192e-07 - 5.31257033819378e-07i	2.78348882137030e-07 - 3.44991271156063e-07i	-3.58388483211427e-07 + 2.60168934943283e-07i	5.17355245857189e-07 - 9.94947331244468e-08i	-1.15691193352162e-07 + 5.96678345960989e-07i	5.72949538134767e-08 + 6.71553230371391e-07i
-5.59406607346203e-07 + 4.50903811192607e-07i	-4.48074901125812e-07 + 3.17300950005533e-08i	-2.86245436940168e-07 + 6.44869925735290e-07i	6.02555699419800e-07 + 1.93429691365164e-07i	-1.66533595374739e-06 + 3.39900100747958e-07i	2.86019240788395e-07 + 3.82107150429944e-07i	1.10110898113030e-07 - 8.98410856058309e-07i	-9.89134119142717e-08 - 2.75986432372339e-07i	2.85950555214701e-07 - 6.76242858451589e-07i	-4.68584413865485e-07 + 4.03073948480774e-07i	-5.58169162769821e-07 + 9.25368674253313e-07i	2.17288693644906e-07 + 2.07413807765051e-07i	-3.57316301383396e-07 - 4.68389021654286e-07i	-1.32008880675179e-07 + 2.83314667179351e-07i	6.99525828196471e-07 + 4.03268749412031e-07i	6.74116642115372e-07 + 5.88259094960318e-07i	2.89170931871981e-07 - 4.12827477928613e-07i	-4.98276338511730e-07 - 7.91266632795815e-07i	-5.48866454175695e-07 - 1.82235304410875e-07i	-2.37743284082416e-09 + 5.03631261568762e-07i	-2.61034254805703e-07 - 5.45908697538222e-07i	9.90795178857486e-08 + 6.84940965224398e-07i	1.32857227291705e-07 - 1.59961858250352e-07i	-5.21532475651982e-07 - 3.43280543957226e-07i	1.90521483799905e-08 - 5.61940113438458e-07i	1.09947383868391e-06 + 5.46253674230257e-07i	-2.49393901977220e-07 - 1.86578381490403e-07i	-7.19796439680219e-07 - 5.09725380128779e-08i	-7.81188028482257e-07 - 2.67762158653843e-07i	6.85541244760451e-07 + 2.25823036280012e-07i	-5.64981283373386e-07 + 1.61227539387927e-07i	-3.14720142856208e-07 + 5.43358337305455e-08i	2.08446270199663e-07 + 6.24464683684823e-07i	-1.78218683021139e-07 - 3.39472604175136e-07i	4.38843748836954e-07 - 3.21703784089290e-07i	-1.28080952986569e-07 + 3.87318824317416e-08i	1.34496341886719e-07 + 1.15879088270778e-06i	6.88092123396233e-07 - 4.30155076498059e-07i	-3.30794429715981e-07 + 2.65372235723290e-09i	-4.46902222258386e-07 - 5.47903955146144e-07i	1.54343913287624e-07 - 1.83193120152986e-07i	6.21291847684655e-07 + 1.39092000373036e-07i	-1.44835925117419e-07 + 8.16351452529822e-07i	5.08072675449437e-07 - 5.67516227436271e-07i	-1.80429145444140e-07 + 4.40938722250346e-07i	3.17986090966771e-07 + 2.40669702793859e-07i	2.33632213588311e-08 - 1.64293182099647e-07i	-3.91451085307236e-07 - 2.62833545218664e-07i	-2.51934080471958e-07 + 4.32621057168313e-08i	-4.86098023719741e-07 - 3.39927478409435e-07i	-3.43894219204666e-07 - 8.22502139199769e-07i	5.92574112825616e-08 + 3.00951244656767e-07i	-1.11074122546367e-07 - 2.45801994942325e-07i	2.58883659723849e-07 + 1.60290920855486e-07i	1.12569763132104e-06 - 7.97777887603486e-08i	1.37203127498891e-07 + 7.84583798490912e-07i	-6.25888591693432e-07 + 1.36477724259860e-07i	-4.29100727685819e-07 + 4.50333845133472e-07i	7.28278847279460e-07 - 1.17031918026672e-06i	-6.12088336705667e-07 - 3.70095535775371e-07i
4.16048182834940e-07 + 6.15975830831472e-07i	-2.39597753164139e-07 - 5.86247731648523e-07i	-2.76367589976316e-07 + 9.91669915722283e-09i	-1.00746458130695e-07 + 3.11109351962736e-07i	2.50352784567010e-07 + 5.90417306443581e-07i	-9.23839399203002e-07 + 4.20706162065436e-07i	-2.01999618593498e-07 - 5.60731615664043e-07i	-4.24702510037370e-07 + 1.49975005246287e-06i	-3.77152229562026e-07 + 1.72430717599656e-07i	6.77518256869830e-07 + 2.14525177743991e-07i	-8.32171499278173e-08 + 5.95186839107570e-08i	4.71685413651516e-07 + 4.05629326433553e-07i	8.36364711097845e-07 - 4.55087622550824e-08i	-7.10445189374449e-07 - 3.44741539202819e-09i	9.02015728002295e-07 - 5.27650345841907e-07i	-4.93260936580013e-07 - 8.30579165999789e-07i	-7.56875160596044e-07 - 2.52617802740822e-07i	7.24837536907923e-07 - 2.55648800828756e-07i	-8.19518507963935e-07 + 3.02456404594508e-07i	7.37593939226389e-07 - 7.37467080131738e-07i	-2.43968852155418e-07 + 1.10165254457336e-07i	1.07473902357852e-07 - 2.65463202145286e-07i	-2.44813158520685e-07 - 6.45514587520205e-07i	6.80696698354846e-08 - 4.34311231575489e-07i	3.51790724851814e-07 - 9.51884792572604e-08i	1.33468948904856e-07 + 5.24413371110197e-08i	-6.93524550179153e-08 + 3.93624728612682e-07i	8.49360678983096e-07 - 1.16586113621090e-07i	5.91953979452705e-07 + 4.81107896976108e-07i	2.76102237711579e-07 + 1.12201321486124e-07i	1.04523356377997e-06 - 3.67254201490805e-07i	3.14701318104609e-07 - 1.33936502627627e-07i	-4.22600926540071e-07 - 3.73824006740405e-07i	-5.08760727379562e-07 - 4.55039851870540e-08i	-8.99610055996344e-08 + 1.76155184412438e-07i	9.27183496068765e-07 - 1.43923571583285e-06i	-2.41348006638347e-07 - 2.06844019191249e-07i	1.52667843836703e-07 - 3.56467763440627e-07i	2.13086798480380e-08 + 1.26591334049303e-07i	1.46950901711100e-07 + 4.83432538202002e-07i	-2.81886707689021e-07 + 1.70833144270378e-07i	-1.12821601467088e-06 - 1.19289959522926e-06i	9.08973494284687e-08 - 5.25151811893697e-08i	2.80296237169302e-07 - 7.90437896795952e-07i	-3.19462630626832e-07 + 4.47190919702588e-07i	2.62716163604763e-07 - 1.52345014169949e-07i	-4.03680401626855e-07 - 4.15246871654048e-07i	-2.04270995689865e-07 - 5.15370431309795e-07i	2.30575601712503e-07 + 3.66256097380850e-07i	8.30855919124098e-07 + 4.20711674827679e-07i	5.35284842949431e-08 + 5.88334211984578e-07i	7.80837614338846e-07 + 1.13347648348302e-07i	-7.48407426992369e-08 + 6.93990789224125e-07i	8.21904946024290e-07 - 1.10424790020447e-07i	-8.30027453359756e-07 + 4.90213808758825e-07i	1.15564305805206e-08 - 3.60526723609718e-07i	-1.09153276167516e-06 - 5.77420324603594e-09i	-3.50152164784190e-07 - 3.74727589997007e-07i	3.84976229417812e-07 - 1.67198006732269e-07i	-5.59643914288977e-08 - 8.63350031688943e-07i
3.42813878153931e-07 - 3.30007125025970e-07i	-6.25976427290432e-07 + 1.17612380012873e-07i	1.97961390864023e-07 + 2.75386122636402e-07i	-5.70781489502881e-07 + 8.80813405561220e-07i	-4.91287431043535e-07 + 8.56279352815618e-08i	2.75553124613602e-07 + 1.97771264089277e-07i	-1.78833767155014e-07 + 6.66084723118509e-07i	-2.92083185651515e-07 - 2.57568772923783e-07i	-6.46041546959389e-07 - 2.94859710752011e-07i	-1.99713675617683e-07 + 3.44817745327702e-08i	-3.91349477123449e-07 - 7.28095415786603e-07i	-2.12259340094600e-07 - 3.28982729606659e-07i	-8.33501101514014e-08 + 8.39504300128826e-07i	4.00860107506954e-07 + 1.93512553866401e-08i	-1.52932695915059e-07 - 5.29539416601208e-09i	1.76103886776801e-07 + 2.84068456682232e-07i	2.41135311802006e-07 - 6.92747504932042e-07i	-1.86437362374864e-07 - 4.85475317927927e-07i	-1.54892461584073e-07 - 1.06181148902116e-06i	-2.15019444293275e-07 + 2.85830263130897e-07i	-8.27881587152925e-07 + 8.35916049294852e-07i	-6.28597078852527e-08 - 6.06467245108889e-08i	-4.13140672242303e-07 - 1.20790517873321e-07i	2.03342468504601e-07 - 4.11417061132530e-07i	-8.23230335529315e-07 - 6.02608191725180e-07i	1.17209336859050e-06 + 2.48704425242791e-08i	-5.34035632300067e-07 - 4.91227347393638e-07i	4.51360412288463e-08 - 2.49168476490291e-07i	-1.85856286543128e-07 - 1.03310316726557e-07i	5.61533049977949e-07 - 9.02540031493165e-08i	-2.19063409222167e-07 + 5.14422138217939e-07i	-3.17190344745554e-07 + 3.60500075289220e-07i	-2.70362627576287e-07 - 1.73301969783929e-07i	-6.95961693139527e-07 - 2.22690155087184e-07i	-3.80371181266077e-08 - 6.60661567515583e-07i	-1.02914646715030e-07 - 2.39929050004824e-07i	4.47556448281949e-07 - 2.09859418503283e-08i	-5.31556333090443e-07 - 1.26466947252575e-07i	4.57335298360527e-07 + 2.34284471447779e-07i	2.46557433373909e-07 - 7.10193529449207e-08i	4.30454622426617e-07 - 1.41811816472289e-07i	-1.00909578398877e-06 - 1.61632498053516e-07i	1.39686837269055e-07 + 4.95494883226687e-07i	4.08319044086718e-07 + 2.48334187090533e-07i	1.89187220525974e-07 - 7.91338068320136e-07i	-4.49489078846087e-07 - 5.57414219101797e-07i	-4.84802254210160e-07 - 3.74126671049306e-07i	1.64215790562806e-07 + 1.56960469248794e-07i	-5.56145923276056e-07 + 1.54483937805779e-07i	6.14342875205755e-07 + 6.72033228852340e-07i	4.87568446069225e-08 + 3.53974932509826e-07i	-1.12699618650457e-07 - 8.51726305255157e-07i	-1.03249406589145e-06 + 1.52922344998172e-07i	3.90390441795302e-07 - 4.81189300037591e-07i	9.86971324532767e-08 - 1.28630983088239e-07i	1.70582469596684e-08 + 1.08496895203009e-06i	3.17585906452642e-08 + 8.11069582438527e-09i	-3.41759191372077e-07 + 4.28190436324378e-07i	6.14130444283543e-07 + 9.05903185439967e-07i	1.00343482549047e-06 + 2.28112539382454e-07i
-6.51488778720999e-07 - 1.92365213109520e-07i	1.33444300691227e-06 - 4.15219459466313e-07i	1.94743718020771e-07 - 3.65252011966153e-07i	6.63407139756951e-08 - 4.30762390313318e-07i	1.85911584895952e-08 + 1.16637920536765e-08i	1.35183784692811e-07 + 3.06555751438393e-08i	-1.61566884007996e-07 + 8.36472196366162e-08i	-5.50912857015871e-07 - 4.14633881074798e-07i	8.38943125759701e-08 - 7.65521444809164e-08i	-2.22062148381952e-07 + 1.82186552969956e-08i	8.19140435130804e-08 - 1.84021987263221e-07i	-1.25496809456042e-06 - 3.31342842309510e-07i	5.96911192321469e-07 - 2.97546877191887e-07i	-9.70127671245618e-07 - 5.29911097473164e-07i	-1.91715637395156e-07 + 1.14715774692482e-06i	-3.41790141052124e-07 + 1.02577437064713e-06i	-4.26725720951353e-07 + 2.70039424687972e-07i	6.50590418405958e-07 - 1.62850292662562e-06i	7.32727629329031e-07 + 5.29055214518733e-07i	-1.07240732798858e-07 + 1.62913764320568e-07i	-3.94774642399099e-08 - 1.26755737775172e-07i	-2.25428313645910e-07 - 2.65294755550870e-07i	-2.00105140260595e-07 + 1.07974820010729e-07i	-6.83001130193181e-07 - 1.76705467362994e-07i	-1.33095633795445e-07 + 7.15086780351568e-07i	-4.13581876097690e-07 + 8.91781604485632e-07i	5.67637904793103e-07 - 6.58581262083619e-08i	-8.94059421421527e-07 - 1.55972616361014e-07i	-7.59312134078569e-07 + 5.48561357554944e-07i	-7.31208419914986e-09 - 1.09477297431263e-07i	-1.46406312816053e-07 - 7.30856472224068e-07i	-3.88546145299040e-07 + 4.99943156444184e-07i	9.71562916623160e-07 - 1.56340643791727e-07i	-2.19750244729181e-07 + 9.55017308763532e-07i	-1.96412259945580e-07 - 8.00672340088411e-07i	-3.33336217437022e-08 - 5.61778576930607e-07i	2.43810123881468e-07 - 9.12245678654479e-07i	1.24499932375754e-07 + 1.61287907892566e-07i	2.98127003389169e-08 - 4.76189902723773e-07i	-7.16861192170870e-07 + 4.85823119253482e-08i	-6.91878942314273e-07 - 5.94308115952678e-07i	-2.06124741129872e-07 + 9.70525447328794e-08i	-4.48302268318815e-07 + 7.46491226679785e-08i	2.76849610666848e-07 + 1.83106010059463e-07i	-2.13282775718989e-07 + 4.67631948119345e-07i	-6.87686366360558e-07 + 5.74840029417731e-08i	2.30436504302592e-07 - 2.58455212878803e-07i	1.52196704072446e-07 + 3.20058478250906e-07i	1.64692004126329e-07 + 3.45476663201471e-07i	-7.91095100231221e-08 - 1.36715791811875e-07i	-6.08317699716150e-08 + 1.62841697044757e-07i	-2.29263105994235e-07 - 9.23148562042189e-08i	2.18521369260991e-08 - 2.08282310587447e-07i	-4.16134281481369e-07 + 1.04371972154612e-06i	9.57920589917523e-07 + 7.46998572097034e-08i	-1.99287117563156e-07 - 1.33875460714178e-07i	5.65704660396112e-07 - 9.48678168107738e-08i	-2.54448651892770e-07 - 5.86496412632708e-07i	5.00618491272524e-07 - 2.21786741411111e-07i	1.70261187270696e-07 + 2.92016243455973e-07i];











%% 生成无线信道
% LoS链路信道
for k = 1:K
    for b = 1:B
        h{k,b} = sparse(M,1);%%%%%%%%%%%%%%%%%%%%%注意
            e0{k} = [ sin(phi(k)) * cos(theta(k)) ; sin(phi(k)) * sin(theta(k)) ; cos(phi(k)) ];
            % e = Rot_Matrix{b}.' * e0;
            if dot( normal_vector{b} , e0{k} ) > 0
                Lambda_LoS(k,b) = 1;
            else
                Lambda_LoS(k,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(K_rice/(K_rice+1)) * sqrt(M) * sqrt(Omega(k,b)) * Lambda_LoS(k,b) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e0{k} ) );
    end
end

%% 测试
for b = 1:B
    Px{b}    = dx * Rot_Matrix{b} * [1;0;0];
    Py{b}    = dy * Rot_Matrix{b} * [0;1;0];
    T{b}     = exp( 1j * 2*pi/lambda * ( kron( delta_x * ( Px{b}.' * e0{1} ) , ones(1,My) ) + kron( ones(Mx,1) , delta_y.' * ( Py{b}.' * e0{1} ) ) ) );

end








for k = 1:K
    for b = 1:B
        % h{k,b} = 0;%%%%%%%%%%%%%%%%%%%%%注意
        for iota = 1:IOTA
            % eta(k,iota,b) = 1/sqrt(IOTA) * Omega(k,b) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
            e1{k,b} = [ sin(phi_scatterer(k)) * cos(theta_scatterer(k)) ; sin(phi_scatterer(k)) * sin(theta_scatterer(k)) ; cos(phi_scatterer(k)) ];
            % e = Rot_Matrix{b}.' * e;
            if dot( normal_vector{b} , e1{k,b} ) > 0
                Lambda(k,iota,b) = 1;
            else
                Lambda(k,iota,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(1/(K_rice+1)) * sqrt(M) * sqrt(Omega(k,b)) * Lambda(k,iota,b) * eta(k,iota) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e1{k,b} ) );
        end
    end
end
% for k = 1:K
%     H{k} = [];
%     for b = 1:B
%         H{k} = [H{k} ; h{k,b} ];
%     end
% end








end