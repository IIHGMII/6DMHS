function [ h , e0 , theta, phi , theta_scatterer , phi_scatterer , IOTA , eta , Omega ] = Channel_Generation_init( K,B,M,Mx,My,normal_vector,K_rice,Coor_Ele,lambda , Rot_Matrix )

    dx = lambda/4;   %x轴方向天线间隔
    dy = lambda/4;  %y轴方向天线间隔
    delta_x = ( 2 * [0:(Mx-1)].' - Mx + 1 )/2; delta_y = ( 2 * [0:( My-1)].' - My + 1 )/2;
%% 针对初始6DMA位置，生成无线信道
PL    = 32.4 + 17.3 * log10( 8 ) + 20 * log10( 30 ) - 26 ; % Path-loss,包含20dB天线增益
Omega = 10^( -PL/10 ) * ones(K,B);  % path-loss
IOTA  = 60;         % 散射体数量
theta =  rand(K,1) * 2 * pi; phi = rand(K,1) * 2 * pi; % K个用户的水平角和俯仰角
% theta = 5.263863993147139 ; phi =  1.057064847365129;
theta_scatterer = rand(K,IOTA) * 2 * pi; phi_scatterer = rand(K,IOTA) * 2 * pi; % K个用户的水平角和俯仰角
% NLoS链路信道
for k = 1:K
    for iota = 1:IOTA
        eta(k,iota) = 1/sqrt(IOTA) * Omega(1) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
    end
end

% theta = [0.398000582623814
% 4.13607674259630
% 2.40744967612023
% 0.754202815883541
% 6.09541468378548
% 2.28522305932147];
% phi   = [0.365300430163000
% 4.96612745854756
% 4.83581807952140
% 4.36700797893257
% 3.48882202164194
% 3.17822942328075];
% theta_scatterer = [0.592936539701664	4.02970631346283	1.48765588856661	2.35655881129674	2.39602732103272	4.47596332570132	1.71024720716598	5.97004669691675	1.62519475459383	4.98957235907735	4.16395648164198	2.00107211753462	5.76028428577018	1.37510977430735	1.50596137977684	2.10934633499921	3.07287774642402	4.43458922878220	6.16719629760111	4.99397659715136	2.07216978766795	1.75946700750733	6.00419340057671	1.27828236685218	1.85111030905647	0.853318427600798	3.95757622267417	4.59123605967814	0.428135057018030	3.54924364688576	5.48861956900102	0.770916392534453	4.84343415178237	5.33761096778672	5.72742069975143	4.88430166430536	2.88465955339878	1.27739079454409	1.25193519395552	3.67945318014782	1.71084222247577	1.45654643046327	5.71015098745066	2.26230186899160	0.0654269096770488	3.99650919589475	6.02583584781434	5.34809729081822	0.818074380154423	0.810998752510240	5.58991822103941	6.26353740300430	2.58054060016561	1.01868032024514	1.40177938261631	4.56905422065732	2.23308336820348	4.68179937191290	2.99032032445896	0.182685602440396
% 2.76658767068305	1.40847241534226	3.51058538159955	0.387992307410404	0.631416895447982	1.71703004258032	5.68392804336411	5.56710791939671	4.10132274682175	2.50137477713494	0.551109380992930	5.09445471866244	0.128754115755002	0.474431296785233	3.25041905947090	2.74257799527551	3.68515138815458	4.36417176187038	6.18896134951019	2.38864980543614	1.20397499919662	5.98010716513450	5.75538416767611	2.26953280924940	0.746477814194878	0.994261971532888	2.25813386877015	3.42510127425594	2.54806219655644	2.89586775985386	5.93346983012524	0.418371621330308	1.19381923443035	0.597342318369807	1.44021813450253	1.08487011254921	1.35661431747434	4.59830520168011	2.40022171036419	3.74093492195317	2.22359263653882	5.73678662520802	1.19413144635379	2.75327084827307	0.293792624071986	3.15036544969419	0.599782972435352	3.61776802819207	5.71867357291844	1.32957535785217	3.53364330208596	5.51213187611335	5.98779123697493	2.54519353831226	2.07764723447410	3.51217097389289	3.81194053220441	1.87172264206163	4.67751818026040	3.20545289348139
% 1.21197355954395	0.924461334868484	1.29965416537997	1.11212554300748	5.20122082647217	5.13355956752855	3.90107442448967	0.731521208622644	3.18793328509432	4.00534740390488	0.537081092190739	4.09273798939617	3.44384193896755	6.14674008653250	0.577970151960422	1.14726210134567	0.0381965549130333	3.15465231059936	3.95689457724700	1.30916166663397	4.78066208342548	5.47097887969707	1.17049141765502	4.59116369078772	1.32480627711015	3.95758976852817	0.999964353909499	4.27000861035806	3.46371758653973	3.66123820159447	0.498264686236205	0.911690653447870	4.20130801825329	3.95093039064587	4.06894672852531	6.23040727895876	4.49435838963436	5.12764399374908	3.59534504042997	2.39011247568088	6.23909312166256	3.49798561202600	1.59934724855942	4.23449451336154	5.71319760459769	4.87772683589646	4.00770082959761	0.462505716439677	1.32205743603294	2.64781826322982	0.187778062002029	5.49355113679983	4.50993701019573	1.41529672950138	0.572631208955705	5.08435646161779	1.37820602024711	4.48468453667664	2.45733455685014	3.73125250949940
% 5.27871803447221	3.21186834256584	1.29806857779635	4.99533064177107	3.16732951530925	1.72960407398163	0.0696440738442857	4.89069844580036	5.68862308278857	0.352957242122122	3.09102640392519	1.42591677312580	5.00535147077574	1.30282705131936	4.46090090946375	2.32929248542887	3.97142615177945	5.94930334336149	1.69478868949204	4.49598736720635	1.75672599296420	2.84228849777686	5.73774983426395	4.67256459252409	4.23572859475989	6.00445854818114	3.02305975794757	1.22421366211221	5.90896690880252	2.43071790173345	0.549198807782714	4.34910116148369	2.21858496462463	1.21897181864340	4.45670911997809	1.51890452745644	0.636495821177894	2.87041261116210	2.05743873688119	6.06735642517185	0.680581398950117	0.567386648615593	5.91785759888780	1.39576693341750	0.315668246661987	2.60483356224268	2.62188082124527	4.99604012375063	0.723717344493397	3.76626423058877	4.74944122008160	0.334913988999434	4.45223737339341	1.85691573767632	5.07543946918320	2.29210503385261	3.71834437817731	2.26679199853899	2.91942527889782	3.74431011285986
% 2.80128626132334	3.41981851244150	1.10932584988672	5.68754663899485	4.09823345524838	2.34365168529173	4.68007313052637	5.92666659667484	1.80793368696222	5.59597735697674	2.05380456642328	3.54951289833474	1.96384719930572	5.14064328480303	3.71277054355506	3.59158032496959	3.26121464431683	2.93707048640246	5.05559479625505	5.18205807373416	4.12833616778499	5.45182375893828	0.392730726126784	0.131738586799686	1.47179941252362	2.67559908001963	0.990942238965117	5.09470678348612	4.95662559737191	4.87131018544751	3.60185501702708	2.46437993741955	4.03394054124174	2.44994958379174	5.78744711850750	0.527984618814368	4.40819788927871	2.14498369148233	4.95572034957648	4.31321011396107	0.250334601318199	6.22890995025056	2.70674590555309	0.938759915470382	2.93075988386806	4.34525460820463	4.66974654022926	3.96290994665184	4.70732161830138	0.523608853746456	3.32361582250223	1.94913042337524	1.82332023672946	5.59388664960128	3.69022553920417	4.02746461322586	3.11189635250947	2.80287218631356	3.69235024988362	1.37491774740674
% 1.90218412681054	3.14178067994592	4.81360249151853	0.166020257335807	3.15897474418708	3.70989427686149	3.29764578754312	0.629984390025039	0.205102573521217	6.12269956956359	4.35719677852454	0.510287573390106	5.52555912696036	3.65154139498896	5.25502630833601	4.62165756151938	2.16847507372636	0.957893762685828	1.49416523888684	3.71494524289821	0.0286410350303403	0.489989280171154	3.74915907411529	0.533968261232703	2.29380918954127	4.38320703785222	2.02578815947614	4.87431722515723	0.294062811849421	5.77938894115726	5.68979218532094	3.64783313528984	5.60531858926234	3.46689905154949	3.20512982395564	2.12747967173207	1.83506986122204	6.08554314029676	5.22011744687811	4.35803922667773	1.89967002731344	4.07455114348899	3.51962960946164	3.03235341949012	0.0149720677055920	1.67548344176422	0.132138774211473	3.27316310955398	3.29830922430154	3.91431981698280	1.07565410992948	2.60968507429950	1.85314350335889	6.24480590301484	1.26695666532643	1.16415818707759	0.733461407844536	4.49979191868938	3.86106047275062	0.960844090852191];
% phi_scatterer  = [5.40090396612946	3.35383288795388	2.34092533623959	5.19828100988437	3.39474255120246	4.61165003407274	3.12568788241954	1.82049222218581	3.64842340669147	4.73207774375627	3.09459848952632	0.300882951719095	2.47624061942739	2.99088091788938	1.21832013843227	5.79781689471689	5.91453586645695	2.66044435106078	4.03472297728050	0.581284658679523	3.28642619026738	0.395107717360935	3.74987540068178	1.01218704519217	5.84243702716872	5.96561759818577	5.35119980275370	5.84447931335418	4.58281383366253	2.51855469612389	2.31291885551459	5.57343028689460	1.90600508953091	5.51188691189951	2.49834512014781	4.62756941442131	0.734319099811169	4.26684796444278	3.62735349967687	0.209223225265966	5.68413556837127	5.91865531638913	5.44587454811180	1.51759069909963	0.712005275128005	0.897285781359277	4.06254890765928	4.22361131855846	2.19097754944352	4.64614555237697	6.24773750424332	3.76144704371852	3.21183809127163	0.0994136800993776	3.57601318880262	1.34540282452983	2.38149433593459	4.18684308862773	0.236115209052817	0.604867585824364
% 2.73707975980444	2.46570242473469	2.22193327764062	5.31916025610682	4.48993392857732	2.61977324432844	3.08325802619109	5.83031106157286	3.70013241040983	6.25860885965850	2.62647261368106	3.91788617886054	1.88273275679664	0.781106976107102	3.27753699456964	3.15626279183163	3.96018438158900	4.82462638835728	1.50240202695928	2.53478102272460	1.09744418424354	3.36424013480752	1.51177123819285	4.88040837229098	2.54671688782827	0.0434855857919520	1.05343821435149	4.14832010760053	1.38596119307855	3.75158849519317	2.11779524385370	0.444135107242198	2.10215523934240	2.09821126363306	4.11737313412605	2.24626135171222	4.65823520165431	4.42762069480624	1.61329962119541	6.13322603633164	5.33414715549059	2.81286108264723	5.21353278511686	1.75442491576206	2.97522029976747	4.60262326820783	3.12372753611701	3.89893919006294	3.58466546715603	4.11825749082577	3.76687559910941	6.05912857588045	4.50646156872899	0.437956054871667	5.21795937702166	2.69115959636573	1.25588147338671	1.74311146550554	2.47778969750666	3.99197204388237
% 0.356609708349417	5.71380867371063	3.58279790210591	0.135812910165351	4.26144343868694	5.44998231933653	6.26603237213848	4.55566289550805	2.56952259949209	3.02850914752370	2.66886030251403	6.25218185378361	2.46706548635087	0.542929314550973	2.02654654428573	1.07643349066408	2.08538010305252	4.30915273355835	2.88134108179827	3.02538289450199	1.61667376630212	1.06489416718751	0.664988756985839	2.35690024605212	3.03777451315573	2.22479234184400	4.30224624861182	3.42169199820335	2.69151328589013	1.66473510416971	4.11877787234086	0.550539365926562	0.455744134369856	1.89457260915818	3.69159112020019	6.22347515365810	4.78132217872244	5.94354118947739	4.42103818164914	2.21642896919094	5.97271917189520	0.0685798824960064	2.46456101333894	3.19143341703807	1.65696009209557	1.20799537185927	2.50619618114478	2.59373789815168	5.69759024333731	5.83460469488661	5.00144202018579	2.54761723292908	4.69665292481215	1.00500388081249	6.05742974164465	1.57797698281542	4.68632304398319	5.45455960841564	2.87567084000335	5.42063538582479
% 6.27317835635796	0.824298107860056	3.12431966986716	1.90262982530903	3.65519669466045	0.0233001991950523	6.26082792639526	4.34030223462964	5.14626540821630	5.59594167351569	3.41302309168083	1.38616954960921	1.52619329108600	1.22162344957225	5.61940848669914	3.12290687469466	5.68164270016643	5.17206813511371	2.61664725352997	2.19718925878188	0.916497212372733	3.32888681881804	1.45445774448206	3.23570105006971	0.392109767771263	5.40202607586519	2.75369443988907	2.46268495961818	0.824216624356781	5.48595315375830	3.02025197335440	5.02313589776878	0.870831017848244	4.31657949784171	6.04868948244401	3.45413741939785	4.51982979305297	1.73036344382018	1.94429527683666	1.28892847040170	3.02088745481477	2.01358546439306	3.35077124238081	3.83189091415447	1.46203430484066	0.923987504317849	4.68705599695870	3.79007799882536	2.88747276066487	1.88585630303229	1.31816160545490	3.52117030081516	0.483037457121282	0.883675635671339	4.17062106913212	5.78563274905748	1.07272046621159	2.30990016020523	3.61379338447269	3.02214090823556
% 5.88909771227909	5.32835296506222	4.07488984154395	5.05029016351151	4.17233678469218	5.23599899443764	0.584671654390115	0.795034168868352	3.36607364584604	6.22062352427953	0.663103927872122	1.02020780075451	1.15262892630187	1.44331727660608	5.31334304375247	2.52417204699253	3.95367881001622	1.72844407035232	1.60535929979720	0.856108752459659	2.85576623518679	6.16159800986633	5.51643572728127	3.21902814013977	0.908818954177520	5.41709521093391	0.762421182524535	4.63363569779834	2.96531796085913	2.87343677581951	3.07335006550158	5.09907979756019	5.72278361162650	3.78201465383965	0.803865564937365	5.74121965344964	1.07086116844543	3.42981449547542	4.49601200793597	0.555564077297825	2.81229499861101	0.452766118021925	3.01415252196806	2.50888489543877	5.50111780522490	0.0601695231899842	1.52276135695614	4.38733510915516	3.04787536560347	2.18035253462592	4.86953697227469	2.87304966355328	4.47772298482443	4.77574667999649	4.13123193321893	2.77474875396628	1.83965417079634	2.25197403839635	3.57587137060473	5.74980185810005
% 3.76488569987815	3.15898870442897	0.918330605681111	0.559085009992234	1.23873585363047	1.71372505429174	5.66126210188367	2.67240646952305	5.88751230100428	5.98642653910224	0.672137938592792	2.81352002881377	4.31311623464974	1.27740127694586	4.05870691564952	0.130336651190195	3.49880256364522	5.58705502990851	6.23201818919847	1.11768132230245	2.56838309333755	4.08764137932033	2.19844757382778	0.990792715221308	4.93746875749864	2.22438377420630	0.0161570678997604	3.40799036084031	4.02147077805481	1.20079933708619	4.39375935044757	0.985603878263687	4.45176775424129	1.98881286939982	2.21619066438734	4.75481913046159	0.390759659466279	5.04852603578598	2.36461126525722	1.69378358648796	3.56410970466238	0.538174168983433	6.03119281324560	4.78092394058936	0.785963102710485	2.03676678938312	2.40193640279746	2.50849256636491	5.39250100125476	5.71424526886536	5.02552471723622	2.37262052771980	1.24589178376345	5.63044401098138	4.64517188626453	4.39924955703021	2.58048055846212	4.45684076523417	1.12695163031786	3.25563965276654];
% eta = [-1.44534096307293e-07 + 1.13406214466999e-07i	1.34464581166418e-07 - 1.63237300084922e-07i	-1.55333232217099e-07 + 1.79192362005997e-07i	-9.32983603037892e-08 - 1.37479477526592e-07i	2.05391452504677e-07 + 3.25292467445410e-09i	-3.45484003361449e-07 - 2.49178132835729e-07i	-2.30280839283838e-07 - 3.45749413147064e-08i	1.50782138881704e-07 - 6.80804384377830e-08i	1.62610800938921e-07 + 2.08002473552263e-07i	-7.27009542131555e-08 - 9.86149039132169e-08i	6.75051689281359e-08 - 2.05086318356375e-07i	-5.54065149176526e-08 - 2.63982099437479e-08i	-6.04419209437416e-08 - 1.43867273523077e-07i	-2.25549546014262e-07 - 2.09442345770067e-07i	2.65351186591007e-07 + 1.04821142849145e-07i	-1.26386966910340e-07 + 1.35508483655823e-08i	5.87597077181139e-08 + 9.08315890481011e-08i	1.85950177434321e-07 - 2.06090158799470e-08i	7.39045436263347e-08 + 2.62596863066745e-07i	-8.80637375860847e-08 + 5.78457307870734e-08i	-9.42278351458869e-08 - 4.04993235750046e-08i	1.59592508609882e-07 - 9.91776833464392e-08i	9.51681373307534e-08 + 8.29822907592428e-08i	-2.79311786105034e-07 - 1.93060358363077e-08i	-2.28476637955521e-07 + 6.36651654756990e-08i	2.26381738340475e-07 - 2.17331994930552e-07i	-2.04046096176744e-07 - 2.37554746161248e-07i	2.00501534702238e-07 + 2.43361193319096e-07i	1.14697803171595e-07 - 8.96858350764998e-08i	-5.92497102973501e-08 + 9.81685751339947e-08i	1.83710543740672e-07 + 1.11484961241742e-07i	4.14986196320437e-07 + 1.70837118160895e-07i	8.12404733517884e-08 + 2.85621836477692e-07i	6.09353055258323e-08 + 2.46805790816812e-08i	2.06058802530367e-07 - 2.05576969111409e-07i	2.00778786589770e-07 + 8.89224717097247e-08i	3.51088826069260e-07 + 3.53685644452998e-08i	-1.84916236055855e-07 + 1.55643251767954e-08i	1.46328150910809e-07 - 2.53476741353070e-07i	5.54348120037160e-08 + 3.02144741042459e-07i	1.36676698604055e-07 - 1.62704668746292e-07i	-1.77246476840428e-07 + 5.66160492306393e-08i	-1.59897821516579e-07 - 2.55731659029625e-07i	-1.47871964575685e-07 + 5.28509356052336e-08i	-6.09081443059035e-08 - 4.70440095865365e-08i	-1.36936189521486e-07 - 5.34193815713976e-08i	2.64931039971934e-07 - 1.19930619302049e-08i	-1.10789088795228e-07 + 1.21657344431852e-07i	-3.76455852566192e-07 + 1.65182556584930e-07i	-2.68551704415355e-07 + 7.78457941246906e-08i	-1.98460296962270e-07 + 1.18194295073969e-07i	-1.19285705998292e-07 + 1.05336354645235e-07i	2.08570491430877e-08 - 1.12787102514520e-08i	-8.50015611303164e-08 - 1.89222573635869e-07i	-1.13247680233869e-07 - 4.69290977197785e-08i	-2.32210083116568e-08 + 3.82097613843205e-07i	1.41984729413605e-07 + 1.92662973177530e-07i	1.62601744510270e-07 + 3.61044168032671e-07i	9.17422869069708e-08 - 1.20304374553716e-07i	-2.65007521101541e-08 - 1.38961253781084e-07i
% -9.07594692345671e-08 + 1.50116171495734e-07i	-2.53148397940558e-07 - 1.45284556630087e-07i	8.41653659860670e-08 + 2.36599992914248e-07i	1.08000624078528e-07 - 1.19314375050021e-07i	1.36141707087385e-07 - 5.02169769025074e-08i	2.40456997639299e-08 + 2.17909561646713e-07i	3.09578730416472e-07 + 1.30994782419249e-07i	2.22295396711308e-07 - 2.08678597719465e-07i	1.53323943772284e-07 + 3.45370244864915e-07i	5.91446550372391e-08 - 9.88460215940264e-08i	-2.15111517899697e-07 + 7.27253745030828e-08i	1.79070259098991e-07 - 4.02970072927322e-08i	4.99509454638087e-08 + 3.00184800939991e-08i	-1.32863301755204e-07 - 2.35247270686804e-07i	1.07265846049984e-07 + 4.45159652468627e-08i	2.52948546700692e-07 - 5.41719493900841e-08i	-1.71106653081982e-07 + 1.57246761740069e-07i	2.23656477859586e-08 + 3.17914463005225e-07i	2.56832187639840e-08 - 9.72277466020106e-08i	-9.54076969048159e-08 + 2.00138349618832e-07i	4.55772811369779e-08 - 6.83219477055828e-08i	-2.88794827629425e-08 + 1.90025465843687e-07i	1.12298707848509e-07 - 9.63456144254118e-08i	4.69345862208275e-08 - 1.68106743852966e-07i	3.91939257311600e-08 + 7.69024046352387e-08i	6.43680104149775e-09 - 7.33019320840023e-08i	-6.64314475161972e-08 + 5.90097427684197e-08i	2.34983257915543e-08 + 1.13542895240287e-07i	-1.18191380640426e-07 + 2.39609330093063e-07i	3.44241003698537e-08 - 2.69060664434312e-07i	-1.65378504457632e-07 - 1.17791099638802e-07i	1.58852244912809e-07 + 6.20518045127828e-08i	3.12698958213200e-07 + 2.00445250348033e-07i	4.43188731439944e-08 - 1.25028114136927e-07i	-2.55198253688328e-07 + 2.46287258651632e-07i	1.13269513916131e-07 - 2.28258351847307e-08i	1.96540768324065e-08 - 2.53306999601363e-07i	1.44785532616342e-07 - 1.71234639377859e-07i	-9.37179935795184e-08 - 1.02487084096795e-08i	-7.26142433764898e-08 + 3.31939392623738e-07i	1.26257622867409e-07 - 3.15995631922171e-08i	3.71176663059880e-08 - 5.57567583577173e-08i	2.75986073691989e-07 + 8.82545209104237e-08i	-2.01630113886706e-07 + 1.04665949818506e-07i	7.64193321439850e-08 - 1.62125930631196e-08i	9.98035634045684e-08 + 1.41024479552122e-07i	7.68921148017422e-08 + 7.29452732480869e-08i	-5.89887289483667e-08 + 1.07634125130518e-07i	9.70962566965237e-08 - 4.48013615016043e-08i	5.17887270664182e-09 - 2.88044202343895e-08i	1.62620638807662e-07 - 7.30982696087130e-08i	-2.38202098823876e-07 + 2.40521834936865e-07i	2.12226212466514e-07 - 8.81318746459841e-08i	-5.65891034143470e-07 + 2.66133794553706e-07i	1.70150170532523e-08 - 1.21092938203770e-07i	3.82944756729676e-08 - 4.84114083704443e-08i	4.04957359692403e-08 + 1.08741187779321e-07i	7.08014746796278e-08 - 3.66343126965992e-07i	3.62040985462255e-08 + 2.03377420228130e-07i	1.91551892846180e-07 + 1.43183313663547e-08i
% -4.86166655258929e-08 + 5.36071560728930e-08i	-3.45952716808422e-08 - 2.47044093434839e-07i	1.61293213432784e-07 + 9.29016571971085e-08i	-5.15553220819759e-08 - 4.19749246770763e-08i	-1.27577216156214e-07 + 1.76426193944376e-08i	-1.64972340070633e-08 - 1.92403512861887e-08i	-6.22018258033422e-08 + 1.36046190432296e-07i	2.25782634329838e-08 - 1.42388588709904e-07i	-2.99016826251193e-07 - 4.49451623728871e-08i	-2.04420682702224e-07 + 1.33094072215752e-07i	-2.38706611093240e-07 + 2.45295424764067e-08i	1.73182487866628e-08 + 1.26306222319389e-07i	-6.01960511126908e-08 - 7.87597723852857e-08i	-3.50941213186684e-08 + 4.12055571470908e-07i	-2.26435577405299e-07 - 5.11224535812974e-08i	-2.41960899389778e-07 + 1.04610247150669e-07i	-1.66277448606553e-07 - 1.73406079834084e-07i	8.04465079114279e-08 - 3.24087655922066e-07i	-4.23312561057123e-08 - 2.39549686708302e-07i	-1.53277924629505e-08 - 2.27989410352384e-07i	1.06105820323910e-07 - 3.05081318491207e-09i	-2.90816592642359e-08 + 9.81116898392793e-08i	1.49317521545776e-07 - 2.06154446449468e-07i	-6.41543304394702e-08 + 3.11144717114548e-07i	-1.75337067184518e-08 + 8.69347769308667e-08i	-1.44860619163782e-07 - 8.93296428366255e-08i	2.26006805046770e-07 - 3.12102635513711e-08i	-2.69672142391457e-08 + 1.14453616712474e-07i	2.16607927088745e-07 + 3.16036653479360e-07i	1.63101925378030e-07 - 4.93377672585234e-08i	7.61488744461152e-08 + 2.27404512488256e-07i	1.22753452763170e-07 + 3.28366706153537e-07i	1.61383937278476e-07 + 8.78520926644522e-08i	-2.70107423152356e-07 + 1.33657015335180e-07i	-1.28468902886659e-08 + 2.06317717892084e-07i	5.27393091452129e-08 + 2.38253426605107e-07i	2.53337653825935e-07 - 8.60348358320968e-08i	5.78320960684698e-08 - 2.08812679440328e-07i	1.95554019968044e-07 - 8.67484860020419e-08i	2.19552899933478e-08 - 7.27366102181370e-08i	5.42840636935371e-08 + 2.98406952594152e-07i	3.03395456210307e-08 - 2.09322782679508e-07i	7.09016067997292e-08 + 5.65528320988359e-08i	2.98983931119728e-08 + 5.35188336700806e-08i	9.79962644220231e-08 + 1.46851287799994e-07i	-2.10826459570757e-07 - 2.02025023328302e-07i	3.31475567555493e-07 - 1.00343650466536e-08i	-7.35087329367404e-08 + 8.92642311714095e-08i	1.21385066377492e-07 - 2.88770363049369e-07i	-9.99514298280494e-08 + 4.79227524603314e-08i	2.00082109554456e-07 - 1.36807584617670e-07i	3.10275740256337e-07 - 1.63770422661563e-07i	-2.54238706997752e-07 + 5.76637371050549e-08i	-7.53253959984438e-08 - 2.24172876643264e-07i	-1.36233193062703e-08 - 4.82846119431112e-09i	-8.30257733748822e-08 + 2.96761656185378e-08i	-2.73138446050803e-07 + 1.94017786135058e-07i	-6.18639883551632e-08 - 1.64234383550197e-07i	5.38331516529823e-09 - 1.93649853529785e-07i	5.55111219910180e-08 - 1.71753000919167e-07i
% 7.69244226938095e-08 - 1.40136502812816e-08i	-1.65171943580316e-08 - 1.79878041198882e-07i	8.07816064158380e-08 + 2.98151543663162e-07i	1.67213604896830e-07 - 2.88211229677416e-08i	2.53643659735766e-08 - 1.79437409637440e-07i	-1.61809987179714e-07 - 4.90869183818599e-08i	-2.50813401637876e-08 - 2.91349661056285e-08i	7.29354336821335e-08 - 1.00874567642768e-07i	1.05019572940797e-08 + 1.80415743376974e-07i	1.28484143536497e-07 - 1.96998267416505e-07i	-2.78532864925462e-08 - 3.07141891386828e-07i	-7.01426485227665e-08 + 1.35820598802832e-07i	2.15430544807522e-08 - 1.53678658536825e-08i	2.66682960180979e-07 - 9.06898064267506e-08i	6.82078341265216e-08 - 6.95529227651572e-08i	8.49200529318133e-08 - 1.23240299037370e-07i	1.27324554023215e-07 - 8.92497384052770e-08i	-2.10697344148762e-07 - 1.13395749285286e-07i	5.75898990771759e-08 + 6.67617746477744e-08i	7.62063687018968e-08 - 1.22194809554008e-07i	3.45153622244890e-07 - 1.73833420959445e-07i	2.30003491801460e-07 - 1.32932693157314e-07i	3.47173771870223e-07 - 2.56709359226283e-07i	2.21188329189997e-07 - 9.15407969961711e-08i	-3.95990286535645e-07 - 3.56062892677753e-08i	-7.68939933842584e-08 + 9.38035834312898e-08i	-1.95698975963372e-07 + 5.08902435925679e-08i	2.29165702663178e-07 + 1.51567069696735e-07i	2.06075334138975e-07 - 5.69135615113443e-08i	-9.02047913483090e-08 + 8.25071211561170e-08i	-5.25681001375447e-08 + 1.03655454189156e-08i	3.42591553603205e-07 - 1.53762679511007e-07i	4.89536440270051e-08 - 1.13734337039435e-07i	2.10050302093266e-08 + 7.07553461635794e-08i	9.29651295723799e-08 + 1.90018315787332e-07i	2.45630220707215e-07 + 1.59056826851264e-08i	2.95322809952904e-07 - 1.82201274506387e-07i	1.23570002274980e-07 - 1.59696923205206e-07i	1.60939809646947e-07 + 2.48784423972158e-09i	-2.60674916207598e-07 - 4.94974136974267e-08i	-2.53840767810438e-07 - 9.01038537980779e-08i	2.90941022945989e-07 - 7.29917843831478e-08i	1.92237616711093e-07 + 1.74204799405048e-07i	6.25224805621198e-09 + 1.68137794058616e-07i	3.23453973353828e-07 - 3.25254327047454e-08i	-1.54173396677174e-07 - 1.28752837068229e-07i	-5.71349387725141e-09 - 7.11132534912431e-08i	1.54961196021439e-07 - 3.59932915896345e-07i	1.27787241801161e-07 + 2.31006428401225e-08i	-1.48650978275512e-07 + 1.27229016247973e-08i	-2.05021621405478e-07 + 3.79435646151836e-08i	2.63049599836222e-07 + 6.62746603213863e-08i	3.81477574685881e-08 + 2.97199008014765e-07i	-1.55835150758640e-07 + 6.37355818415662e-08i	-1.99603624284029e-07 + 2.25125733979357e-07i	-2.07298791570529e-08 + 2.06411707941556e-07i	-1.14830673930604e-07 - 6.44736971616738e-08i	5.25017086985120e-08 + 3.53970601451175e-08i	8.14216302032175e-08 + 9.45397150594331e-08i	2.59494690991424e-07 - 1.78996916512671e-07i
% -5.93671348289937e-08 + 4.14150690363105e-07i	5.14726011858296e-08 - 1.53614857592012e-07i	-7.97334098964695e-08 + 2.69650042433270e-07i	-9.97793530382602e-08 + 1.05675745300817e-08i	-2.85779557016224e-08 - 3.82097219375174e-07i	9.86599231167125e-08 + 5.75056250764212e-08i	4.62951417488566e-08 + 7.44016865984779e-08i	-3.22512663866332e-09 - 2.49762718951005e-07i	-3.14062029760054e-07 + 2.09353513069384e-07i	2.28620672734806e-07 + 2.36513271964060e-07i	-9.62034986347964e-08 + 6.47087409738699e-08i	2.21038046977410e-07 - 1.16259497812658e-07i	-1.39447194099589e-07 - 3.98578679067354e-07i	-2.65096007093485e-08 - 1.13500929420741e-07i	1.10115764934200e-07 + 1.76175916597590e-07i	5.24834929767966e-08 + 3.26383017399937e-07i	-1.45549605786134e-07 - 1.18721264534841e-07i	1.26742551612136e-07 - 2.93477222093443e-07i	-1.20489550487028e-07 + 3.28307821789677e-08i	-5.75398680959112e-08 - 1.23266501085406e-08i	-1.31844623473816e-07 + 9.41520189159750e-08i	1.10259879318416e-07 + 1.03996539324072e-07i	4.59234970986664e-07 + 3.35897159335711e-08i	-1.55788745464984e-07 + 5.56570491601199e-08i	2.03556777716797e-08 + 2.56109066970159e-07i	-4.82432916709240e-08 + 8.65113843280282e-08i	-1.01501211811643e-07 + 6.59623687371919e-08i	-1.11330962424220e-07 + 1.24895437116776e-07i	1.13531522868375e-07 - 8.93220606904981e-09i	1.08904006133301e-08 + 5.92347813784671e-08i	-1.57554029683519e-07 + 5.04634095915937e-08i	-1.41335726364303e-07 + 1.32002782202521e-07i	-3.25142461111599e-07 + 2.60859481212374e-07i	-1.32607555181789e-07 - 1.31826318746775e-07i	-1.66056930286756e-07 + 2.79392941129332e-07i	-4.13079427976678e-08 - 4.41971445128053e-08i	1.00763454358027e-07 + 1.30696647569395e-07i	-2.05351071742506e-08 - 1.13423023047306e-07i	1.67907080678281e-07 - 2.54332582469967e-07i	-2.30907467123953e-07 + 2.14571602149522e-07i	-4.15972516002014e-07 - 1.14106756644366e-07i	-1.47268567610637e-07 + 5.16363553134324e-08i	-1.65479211390314e-07 + 8.74368633824730e-08i	-2.01149409089109e-07 - 1.72278950996491e-08i	2.41021516300337e-08 + 1.77849930795035e-07i	-1.18169028180403e-07 + 4.54130309430335e-08i	-8.21702809300242e-08 - 3.00411476581443e-08i	-5.65726122670875e-08 + 3.82549073485692e-08i	-6.42039864600337e-08 - 1.82155489334541e-07i	1.62424472058136e-07 - 1.28015791935848e-07i	-1.45019699144897e-07 + 2.24480398628653e-08i	3.01072433794966e-07 + 1.72515944192963e-07i	1.68181967821041e-07 + 8.57599643342319e-09i	-9.56652258343598e-08 + 2.33202064122424e-07i	4.72824715990679e-08 + 7.65447313737495e-08i	3.33542222641951e-07 + 5.70578869792209e-08i	1.25845724340907e-07 + 1.78201642964648e-08i	1.50932553144923e-07 + 2.29416727415853e-07i	-1.59644142117595e-07 + 9.85617415255620e-08i	3.50464086853780e-07 + 1.80805392068959e-07i
% 2.64576469319087e-07 + 4.71874159141693e-08i	3.91464271488611e-07 + 2.05315358143374e-08i	-4.14769411165632e-07 + 2.38167784973303e-08i	8.76812105420789e-08 - 9.13054739099966e-08i	-6.55857310380430e-09 + 3.58048110073939e-08i	1.90337801489222e-07 - 3.04379619586545e-08i	1.53698581880117e-07 + 7.42776245947875e-08i	2.24680719927811e-07 - 2.73389454894298e-07i	-3.89483553068535e-09 - 3.99020154599783e-08i	-4.22098745208053e-08 - 9.51215086976056e-08i	-1.49442098052303e-07 + 1.38983386740243e-07i	4.47383416281654e-09 - 1.73306747535294e-08i	-2.04158355743247e-07 + 2.23587907829472e-07i	2.47435837885599e-07 + 2.66363496345458e-07i	9.58587473775085e-08 - 2.27558570590236e-07i	4.11746811883075e-08 + 1.44207888401034e-07i	-2.05781559343286e-07 - 2.36908442313161e-07i	-8.96268051828001e-08 + 5.78543904888415e-08i	1.71037877302749e-07 + 6.60713911210127e-08i	2.88659350296360e-07 - 3.07233485967711e-08i	-3.31580283977648e-08 + 3.62902568263859e-08i	-1.85255418354570e-07 - 1.97874163076913e-07i	-1.98973797756540e-07 + 4.55511117097953e-09i	7.32906873176333e-08 - 2.44960876208891e-07i	3.74724008166973e-07 + 8.88080743612697e-08i	8.02593117385235e-08 - 4.19518636127489e-08i	-3.94861909284382e-09 - 2.80833641534670e-07i	-6.64120694797395e-08 + 1.68013996060008e-07i	-1.02895215762378e-07 + 1.52973864950199e-09i	-2.58007393361259e-07 - 1.90820106052160e-07i	-1.67545354219326e-08 - 9.47402606990863e-08i	-3.07619041145536e-08 - 1.91405333224958e-07i	8.09796760709839e-08 - 3.69240295428140e-07i	-2.87578576110820e-07 + 2.23339894693095e-07i	-1.18464801155305e-07 + 6.13359987003097e-08i	2.17749932163994e-08 - 1.24644314375869e-07i	-3.77845710295159e-08 - 1.01609626895708e-07i	2.83703281841083e-07 - 1.08629595329262e-07i	2.19919000572272e-08 + 1.88421322735593e-07i	3.58309759404669e-08 - 9.53397104129799e-08i	2.15357175946029e-07 - 6.26558914793145e-08i	2.05576211271817e-07 + 1.86641813884084e-07i	-1.96468004859275e-07 + 1.84712109014338e-07i	1.21879968622728e-07 - 7.24611818529104e-09i	2.08982583340503e-07 - 8.12990153790251e-08i	-1.09106167187368e-08 - 8.79788602545949e-08i	-3.72957767466029e-08 + 9.41367195810330e-10i	8.67475686699611e-08 + 3.32976061459823e-08i	8.93259554809148e-08 + 6.78532901244646e-08i	1.61074594662808e-07 + 2.98139111462182e-08i	-7.36654527345754e-08 + 1.25370329782070e-07i	-6.06267176847159e-08 - 2.32219731556976e-08i	-1.50360211321486e-07 + 4.35196176414651e-08i	-1.48593651406663e-07 + 5.59033065444281e-07i	-2.73812704386859e-07 + 1.01912112138839e-07i	-1.83501082361398e-07 + 1.55811422144412e-07i	9.51871335622418e-08 - 3.39535970246064e-08i	1.09912401787659e-08 - 8.36295040566405e-08i	8.14152929327527e-08 - 7.25666090164207e-09i	-1.84826575411140e-07 - 3.57682266889165e-07i];
% 



%% 生成无线信道
% LoS链路信道
for k = 1:K
    for b = 1:B
        h{k,b} = sparse(M,1);%%%%%%%%%%%%%%%%%%%%%注意
            e0{k} = [ sin(phi(k)) * cos(theta(k)) ; sin(phi(k)) * sin(theta(k)) ; cos(phi(k)) ];
            % e = Rot_Matrix{b}.' * e0;
            if dot( normal_vector{b} , e0{k} ) > 0
                Lambda_LoS(k,b) = 1;
            else
                Lambda_LoS(k,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(K_rice/(K_rice+1)) * sqrt(M) * sqrt(Omega(k,b)) * Lambda_LoS(k,b) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e0{k} ) );
    end
end

%% 测试
for b = 1:B
    Px{b}    = dx * Rot_Matrix{b} * [1;0;0];
    Py{b}    = dy * Rot_Matrix{b} * [0;1;0];
    T{b}     = exp( 1j * 2*pi/lambda * ( kron( delta_x * ( Px{b}.' * e0{1} ) , ones(1,My) ) + kron( ones(Mx,1) , delta_y.' * ( Py{b}.' * e0{1} ) ) ) );

end








for k = 1:K
    for b = 1:B
        % h{k,b} = 0;%%%%%%%%%%%%%%%%%%%%%注意
        for iota = 1:IOTA
            % eta(k,iota,b) = 1/sqrt(IOTA) * Omega(k,b) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
            e1{k,b} = [ sin(phi_scatterer(k)) * cos(theta_scatterer(k)) ; sin(phi_scatterer(k)) * sin(theta_scatterer(k)) ; cos(phi_scatterer(k)) ];
            % e = Rot_Matrix{b}.' * e;
            if dot( normal_vector{b} , e1{k,b} ) > 0
                Lambda(k,iota,b) = 1;
            else
                Lambda(k,iota,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(1/(K_rice+1)) * sqrt(M) * sqrt(Omega(k,b)) * Lambda(k,iota,b) * eta(k,iota) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e1{k,b} ) );
        end
    end
end
% for k = 1:K
%     H{k} = [];
%     for b = 1:B
%         H{k} = [H{k} ; h{k,b} ];
%     end
% end








end