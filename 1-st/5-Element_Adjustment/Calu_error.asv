% 6DMA
clc;clear;
kappa0 = 5;
parfor i = 1:10000

Pt = 40;
Ptx = 10^( (Pt - 30)/10 ); sigma0 = 1e-8; R00 = 1;


format long

% %% ****************************************初始化参数************************************************************************************************************************************************************
for nummmmmm = 1
    % Ptx = 10;
    fc = 30e9;   %载波频率
    c = 3e8;      %光速
    lambda = c/fc;   %波长；
    dx = lambda/4;   %x轴方向天线间隔
    dy = lambda/4;  %y轴方向天线间隔
    Mx = 32; My = 32; M = Mx * My;
    Q  = 1; %每个全息超表面馈源个数
    Dx = Mx * dx;   Dy = My * dy;
    K_rice = 5;
    K = 6; %用户个数
    B = 6; %全息超表面个数，每个全息超表面上配备有M个元素
    NUM_Position = 100; %6DMA空间位置
    delta_x = ( 2 * [0:(Mx-1)].' - Mx + 1 )/2; delta_y = ( 2 * [ 0 : ( My - 1 ) ].' - My + 1 )/2;
    % delta_x = [0:(Mx-1)].';   delta_y = [0:(My-1)].';
    % Coor_Ele_init = [ kron( ones(My,1) , delta_x*dx ) , kron( delta_y*dy , ones(Mx,1) ) , zeros(M,1)  ];  %辐射元素坐标
    Coor_Ele_init = [ kron( delta_x*dx , ones(My,1) ) , kron( ones(Mx,1) , delta_y*dy ) , zeros(M,1)  ];  %辐射元素坐标
    dmin = 0.1;
% figure(1); plot( Coor_Ele_init(:,1) , Coor_Ele_init(:,2) , 'o' )
% % 
%% 引入全息超表面传输模型
Coor_Feed    = [ 0.002984305671304 , 0.001586131606604 , 0 ];   %馈源坐标
% Coor_Feed    = [ 0 , 3.838239570983593e-04 , 0 ];
Dis_Feed2Ele = sqrt( ( Coor_Ele_init - Coor_Feed ).^2 * ones(3,1) );    %馈源到元素的距离
V_F          = exp( - 1j * 2*pi*sqrt(3)/lambda * Dis_Feed2Ele );    %馈源响应向量
end



for  num = 1 : 1
%% 6DMA初始空间姿态
% Coor_Ele表示6DMA天线坐标，normal_vector是UPA的法向量
[ Coor_Ele , normal_vector , Rot_Matrix ] = Orientation_Initial(B,Coor_Ele_init,0);
%% 针对初始6DMA位置，生成无线信道
[ h , e0 , theta0, phi0 , theta_scatterer0 , phi_scatterer0 , Iota , eta , Omega ] = Channel_Generation_init( K,B,M,Mx,My,normal_vector,K_rice,Coor_Ele,lambda , Rot_Matrix );
%% 生成全息感知
[ error_theta , error_phi , error_varphi , est_direc_vector_rec , Rot_Matrix , normal_vector_rot ] = Sensing_Holographic_HalfWave1(B,M,Mx,My,lambda,delta_x,delta_y,dx,dy,K,h,Rot_Matrix,e0,kappa0);
% est_direc_vector_rec：指向用户的方向向量
% normal_vector_rot：全息超表面的法向量
% Rot_Matrix：旋转矩阵
end

error_theta0(:,i) = error_theta;
error_phi0(:,i) = error_phi;
error_varphi0(:,i) = error_varphi;

end

% ( sum(sum( error_theta0.^2 )) + sum(sum( error_phi0.^2 )) + sum(sum( error_varphi0.^2 )) ) / ( numel(error_theta0) + numel(error_phi0) + numel(error_varphi0) )
error_sen = [ error_theta0 + error_phi0 + error_varphi0 ];

num = 1;
Fre = [];
for epsilon = 0 : pi/128 : pi
    Fre(num) = numel( find( abs(error_sen) <= epsilon ) );
    num = num + 1;
end
Fre = Fre / numel( error_sen );
figure;plot( 0 : pi/128 : pi , Fre , '-' , 'linewidth' , 2 )
% 0 : pi/128 : pi
Fre1 =  [0	0.435000000000000	0.682300000000000	0.796833333333333	0.838733333333333	0.852466666666667	0.858133333333333	0.861133333333333	0.864666666666667	0.867866666666667	0.871233333333333	0.874166666666667	0.876966666666667	0.880233333333333	0.883833333333333	0.886933333333333	0.889700000000000	0.892766666666667	0.895600000000000	0.897733333333333	0.900833333333333	0.903300000000000	0.906033333333333	0.908900000000000	0.911066666666667	0.913666666666667	0.915566666666667	0.917866666666667	0.920133333333333	0.922666666666667	0.925533333333333	0.927900000000000	0.930200000000000	0.932166666666667	0.934433333333333	0.936400000000000	0.938666666666667	0.940233333333333	0.942233333333333	0.944300000000000	0.946033333333333	0.947700000000000	0.949233333333333	0.950466666666667	0.952233333333333	0.953533333333333	0.955133333333333	0.956766666666667	0.958033333333333	0.959300000000000	0.960333333333333	0.961600000000000	0.962366666666667	0.963466666666667	0.964666666666667	0.965933333333333	0.966733333333333	0.967866666666667	0.968966666666667	0.969900000000000	0.970666666666667	0.971500000000000	0.972400000000000	0.973400000000000	0.974133333333333	0.974700000000000	0.975800000000000	0.976500000000000	0.977033333333333	0.977900000000000	0.978800000000000	0.979500000000000	0.979933333333333	0.980600000000000	0.981066666666667	0.981666666666667	0.982200000000000	0.982766666666667	0.983400000000000	0.984066666666667	0.984633333333333	0.985200000000000	0.986033333333333	0.986500000000000	0.987066666666667	0.987500000000000	0.987766666666667	0.988500000000000	0.989000000000000	0.989466666666667	0.990033333333333	0.990466666666667	0.991200000000000	0.991633333333333	0.992033333333333	0.992400000000000	0.992733333333333	0.993000000000000	0.993433333333333	0.993666666666667	0.993900000000000	0.994166666666667	0.994433333333333	0.994533333333333	0.995133333333333	0.995433333333333	0.995533333333333	0.995866666666667	0.996033333333333	0.996133333333333	0.996433333333333	0.996800000000000	0.997166666666667	0.997333333333333	0.997466666666667	0.997666666666667	0.997866666666667	0.998033333333333	0.998166666666667	0.998433333333333	0.998633333333333	0.998833333333333	0.999233333333333	0.999366666666667	0.999433333333333	0.999600000000000	0.999733333333333	0.999833333333333	0.999866666666667];

Fre2 =  [0	0.433583333333333	0.685777777777778	0.798416666666667	0.842250000000000	0.856416666666667	0.862944444444444	0.867555555555556	0.872138888888889	0.876722222222222	0.881222222222222	0.885194444444444	0.888805555555556	0.892361111111111	0.896138888888889	0.899500000000000	0.903000000000000	0.906222222222222	0.909583333333333	0.913500000000000	0.916888888888889	0.920222222222222	0.923000000000000	0.926416666666667	0.929666666666667	0.932277777777778	0.934472222222222	0.937027777777778	0.939611111111111	0.941666666666667	0.943722222222222	0.945916666666667	0.947805555555556	0.949638888888889	0.951944444444445	0.954083333333333	0.955888888888889	0.957722222222222	0.959194444444445	0.960555555555556	0.962111111111111	0.963444444444444	0.964916666666667	0.966305555555556	0.967694444444444	0.968777777777778	0.970055555555556	0.970888888888889	0.971944444444445	0.973194444444445	0.974250000000000	0.975055555555556	0.975972222222222	0.976722222222222	0.977777777777778	0.978722222222222	0.979555555555556	0.980111111111111	0.980805555555556	0.981388888888889	0.981972222222222	0.982666666666667	0.983305555555556	0.983750000000000	0.984194444444445	0.984666666666667	0.985027777777778	0.985416666666667	0.985944444444444	0.986388888888889	0.986805555555556	0.987250000000000	0.987750000000000	0.988222222222222	0.989027777777778	0.989388888888889	0.989833333333333	0.990083333333333	0.990250000000000	0.990750000000000	0.991083333333333	0.991388888888889	0.991833333333333	0.992027777777778	0.992444444444445	0.992833333333333	0.993194444444445	0.993555555555556	0.993833333333333	0.994027777777778	0.994305555555556	0.994555555555556	0.994611111111111	0.994638888888889	0.994805555555556	0.995111111111111	0.995250000000000	0.995444444444445	0.995722222222222	0.995944444444444	0.996250000000000	0.996555555555556	0.997000000000000	0.997277777777778	0.997416666666667	0.997583333333333	0.997694444444444	0.997805555555556	0.998000000000000	0.998111111111111	0.998166666666667	0.998222222222222	0.998583333333333	0.998750000000000	0.998944444444444	0.999027777777778	0.999111111111111	0.999166666666667	0.999222222222222	0.999333333333333	0.999416666666667	0.999583333333333	0.999611111111111	0.999666666666667	0.999777777777778	0.999805555555556	0.999888888888889	0.999916666666667	0.999916666666667];

Fre3 =  [0	0.0122000000000000	0.0222000000000000	0.0320833333333333	0.0421333333333333	0.0527500000000000	0.0632333333333333	0.0740333333333333	0.0856333333333333	0.0964500000000000	0.107266666666667	0.117316666666667	0.126500000000000	0.135133333333333	0.143933333333333	0.152783333333333	0.162450000000000	0.171333333333333	0.180383333333333	0.189333333333333	0.196800000000000	0.203516666666667	0.210666666666667	0.217916666666667	0.224800000000000	0.232416666666667	0.239116666666667	0.245266666666667	0.251616666666667	0.258133333333333	0.264866666666667	0.271633333333333	0.278083333333333	0.285783333333333	0.293600000000000	0.301200000000000	0.308683333333333	0.315900000000000	0.323500000000000	0.331883333333333	0.338600000000000	0.345566666666667	0.353083333333333	0.360216666666667	0.367400000000000	0.374266666666667	0.380850000000000	0.388116666666667	0.395133333333333	0.402316666666667	0.409533333333333	0.416933333333333	0.424383333333333	0.430766666666667	0.437500000000000	0.444516666666667	0.452216666666667	0.458983333333333	0.465450000000000	0.472183333333333	0.478500000000000	0.487666666666667	0.497250000000000	0.507200000000000	0.516166666666667	0.525316666666667	0.536866666666667	0.548716666666667	0.560666666666667	0.569633333333333	0.576966666666667	0.586450000000000	0.595566666666667	0.606600000000000	0.618950000000000	0.633200000000000	0.648633333333333	0.663716666666667	0.677033333333333	0.687850000000000	0.699566666666667	0.712116666666667	0.724066666666667	0.735166666666667	0.744650000000000	0.755200000000000	0.766783333333333	0.777566666666667	0.788816666666667	0.800166666666667	0.809550000000000	0.817516666666667	0.825600000000000	0.834033333333333	0.841133333333333	0.848916666666667	0.856783333333333	0.864450000000000	0.871783333333333	0.880783333333333	0.890100000000000	0.897566666666667	0.904083333333333	0.910750000000000	0.916750000000000	0.923083333333333	0.928716666666667	0.934116666666667	0.939300000000000	0.944300000000000	0.948683333333333	0.952383333333333	0.956200000000000	0.959983333333333	0.964500000000000	0.968216666666667	0.970633333333333	0.972766666666667	0.974650000000000	0.976950000000000	0.978850000000000	0.981816666666667	0.984483333333333	0.986716666666667	0.988416666666667	0.989800000000000	0.990966666666667	0.991650000000000	0.992550000000000]
Fre4 =  [0	0.0109000000000000	0.0221166666666667	0.0335666666666667	0.0461500000000000	0.0577500000000000	0.0699000000000000	0.0823000000000000	0.0932500000000000	0.104183333333333	0.114833333333333	0.125083333333333	0.135666666666667	0.145550000000000	0.155833333333333	0.166250000000000	0.176100000000000	0.186533333333333	0.197600000000000	0.208283333333333	0.218700000000000	0.229900000000000	0.240800000000000	0.252450000000000	0.263950000000000	0.274533333333333	0.285800000000000	0.296333333333333	0.307650000000000	0.318133333333333	0.328966666666667	0.339483333333333	0.349566666666667	0.359350000000000	0.369283333333333	0.378566666666667	0.388050000000000	0.398100000000000	0.409066666666667	0.420800000000000	0.432416666666667	0.443966666666667	0.453000000000000	0.461816666666667	0.470133333333333	0.478616666666667	0.487683333333333	0.497533333333333	0.507116666666667	0.516400000000000	0.524883333333333	0.533166666666667	0.541400000000000	0.550966666666667	0.559166666666667	0.567483333333333	0.575633333333333	0.583133333333333	0.591233333333333	0.599216666666667	0.607000000000000	0.616000000000000	0.624183333333333	0.631566666666667	0.639516666666667	0.648200000000000	0.656666666666667	0.666200000000000	0.676133333333333	0.685316666666667	0.693850000000000	0.701833333333333	0.709716666666667	0.716250000000000	0.722783333333333	0.728616666666667	0.734950000000000	0.741666666666667	0.750750000000000	0.760166666666667	0.768633333333333	0.777333333333333	0.785183333333333	0.792566666666667	0.800616666666667	0.809083333333333	0.816850000000000	0.823183333333333	0.830233333333333	0.835666666666667	0.841033333333333	0.846550000000000	0.851950000000000	0.857716666666667	0.862816666666667	0.868066666666667	0.872950000000000	0.878133333333333	0.882666666666667	0.887266666666667	0.891166666666667	0.894466666666667	0.898916666666667	0.903316666666667	0.907716666666667	0.912500000000000	0.917400000000000	0.922550000000000	0.927566666666667	0.931950000000000	0.935750000000000	0.939850000000000	0.943966666666667	0.947883333333333	0.952300000000000	0.956450000000000	0.960316666666667	0.962966666666667	0.966650000000000	0.970200000000000	0.973050000000000	0.975450000000000	0.977900000000000	0.980083333333333	0.981683333333333	0.983616666666667	0.985000000000000	0.986583333333333	0.988166666666667];

Fre5 =  [0	0.0128166666666667	0.0263333333333333	0.0394333333333333	0.0521833333333333	0.0646000000000000	0.0768666666666667	0.0904166666666667	0.104033333333333	0.116750000000000	0.130533333333333	0.143883333333333	0.156900000000000	0.169733333333333	0.182766666666667	0.195466666666667	0.207333333333333	0.219933333333333	0.232466666666667	0.245666666666667	0.258016666666667	0.270900000000000	0.283083333333333	0.295050000000000	0.306816666666667	0.316783333333333	0.327066666666667	0.337116666666667	0.347850000000000	0.358216666666667	0.368583333333333	0.378933333333333	0.388366666666667	0.398766666666667	0.408333333333333	0.418166666666667	0.427516666666667	0.436850000000000	0.446283333333333	0.454950000000000	0.463483333333333	0.472700000000000	0.480683333333333	0.489133333333333	0.497866666666667	0.506500000000000	0.515266666666667	0.524550000000000	0.533583333333333	0.542566666666667	0.551833333333333	0.560000000000000	0.568133333333333	0.576683333333333	0.585966666666667	0.594633333333333	0.602866666666667	0.611500000000000	0.619700000000000	0.628183333333333	0.635816666666667	0.643383333333333	0.651850000000000	0.659566666666667	0.667166666666667	0.674733333333333	0.682483333333333	0.690383333333333	0.699000000000000	0.707650000000000	0.716100000000000	0.723850000000000	0.731366666666667	0.738616666666667	0.746350000000000	0.753183333333333	0.759766666666667	0.766250000000000	0.771983333333333	0.778316666666667	0.784233333333333	0.790533333333333	0.797000000000000	0.802733333333333	0.808750000000000	0.814716666666667	0.821350000000000	0.828066666666667	0.834466666666667	0.840416666666667	0.846483333333333	0.852450000000000	0.858050000000000	0.863716666666667	0.869050000000000	0.873850000000000	0.879166666666667	0.884183333333333	0.888683333333333	0.894066666666667	0.898550000000000	0.903733333333333	0.908700000000000	0.913700000000000	0.919066666666667	0.923866666666667	0.928400000000000	0.932233333333333	0.936900000000000	0.941216666666667	0.945050000000000	0.948400000000000	0.952133333333333	0.955266666666667	0.958400000000000	0.961500000000000	0.964233333333333	0.966983333333333	0.969783333333333	0.972666666666667	0.975100000000000	0.977533333333333	0.979566666666667	0.981750000000000	0.984083333333333	0.986316666666667	0.988716666666667	0.990483333333333	0.991900000000000];

figure(5); plot(0 : pi/128 : pi , Fre1 , '-' , 0 : pi/128 : pi , Fre2 , '--'  , 0 : pi/128 : pi , Fre3 , '*'  , 0 : pi/128 : pi , Fre4 , '+' , 0 : pi/128 : pi , Fre5 , ':'  )



