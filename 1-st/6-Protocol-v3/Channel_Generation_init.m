function [ h , e0 , theta, phi , theta_scatterer , phi_scatterer , IOTA , eta , Omega ] = Channel_Generation_init( K,B,M,Mx,My,normal_vector,K_rice,Coor_Ele,lambda , Rot_Matrix )

    dx = lambda/4;   %x轴方向天线间隔
    dy = lambda/4;  %y轴方向天线间隔
    delta_x = ( 2 * [0:(Mx-1)].' - Mx + 1 )/2; delta_y = ( 2 * [0:( My-1)].' - My + 1 )/2;
%% 针对初始6DMA位置，生成无线信道
PL    = 32.4 + 17.3 * log10( 6.5 ) + 20 * log10( 30 ) - 26 ; % Path-loss,包含20dB天线增益
Omega = 10^( -PL/10 ) * ones(K,B);  % path-loss
IOTA  = 10;         % 散射体数量
theta =  rand(K,1) * 2 * pi; phi = rand(K,1) * 2 * pi; % K个用户的水平角和俯仰角
% theta = 5.263863993147139 ; phi =  1.057064847365129;
theta_scatterer = rand(K,IOTA) * 2 * pi; phi_scatterer = rand(K,IOTA) * 2 * pi; % K个用户的水平角和俯仰角
% NLoS链路信道
for k = 1:K
    for iota = 1:IOTA
        eta(k,iota) = 1/sqrt(IOTA) * Omega(1) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
    end
end

theta = [0.565519373541736
3.35612938001262
1.53997022006936
3.83869666134519];
phi = [4.28223689705266
6.11033266142565
4.43471342237926
0.0249912285233370];

theta_scatterer = [4.92161049393014	0.686640010956813	5.25960342178566	0.103270644633855	0.418586117595609	3.55718052529078	6.14090482108803	4.20909297968730	5.72247186169566	0.888407834124988
6.20040675268787	1.86143045313854	0.478676350799053	0.726544459610244	0.216296782114423	5.54968390113794	4.13617077344450	0.745067640554167	2.99406134681042	4.60594187236572
5.52965507317181	5.58095651284158	5.58147546094972	0.236297101814362	3.01626518705671	0.263641341105591	0.316240669155395	4.76741791318252	2.61127393258709	1.16465307381147
0.308545742990241	0.963243984700803	4.95245129035799	1.82424206239477	0.724089793046704	5.00278673271384	4.03446707522475	5.04854659425061	1.04313134575951	0.393096930488460];
phi_scatterer = [5.69977087977824	0.309359862973200	2.26065190957380	0.946904949415214	2.91307685101621	4.89969646713502	2.34127917084954	1.61923751229263	2.16909736745922	3.71656385974318
5.00403318927104	3.71420550530307	4.04811624215343	6.27217917345618	1.47853080416092	5.69116233998573	3.32551854735409	4.52466648815617	2.19058838393442	3.58832873810363
0.490408270281058	5.18123959216773	4.48145198924256	2.63850807600724	3.71701038155854	2.12982750255580	3.74694497371372	3.55440178138894	4.73201020060649	1.23417163446527
0.480471851343261	2.70423490632683	3.95247630041158	4.04287376536001	0.458961385039596	4.37811076199315	0.920006520335554	1.52274554782738	0.591636523702425	4.54639915288038];

eta = [1.25840505301954e-06 - 2.70324306354388e-06i	2.57287659417085e-06 + 2.45753672977864e-06i	-1.18905614922179e-06 - 3.80786294648323e-06i	-2.90260750690605e-06 + 1.77565876879675e-06i	-7.65456924199526e-06 - 1.31390454249358e-06i	-2.02434477364890e-08 - 8.54200042806651e-07i	1.98133938315004e-06 - 1.43027550851617e-06i	-1.10153230623311e-07 + 2.78447313687684e-06i	-4.26816881314339e-06 + 1.21198769768484e-06i	1.72284537052970e-06 + 1.50897410993171e-06i
-1.45386280999948e-06 + 5.83603129147888e-07i	-2.63117346797713e-06 + 7.15595278773994e-07i	9.25420863101479e-07 + 5.04859822366083e-07i	1.04647816933953e-06 + 1.17913929028944e-06i	9.59646843922803e-07 - 7.65577603568393e-07i	-2.52801525675211e-06 - 1.66595851902067e-06i	3.12661324172801e-06 - 1.26280356154813e-06i	-3.20856331005202e-06 + 6.59252334253506e-07i	-9.12145206419140e-07 - 7.39706120445537e-07i	1.13321062715295e-06 + 4.65645002349276e-07i
7.13580956767849e-07 + 1.34506566541134e-07i	-1.01304336298008e-06 - 7.12066805507066e-06i	1.22835833627755e-06 + 3.40744880231721e-06i	-4.82923744257431e-06 + 1.56641090353055e-07i	4.16027282032287e-07 - 4.27555632730628e-06i	3.85513215694718e-06 - 2.02545792017955e-06i	1.29022953971905e-06 - 1.04628026056300e-06i	-4.29953169349438e-07 - 1.50547509863927e-06i	-3.74943086122736e-06 + 2.73827264722299e-07i	-4.17046708667245e-06 - 1.24188079965562e-06i
1.06009332207975e-06 - 1.52278730521007e-06i	1.25113765453011e-06 - 1.10019987334234e-06i	-2.46125630840684e-06 - 6.38233651974264e-08i	-1.31951144376718e-06 - 1.35593823232680e-06i	2.64481505372168e-06 + 2.49630738380939e-06i	1.31240448635732e-06 - 1.31744207612490e-06i	-2.46741413639227e-06 - 1.96275235267791e-06i	1.61601087832373e-06 + 2.56153945818993e-06i	-3.04296145317258e-06 + 2.34668543859104e-06i	-5.20137807007117e-06 - 3.63584632024181e-06i];

%% 生成无线信道
% LoS链路信道
for k = 1:K
    for b = 1:B
        h{k,b} = sparse(M,1);%%%%%%%%%%%%%%%%%%%%%注意
            e0{k} = [ sin(phi(k)) * cos(theta(k)) ; sin(phi(k)) * sin(theta(k)) ; cos(phi(k)) ];
            % e = Rot_Matrix{b}.' * e0;
            if dot( normal_vector{b} , e0{k} ) > 0
                Lambda_LoS(k,b) = 1;
            else
                Lambda_LoS(k,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(K_rice/(K_rice+1)) * sqrt(M) * sqrt(Omega(k,b)) * Lambda_LoS(k,b) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e0{k} ) );
    end
end

%% 测试
for b = 1:B
    Px{b}    = dx * Rot_Matrix{b} * [1;0;0];
    Py{b}    = dy * Rot_Matrix{b} * [0;1;0];
    T{b}     = exp( 1j * 2*pi/lambda * ( kron( delta_x * ( Px{b}.' * e0{1} ) , ones(1,My) ) + kron( ones(Mx,1) , delta_y.' * ( Py{b}.' * e0{1} ) ) ) );

end








for k = 1:K
    for b = 1:B
        % h{k,b} = 0;%%%%%%%%%%%%%%%%%%%%%注意
        for iota = 1:IOTA
            % eta(k,iota,b) = 1/sqrt(IOTA) * Omega(k,b) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
            e1{k,b} = [ sin(phi_scatterer(k)) * cos(theta_scatterer(k)) ; sin(phi_scatterer(k)) * sin(theta_scatterer(k)) ; cos(phi_scatterer(k)) ];
            % e = Rot_Matrix{b}.' * e;
            if dot( normal_vector{b} , e1{k,b} ) > 0
                Lambda(k,iota,b) = 1;
            else
                Lambda(k,iota,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(1/(K_rice+1)) * sqrt(M) * Lambda(k,iota,b) * eta(k,iota) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e1{k,b} ) );
        end
    end
end
% for k = 1:K
%     H{k} = [];
%     for b = 1:B
%         H{k} = [H{k} ; h{k,b} ];
%     end
% end








end