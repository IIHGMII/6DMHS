function [ h , e0 , theta, phi , theta_scatterer , phi_scatterer , IOTA , eta , Omega ] = Channel_Generation_init( K,B,M,Mx,My,normal_vector,K_rice,Coor_Ele,lambda , Rot_Matrix )

    dx = lambda/4;   %x轴方向天线间隔
    dy = lambda/4;  %y轴方向天线间隔
    delta_x = ( 2 * [0:(Mx-1)].' - Mx + 1 )/2; delta_y = ( 2 * [0:( My-1)].' - My + 1 )/2;
%% 针对初始6DMA位置，生成无线信道
PL    = 32.4 + 17.3 * log10( 8 ) + 20 * log10( 30 ) - 26 ; % Path-loss,包含20dB天线增益
Omega = 10^( -PL/10 ) * ones(K,B);  % path-loss
IOTA  = 60;         % 散射体数量
theta =  rand(K,1) * 2 * pi; phi = rand(K,1) * 2 * pi; % K个用户的水平角和俯仰角
% theta = 5.263863993147139 ; phi =  1.057064847365129;
theta_scatterer = rand(K,IOTA) * 2 * pi; phi_scatterer = rand(K,IOTA) * 2 * pi; % K个用户的水平角和俯仰角
% NLoS链路信道
for k = 1:K
    for iota = 1:IOTA
        eta(k,iota) = 1/sqrt(IOTA) * Omega(1) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
    end
end

% theta = [0.683512118823568
% 4.56975245007496
% 1.61777970338213
% 4.32947146727470
% 1.17972313068876
% 5.13789505706095];
% phi = [1.07493017652815
% 2.81433551272251
% 2.11774181808391
% 3.55462364666030
% 2.85337657148375
% 5.58289091320394];
% theta_scatterer = [3.71598171111151	0.789740772223874	4.64256409452573	6.09638948988180	2.71394092853256	5.78159763180186	2.44731172862056	0.715343190566145	4.32466463139460	2.79033841203973	4.26674431337541	4.25790483988487	4.52037397291464	3.29699940101734	2.43145102610524	5.02551073480144	2.97394864142883	4.28962387100205	3.33706387678675	4.52099583490629	4.92470321271268	3.47775427282324	1.47470129489274	3.48031516393717	4.05916739850066	1.06710750693932	1.65969866462753	2.55585174505839	3.77921855655247	2.89550832181597	0.0156893017049521	1.76997528373440	2.29179868327745	0.0530232993111751	2.26059864772240	6.11870143917921	0.684370146185501	5.67376285908349	5.58891661790584	1.99149478452099	3.19222883906494	4.00878856014625	4.74042764434356	2.95809779420628	5.87487221470506	3.07358907490934	6.21447111825257	5.99727119378991	3.48980480884932	0.662172321600486	1.32373965754229	0.823209348245605	5.27227929701743	2.94101922961429	5.02007304424685	1.92787536029464	1.01017078649554	4.35742863522388	2.80350822761325	5.50841465167190
% 3.68564494079909	0.581929036271821	6.11959454047049	1.08914634646102	4.32145145936957	3.60918945135489	0.0696056436985793	4.51421812184110	4.91448951397109	6.04711731212772	3.55417478352097	1.06495934532789	4.52738666057011	0.123328092357916	5.57852153422264	3.45896165105200	4.15798918087101	0.159573024571251	2.46776359028498	1.98541928230518	5.45006498675321	3.55449994644400	1.64949778051837	3.91082545000786	2.09644745718549	0.440461815264485	5.58083280887702	5.06633337151624	5.86218075401994	1.94502999664537	5.09467213765084	3.61600423198000	1.58355418694217	0.449197388831270	1.84345172152670	0.0495934076098495	0.854377511303896	3.36451185191920	0.929507008865659	1.73321388480377	1.64183129125881	4.17764849726685	3.80278857257245	5.40911251856339	1.58303466769557	2.26113287407478	1.21386641962283	3.20718923674103	5.13869317567014	2.55407821133251	0.359656424060761	4.93441234904704	0.628748887247484	1.62326479665751	1.55743115391647	2.90794868248366	4.06116942552459	0.909909352738140	0.188446938212348	0.506954174017759
% 1.95129411763784	4.14745644134711	3.59240453964208	3.23680835778126	1.85880580411169	0.488118146130923	2.23987579662655	5.98715979337070	2.64200439406327	0.579165270564349	5.70060533910522	2.88797945754842	0.599832285661509	4.50235745511963	5.21729393645167	3.30469234646410	3.41142248242436	1.26104996949259	3.12491277614763	2.24727594229555	0.872273482889667	5.25850918862622	2.02750694616398	5.42806134884878	0.642146231014075	1.88242806443246	5.70513600565118	1.55185855729439	5.01573836693124	5.46300806958153	2.06338029103877	4.26729156399657	1.20297071784774	5.89215775601604	2.80368355009810	2.40654291301324	2.18813598976588	5.82350217328995	4.75765516420880	2.51725057050164	1.29404125101701	2.56385381246287	4.31270933807600	1.49451711635635	1.54246691702568	3.15117015456962	0.0369497657723973	1.44232448332258	3.96693625861480	0.114122559315415	1.00895615423591	0.683777544126165	3.43589515327673	4.89743260759346	6.21180058278211	2.42168646204596	5.69975171876204	2.31482027431316	3.17404412767783	5.24615775394678
% 1.84224059243059	3.46300171131693	1.57960561234118	2.19499371787449	0.514871948298854	2.66399550779006	4.95254514338582	4.34326244276071	2.06200206242406	2.50739425484614	5.53870611097333	3.22661077423425	2.41268732690748	0.0944845309102713	4.14553403455056	0.284985747958849	2.67634361229055	4.84295082906838	0.351760598218030	3.20668423653606	5.45216932707574	2.70958030122895	3.05177335899828	1.96000172594795	2.78273559760565	5.10143025546241	0.450774892983278	1.47807381092353	3.41077507111985	2.48998215211101	0.340186654753899	5.15281462962384	5.39347896849796	2.22276247866457	0.526468833504724	5.72578397796128	3.47503867485532	3.76070223795722	3.90448037515824	3.91573030706844	4.61784274756401	0.465332180028933	5.36636615301432	5.31484198231211	6.19792008036881	4.91103024912070	5.22131519353602	0.377565514250912	6.17272360515281	4.27422418412618	6.23458302307268	2.35272120407243	2.54517238502632	4.86816204819171	3.08786174047895	5.79260747067371	1.05618055595763	5.38240656361755	5.69105101295479	1.96567163610773
% 4.41850348234475	4.86310425413870	3.07344605243782	3.65351640916790	2.87903127072082	5.25171930997408	2.51746505149937	6.11580102704644	5.64758691421333	2.86891611693041	0.433210621004999	2.42657009397998	0.0436762997268241	0.468833008380371	2.82152358898496	3.55345186199025	1.37231494381231	2.76034949391922	0.803064047003620	1.57592323864029	5.62939887152922	2.72583163152120	4.16419788759738	1.37618809331708	2.76464107203125	2.26244667413768	0.535819802935891	5.26757329486556	1.93081699936936	0.556293579508562	6.20149362550464	2.30793898722613	4.22136892789650	4.84278210625269	5.02795073415615	0.938753925001437	0.756859329583585	0.386626441941727	5.30784378200108	1.85658767363174	4.56748680060722	3.65026768716726	4.86832109129661	5.59407324550327	1.95593802593487	4.40843350468109	0.950036056720669	5.90046751140460	2.23777659403552	1.79407658220738	0.0993799705566489	0.915446588289068	0.211311935385785	0.784458408781356	4.49623525796509	5.39419778455953	6.27990985768653	4.36158749405233	0.968046281400650	0.928333527212546
% 4.07990086116404	5.92270258371663	0.919700622594655	2.42007720620749	2.58962557367517	4.62662408192336	4.69681421411449	5.69966867025764	0.519807652113977	4.86869033624110	4.41114002819425	2.44858389242077	0.451293734227060	6.08345802252942	0.329185077438892	5.71323944793555	2.02843832907204	2.57872300647935	2.81670928177936	3.45835460681944	2.01409923277904	4.48126415058702	2.30511869995538	5.78250909179458	4.88182318028301	5.73326355906071	3.96317909208384	5.20995019988438	3.74130996196208	3.68766464474918	4.27924757538126	1.49379405934878	0.652403985445639	4.56229853625831	4.54474949699933	3.24267743249361	2.85998848560772	0.873401860470905	2.68645334245110	5.23325203062346	1.73640050147371	5.77224273932367	3.06219137217749	1.21921535530468	2.24608580663219	2.28284646979233	0.944524314271939	3.44983294845802	0.175203835996501	0.685174424654923	5.43581583079835	2.82890238078140	2.05351015494552	3.75072507365328	3.37868751934779	2.05478408569935	4.28431187302393	0.0293678110519316	4.66339621971038	3.85844705327677];
% phi_scatterer = [1.56864309165089	0.960229393382701	4.09346454063684	5.69648624721601	6.02006237180529	1.71644795926730	3.97220877952014	5.85626667258160	3.90290947694019	6.26131472140399	5.53576617220598	4.53303965964382	1.99689741190442	3.48250098645060	4.69678785105599	0.168664640709871	2.19706952367718	1.60788372342211	4.14959145058620	4.06364368495388	0.581852715655070	5.55357495228937	5.18562782045146	1.66869710802879	3.37268036021226	0.0692622422252097	5.58557663623159	1.14395870544944	1.56991198086481	2.30544549026256	5.61837439754431	2.14961731820924	1.41382454483081	0.677457756879361	1.10437313580441	1.73818712321994	0.748338242513501	4.79351959000759	3.01413095448577	3.13944343464513	4.15617477270355	4.45105507080333	2.46223358537694	2.96743383581470	0.736321132478959	0.415772307446084	0.0297831035477952	2.72702405860438	5.43385990653667	1.75803666824767	2.66606017138091	2.36483065827853	4.23961745647079	3.98347343724986	4.85262527279704	5.78693073902709	4.18701147758154	4.98305521846329	5.92268764682686	0.656310426188616
% 4.86465359648691	5.61850489505344	2.95680937601826	1.50792017327934	5.06148819029798	2.77387427944588	3.53609417181710	0.799517537555920	2.29697358859974	5.02926206762312	1.31753241280423	1.85224685978054	3.51661798520216	3.78885436887066	4.16930005601038	1.25776816914930	5.94555570117291	3.44505817439924	2.33281621956838	3.06806188839459	4.54112185678172	6.27050456251439	1.10667306283304	4.34750240443442	1.57293837086040	4.55330220181070	5.36820649655734	5.46344200616866	4.37831481772591	1.79914165021252	0.271179144243920	0.225844941527666	5.97813336256545	1.02287549339210	4.05055520048783	1.44844835919092	5.85721295919696	0.241414257071160	2.17682840419967	5.68002810018879	1.06622462543343	1.90919665703112	0.990001610651732	4.15723305300518	4.80513966301209	3.82691806146372	1.67256813592386	4.31061734368566	0.165039033873136	2.74922140502317	4.42861455320541	2.35089652700192	5.98993655753665	5.88151364305323	3.54952518656811	5.14541750058594	0.593531732625446	1.97734162973981	0.998140412407803	5.66379469292558
% 1.89652747759877	2.52572582362792	1.28581504612545	4.82651643979542	0.594707414083054	0.340793628068667	0.987346011608879	5.47550467038368	4.39026545449117	5.26700489449801	3.64430912140831	5.56368045643977	2.34511676813029	3.68920113083661	5.48315365497274	1.24776777068360	3.83763456970515	0.746300897520110	3.56420358208021	1.65499116163212	4.86143416363627	3.26781836097578	3.35011645926145	2.97740950332703	5.06113096892738	2.94231088811550	5.14699527097878	4.23593670736258	0.963237845165248	3.98193413657868	2.53844104689366	2.71046869912317	3.34994078167878	5.92805626403136	0.955321687784355	1.77814602907513	2.45090754821970	4.09765961212808	2.74916495327192	4.99566049434764	3.12841338261018	4.93460969560255	0.352661962377417	5.19233998970253	1.45514702966886	0.935058385041521	0.809706212118738	4.74487314436135	1.64900360304015	1.08809361276473	3.73546193315835	3.07737814729983	2.94734722412425	2.85589915432283	6.13683011634326	3.38799660998693	4.42097410982634	3.88979446390187	4.87587192486015	3.63532952848153
% 0.527099529702372	0.497494914036018	5.03596687989361	3.09394870443628	2.96729349112799	3.42272079731434	3.24756746619831	4.90218983246843	0.258210968296953	1.52864357835912	3.33310643114887	5.31776315832563	5.69693492452804	3.44140252138686	0.175374437891233	5.06776664074668	3.51510182158104	3.62494020279436	3.40332672347890	0.948083246792840	2.34821763993767	4.51656038552365	1.29592871080768	5.86860617432493	6.12607706924519	3.78595964676782	2.95611407090411	4.46088097130756	2.23626121963574	2.14581697051779	2.71087447795437	5.36716874136528	1.25034621332080	1.90699942990760	4.41510644369811	1.19428575918580	3.68124031835910	5.93372432125198	0.522361542225347	0.147750553725836	5.29878164683164	3.26430340954297	4.22839723515437	2.56233805571708	4.82834083630849	0.325641945803075	0.531375297503003	0.599019807042544	3.53017995256531	0.806782494553916	5.20099406920416	0.738161056345658	4.96693999874637	4.32955763379858	0.133686283734561	2.54753471351347	4.52552718411409	2.20510299415849	1.15298134007735	1.78271031868884
% 0.0779470293603091	5.95449199697059	2.79232027955362	0.0341974500062695	5.31258268121835	4.88205539650601	1.14384629393199	1.55985471285799	1.07200135392184	5.88799917445081	3.06308830768269	2.87125509570436	3.62185214208238	2.45713537998177	5.77408291097045	3.11210498227822	2.12874525563735	1.72573847545893	0.00217819712291469	3.30866623618721	1.47393450878844	1.80455586261253	2.60042852305218	2.66191804725259	4.75080308257958	3.46161367524310	4.48000006515229	4.91016589804154	5.96215577120567	5.92090369157322	5.04695011758325	0.822604742652430	0.892064976746265	3.25035344772676	6.09165893694908	4.47215830246448	3.65891192002404	1.84241472413225	2.85868779104787	1.98350547025962	6.15051425993601	0.0984847549273644	3.54184246479982	0.398841279704248	6.01980605620742	3.27760030540226	3.04664107599960	3.53535932181496	4.88485893621311	2.59473853098509	0.140217879236606	0.599928723053178	4.60221696509979	0.554797662137562	1.06377061904735	0.198405529559885	5.53466167747427	4.62440018782146	5.33228095094124	2.95793008385488
% 2.09805358246452	5.25386234684879	6.03917648585968	1.35968034390793	4.95951210143670	2.25284154198976	0.762104868787147	5.33310331591902	4.32662444142946	6.06454027422758	0.636091516727863	4.33768683115291	1.59349377723128	2.99759823927633	6.26010253112849	2.87378139060907	1.89033293220004	1.29634064541018	2.35300260359663	3.26774871885736	5.19356382629757	4.61583533337400	2.36650830629642	5.22274999119558	0.323162993853954	4.50050178696535	1.67154515425383	3.48969238823007	3.48924078831506	0.153748565179488	1.20540372946648	2.25582171162802	3.29224491369459	0.557539286344354	5.01449115292397	3.45682751309602	3.95699549984827	4.74443488866305	3.37219257765056	2.47116901358185	2.12331874978100	0.138891840898981	1.36716570895566	4.33780411614997	2.31069923512068	3.95868979830130	2.52413515450623	1.84771384736809	4.09514070071459	4.88793648523458	4.92767496999481	6.01296421380102	2.99334076679669	5.99528409103810	2.68273641735030	3.17817390685523	0.673090837715879	5.22579065655378	3.62475772719575	4.84705252948703];
% eta = [1.67732237001970e-06 + 4.50286909076188e-07i	-1.26355286885987e-06 - 1.61780891105199e-07i	-3.99978571421534e-07 + 8.20685512656329e-08i	1.88569754339355e-06 + 2.34146422100936e-06i	6.18381963004413e-09 - 2.30363729342091e-07i	5.07513790507644e-07 - 5.99209507484587e-07i	-9.95848250822399e-07 - 7.28208641065766e-07i	8.37369672689002e-07 + 3.90737952916752e-07i	-1.19400980868697e-06 - 1.37530469877725e-06i	-1.36627940966523e-06 + 8.55124693935659e-07i	-4.91246895831877e-07 + 5.58623390549313e-08i	-3.35260878273363e-07 - 7.79487909209227e-07i	1.94541400650423e-06 - 6.40016575928055e-09i	1.94690376632142e-07 - 4.70455032537858e-07i	2.32866703697269e-07 - 5.43021382592726e-07i	-1.10640127145947e-06 + 4.75971673438930e-07i	6.62353090867427e-07 - 9.52683974567028e-07i	-2.84106718842873e-07 - 1.14606801029993e-06i	9.46195736315235e-07 + 1.02717596456666e-06i	-1.07144973701322e-07 + 2.02887471120738e-06i	1.42429926443747e-06 + 2.47406739500916e-07i	9.04571769859930e-07 + 2.36266764285864e-07i	3.75025999168209e-07 - 1.83906226181868e-06i	-8.67599953301356e-08 - 1.55966362285299e-07i	-7.20349668423771e-07 + 7.58101153338648e-07i	4.77944595684482e-07 - 1.62763819381378e-07i	-2.69082571162832e-07 - 5.57082556109751e-07i	-1.49424286086921e-06 + 5.67927583747662e-08i	6.36269452455048e-07 - 9.74711520548533e-08i	1.34692507565548e-06 - 3.34538151355139e-07i	-1.54141322673810e-06 - 7.08033434450299e-07i	6.92365841087414e-07 + 1.82516993073628e-07i	5.70385800494291e-07 + 1.17209146509357e-06i	1.23255696563061e-06 + 1.54233454713695e-06i	1.30058886794778e-08 - 2.26513806975670e-06i	-1.02431342453226e-06 - 7.36320256388037e-07i	-9.77153346148711e-07 - 1.46327503311769e-08i	-7.61843377348323e-08 + 1.54853386090637e-06i	2.72482742621977e-07 - 3.61226303601728e-07i	-1.86338804181895e-06 - 1.67501142953406e-06i	4.84563562995452e-07 - 1.08472489622790e-06i	-2.04564799546558e-06 + 4.58941789924303e-07i	8.58912939812317e-08 - 1.25029545876775e-06i	1.14597752392866e-06 - 1.75739352774611e-06i	-8.63220842167884e-07 - 1.12221857462734e-07i	-1.58276422884773e-06 - 9.33468145757288e-07i	-3.10302397183294e-07 - 1.31707738233086e-07i	-1.50827751164229e-07 + 4.36612132319716e-07i	7.30138778057654e-07 - 1.19206288401323e-07i	6.64300685666594e-07 + 8.36250933274562e-07i	1.84982568864107e-08 + 2.17380076677205e-07i	6.12762152549380e-07 + 9.66342017843691e-09i	-4.23233438275964e-07 + 3.36109205814408e-07i	7.42042139612622e-07 - 1.34546782845467e-06i	1.28654352244376e-06 + 7.34345495858778e-07i	1.12040584331229e-08 + 4.59523814352258e-07i	3.82701716021860e-07 + 1.86281021510877e-06i	7.25360958063466e-07 + 1.59308332795593e-06i	1.24957394091859e-06 + 1.39700831065828e-07i	5.56789439217554e-08 + 9.06371381598685e-07i
% -1.07551936652316e-07 + 3.87198448010384e-07i	7.03526875921659e-07 + 2.39210917835963e-06i	-1.40729826377721e-06 + 1.10744030544856e-06i	1.34870957601276e-06 - 2.38249496050570e-07i	1.01057204089521e-06 + 2.14959040636941e-06i	1.92898887515864e-06 - 1.27033122482503e-06i	4.00324856974428e-07 + 1.36696957294459e-06i	-1.78558320531255e-06 - 9.45926930130065e-07i	-5.21613962503656e-07 + 6.84324778934054e-07i	8.51399813882423e-07 + 1.14992988576232e-06i	3.59808287968892e-07 + 1.53228586663413e-06i	7.24856154613681e-07 - 3.41706095473346e-08i	-6.23971826499027e-07 - 4.15969507828333e-07i	-1.08351246719125e-06 - 7.41233048994121e-07i	1.07911575717539e-06 + 9.17578038157069e-07i	1.08661192535793e-06 + 3.52442783003030e-08i	-2.52301030793046e-06 - 2.08397450730173e-07i	-1.12268361424491e-06 - 1.58900087103491e-07i	-8.80526300055889e-08 - 6.97190473324302e-10i	-9.06923706206882e-07 - 1.47436394008649e-06i	-1.16110598600248e-06 - 4.03447705626954e-07i	2.38301878214349e-06 + 1.88167313730423e-07i	5.62618747914871e-08 - 3.65385148425558e-07i	-1.14502417799033e-06 - 1.40040365203549e-06i	-2.39772217145889e-07 + 3.49989127255180e-07i	1.60903552678294e-06 - 1.80993393180078e-06i	-1.51296712944533e-06 - 3.63324716184380e-07i	1.02962071564997e-07 + 3.78164870721918e-07i	1.10494024870723e-06 + 1.07767253854366e-06i	6.81809584915373e-07 - 1.70232158280766e-07i	-1.28744966950800e-06 - 1.06734778928585e-06i	1.47615337315895e-07 - 9.33852649131178e-07i	5.84554017371670e-07 - 3.19240316064583e-07i	1.45909310935637e-06 - 7.01020551161000e-07i	-6.07359593963791e-07 + 1.28417267556052e-06i	-1.06841376593458e-06 - 3.49985193378964e-08i	-1.22841285791714e-06 - 1.58347282112402e-06i	-1.86450297170811e-06 - 2.19646761402759e-06i	5.06446694293338e-07 + 1.75438679063715e-06i	2.74051300291362e-07 + 5.83708675455273e-07i	2.94456517468002e-07 - 4.25592947184329e-07i	4.93070280125970e-07 - 2.84030813751175e-06i	-1.33376342608854e-06 - 1.04540454461907e-06i	-7.92873865312464e-07 - 4.11029692341639e-07i	1.22865239567850e-06 - 1.63388670182045e-06i	1.08955572490901e-06 - 1.16122345294822e-07i	-1.60833133944891e-06 + 1.55263355601631e-08i	-3.16789492102508e-07 - 4.39031900300023e-07i	-4.50665899265140e-07 - 5.29183318552663e-07i	-9.87460106702955e-07 - 4.68761961836523e-07i	5.55856219449275e-07 + 3.69098325510109e-07i	5.76585926646140e-07 + 2.97113042075853e-07i	7.66501185417975e-07 - 2.06820180821022e-08i	-1.06516094719721e-06 - 2.59896089733657e-07i	1.00045514679365e-06 - 1.68868938982582e-06i	3.44033158651400e-07 - 1.69423334693472e-06i	-1.03888694896102e-06 + 2.39329903767527e-07i	2.20798894470989e-07 - 1.54983619003427e-06i	9.43192629423787e-07 - 1.20758198789422e-07i	8.44938895609837e-08 - 2.70053677839383e-07i
% -8.69104117844898e-07 + 3.30486199400814e-07i	-1.17832963548033e-07 + 6.80218963085466e-07i	-9.86946968407404e-07 + 1.40183301342787e-06i	-1.48513411361755e-06 + 4.84968927405714e-07i	4.26693888176520e-07 - 1.97659368496689e-06i	1.12135266983384e-06 - 8.68444446961839e-07i	1.79010053098906e-06 + 7.68050501407699e-07i	7.54680573429808e-07 + 5.18314579429381e-08i	-1.27556392646644e-06 - 8.98724402227377e-07i	7.70060861519182e-07 - 1.20394092906308e-06i	6.13424119993499e-07 - 7.55369313132952e-07i	-4.05967497662251e-07 - 6.88874324977357e-08i	2.53377952744748e-07 + 1.80345801976363e-07i	7.47381141554409e-07 + 1.77907194379276e-06i	-7.42910224404582e-07 + 1.02245168205872e-07i	1.14822953812173e-06 - 4.33575895023352e-07i	1.06509746971012e-06 + 2.31590350193558e-07i	-9.94936162282220e-08 - 9.60760177296714e-07i	-9.55613506491789e-08 + 8.30708274586231e-07i	1.53215148835647e-07 + 1.02862865008935e-06i	5.33809593385304e-07 - 4.97460911199442e-07i	-2.30024135188742e-08 + 8.86795155968553e-07i	7.95010924747459e-08 - 7.57786877936123e-07i	-2.92873123028284e-08 - 1.45097943203616e-06i	-1.55723637688286e-06 + 6.04646807564947e-07i	-1.50015521083696e-06 - 1.73871620350880e-06i	-7.32575612575017e-07 - 8.34816662157323e-07i	1.23343247280024e-06 + 2.73314150056986e-07i	-5.36766577810857e-09 + 2.61311279699397e-07i	4.03816971944378e-07 - 2.50647184576634e-08i	1.83397386497299e-06 - 2.36698409766030e-06i	1.01627116130099e-06 + 1.15396633369689e-06i	1.13028872267849e-06 - 6.25568512492517e-07i	5.42187967119017e-07 - 8.83839321542264e-07i	1.00671978007703e-06 - 4.85125735802264e-07i	1.98199181000253e-07 - 1.50136479880186e-06i	6.58799284188577e-07 - 6.74599500937940e-07i	-1.15773943581355e-06 - 1.58211814674794e-06i	1.57866482740966e-06 - 2.02546116840475e-07i	-1.11122828328094e-06 + 1.58113056555224e-07i	5.95252575054367e-07 + 6.83025833981867e-07i	-6.49322515989594e-07 - 5.85865298179161e-07i	-2.59904741481910e-07 - 1.32728317417104e-07i	-7.12839402285952e-08 - 1.05165875296990e-06i	-3.14056905032442e-06 + 3.95519289848023e-07i	2.09000750710249e-06 - 8.43501247174297e-07i	-5.17173549336363e-07 + 5.03316218242757e-07i	4.81358815122246e-07 - 1.02344643635609e-07i	-8.18657825840833e-07 + 2.68956078329961e-07i	9.39179504360597e-07 - 5.16166777471267e-07i	-1.03434644661624e-06 - 1.17942670645567e-06i	1.48331871241523e-06 + 6.22012910129803e-07i	-3.94381889942481e-07 + 7.41002751309151e-07i	1.75667436647663e-06 - 2.08608876225119e-08i	-2.73694338277321e-07 - 1.20954861337538e-06i	1.30037031648223e-06 + 1.40147864473108e-06i	-1.55079853889564e-06 + 1.05075711923562e-06i	-3.41030240392806e-07 + 9.33618932690886e-07i	-1.72699709397241e-07 - 1.47570605337121e-06i	-3.30958914577688e-07 + 1.53077523040355e-07i
% -1.46895238344349e-06 + 4.50746597491788e-07i	-1.95382811160996e-06 + 2.34491992915906e-06i	2.21151217181322e-06 - 4.73995450294240e-07i	5.47964320928506e-07 + 5.10720960928697e-07i	-1.27100939657519e-06 + 2.04370497407087e-06i	1.26828775872591e-06 - 1.10108032531053e-07i	1.10903185982389e-06 + 2.16542305586284e-07i	1.07123001020937e-06 + 1.72361781918142e-06i	6.41365421950316e-07 + 1.72296651082894e-06i	-1.07485922011618e-06 + 1.46274230916142e-06i	1.33398490266510e-06 - 1.61608964838773e-06i	-7.50065295524876e-07 + 3.57308452341033e-07i	4.46021783396608e-07 + 1.79889724591011e-06i	-6.95962902803113e-07 - 1.47922644905012e-06i	-3.79958066036487e-07 - 1.02987497481348e-06i	5.34470551541609e-07 + 1.89465295388957e-07i	4.91516058716553e-07 - 5.98986097912015e-07i	8.63881860168401e-08 + 1.00822231573432e-06i	4.56184576562963e-08 - 8.80883559764512e-07i	-1.62864840083466e-06 + 3.89617795477932e-07i	-2.49348987441251e-07 + 5.19332453858583e-07i	1.29312512770599e-06 - 1.01785469995885e-06i	1.05502173599827e-07 + 8.55268170931667e-07i	-7.74982841605883e-07 + 3.38629278530257e-07i	-2.95318306640545e-07 - 3.56452181059082e-07i	2.22302355640516e-07 + 2.15932850739369e-07i	-1.85601446570772e-06 + 5.61867866464560e-07i	3.10180004454328e-07 - 1.45285285581550e-06i	-1.08657508409246e-06 - 7.38208846865231e-07i	3.75717954066927e-07 + 8.99482867003459e-07i	-2.38994627476939e-06 + 3.13809385518420e-07i	2.96635110214238e-07 - 2.79595041963062e-07i	2.50077532351699e-06 + 8.02964222116183e-07i	-2.88058682223216e-07 + 3.38074830219124e-08i	-5.20262929315150e-07 - 9.97570273317310e-07i	1.89067867239492e-06 + 6.35572630142390e-07i	-4.09573028650773e-07 - 1.66187606044836e-06i	-1.76344049201234e-06 - 1.81815842911282e-07i	1.45313716694927e-06 + 6.17155199164628e-07i	1.09968469669251e-06 - 1.34407476647126e-06i	8.52638301839095e-07 - 1.32659248958134e-07i	-4.98424399474614e-07 + 4.33456882210665e-07i	3.29791401834950e-07 + 7.85792893304923e-07i	-7.62914237369758e-07 + 6.06129608886544e-07i	-7.70441953053950e-08 - 2.68449872535245e-07i	1.34261430658304e-06 - 7.39486034307290e-07i	-4.83394905013455e-07 + 4.56028034355840e-07i	-1.31688153968821e-07 + 1.22273794034182e-06i	8.35175210847772e-07 - 9.61503790810808e-07i	-2.58165176174285e-06 - 2.11359850503517e-06i	3.64642705024631e-08 - 7.13013647301375e-07i	1.91797958989605e-06 + 3.52569777392287e-08i	5.15181397912793e-08 + 7.00975619405064e-07i	-8.79500758532929e-07 - 2.12204883795148e-07i	7.93733755625725e-07 + 8.69362047830681e-07i	-2.98627559053879e-07 + 4.37978199995911e-07i	-9.01623154167962e-07 + 1.87262282494598e-06i	-1.90339863714054e-06 - 4.10227584384759e-07i	-2.24014539939287e-07 - 1.51312998466757e-06i	-6.69746136293706e-07 + 3.42736305593467e-06i
% -1.36283463678804e-06 + 1.12050261079943e-06i	-1.85013973601555e-06 - 8.02050939878386e-07i	-9.22745205108489e-07 - 1.20911192495534e-06i	9.04765996405138e-07 + 1.94722000321890e-06i	-2.09490592443346e-07 + 8.43272278754859e-07i	-1.28059805710868e-06 - 2.66580680074322e-07i	5.39318930790060e-07 + 1.38314458976841e-06i	8.49077734685103e-07 - 6.75340558194693e-08i	-1.09594317835165e-06 - 6.60166970112271e-07i	-1.17338921499614e-06 - 1.02465584855355e-07i	-3.85687212262589e-07 - 8.31270119911757e-07i	-1.31945559888740e-06 + 4.50677566652267e-07i	3.85413218207138e-07 + 1.27868127391906e-06i	-1.08312278240402e-06 - 1.13994912130467e-06i	-6.54754825274162e-07 - 2.31785652855415e-07i	-2.58019765492310e-09 - 4.35850727102903e-07i	2.08141606791990e-06 + 1.39368891497679e-06i	6.67845703267463e-07 + 4.27735355494427e-07i	-8.89519574624719e-07 - 1.29825902711590e-06i	1.00752019904109e-07 - 2.51678241963416e-07i	7.27420800671005e-07 - 4.80402063269407e-07i	1.48477998361950e-06 - 1.81746106993678e-06i	9.32110834490762e-07 - 4.96571579644889e-08i	-1.18657437260628e-06 - 1.12955706251954e-07i	-1.17766216809602e-08 - 1.06289627026160e-07i	2.73578397494728e-07 - 1.31933692269702e-06i	-6.62484664553879e-07 + 6.65244234650745e-07i	7.29044334952348e-07 + 1.00351229120476e-06i	6.76478852056895e-07 - 4.39534771753754e-07i	1.52207948152390e-06 + 6.99602232665207e-07i	1.44878677758600e-06 + 4.12797684738023e-08i	1.55595305309098e-06 - 2.56362116790182e-07i	-5.16556287412911e-07 + 7.16409394504060e-07i	1.91115411460452e-07 + 1.18288500264818e-06i	5.37236015666830e-07 + 4.53380050444994e-07i	-1.28118264876756e-06 - 1.33818325635628e-06i	9.10202488055995e-07 + 1.08217896986958e-06i	-1.04585839513864e-07 + 7.54527513268949e-07i	-1.03862306808854e-06 - 3.04176235030250e-07i	1.51761193269761e-06 + 8.36994782161011e-07i	-8.42517337077320e-08 - 2.37307649587457e-06i	5.64725978517553e-08 + 1.72802701725914e-06i	1.07776260961719e-06 - 2.75589485138315e-07i	3.78012624926947e-07 + 6.00029025730918e-07i	3.11234902761171e-07 + 8.82348063393302e-07i	-5.49324973775043e-07 - 1.03734881090470e-06i	-1.90538894913579e-07 + 6.61464155970994e-07i	1.21249455092579e-06 + 1.05593439241673e-07i	-2.24343527951975e-07 + 1.88488000931152e-07i	-5.45632712843625e-07 - 2.60491640340529e-07i	-1.36291313433792e-06 - 1.50712627804491e-07i	-6.80381950753152e-07 - 6.69088675921951e-07i	8.84869984076632e-07 + 1.74584172263993e-06i	-2.81684927907464e-06 - 2.04541193053937e-06i	1.50959588273371e-06 - 2.18227343140953e-06i	1.37841103578411e-08 - 9.21539332240350e-07i	9.88560381883435e-07 + 4.47191725937926e-07i	-2.44894723429088e-07 - 2.44876519078448e-07i	-1.62889062118215e-08 + 1.77973036867535e-06i	-9.93606441960358e-07 - 2.27548549652661e-06i
% 3.03451492264320e-07 + 5.86814331542503e-07i	1.05676484167257e-06 - 1.22822086329712e-06i	2.98555698994486e-07 + 3.51481416879499e-07i	-1.30582912159339e-07 - 9.42997522954414e-07i	1.04925122689391e-06 - 1.46574259930525e-06i	1.76164112458843e-06 + 2.43401291578214e-06i	-9.13099723739489e-07 + 1.13502210621159e-06i	1.02315153747028e-06 - 4.42566515774422e-07i	-1.77509482264322e-06 + 1.17788497600914e-06i	1.74182006384525e-06 + 8.74352139434403e-07i	-1.02882837429921e-06 + 9.24407226766070e-07i	-2.28461173864001e-06 + 1.15928833343605e-06i	2.82684657097339e-07 - 1.67234234499935e-07i	-9.66886130515885e-07 - 1.09060251987406e-06i	2.95599296568474e-07 - 1.08954202061767e-06i	-1.21286253598364e-06 + 1.18048546177064e-06i	7.79704477779705e-07 - 2.09136863188903e-07i	1.29859774851551e-06 - 5.24508409063316e-07i	7.08983755931161e-07 + 4.33350277113727e-07i	1.13634881399660e-06 + 4.02396820860352e-07i	1.55584715414738e-06 - 1.11936415904374e-06i	7.81502716552783e-07 + 1.86284975126584e-06i	1.74664137121130e-06 - 5.20895065931249e-07i	-2.82189767383600e-06 - 2.26700813365343e-07i	-3.28185226371730e-06 - 2.55872389322508e-07i	-4.53311177092903e-07 + 7.17227619667122e-07i	1.13879805622527e-06 - 7.00685221226272e-07i	-2.04785659363103e-07 + 5.89674634096041e-07i	-5.96653097053992e-08 - 9.25271392790523e-08i	-2.55857369858877e-07 + 1.34429516138747e-06i	-6.03980074455921e-07 + 4.71807456447627e-07i	-5.75020990786504e-08 + 2.16491768398073e-06i	-1.86609734133834e-06 + 8.38107743326751e-07i	-1.43909324154613e-06 - 1.81617632591545e-07i	4.64747970064015e-07 + 3.70243992918200e-07i	1.95552065433514e-06 + 1.02246322177386e-06i	8.66357661976751e-08 - 7.08089624226442e-07i	-1.43521556440975e-06 + 1.14578137776076e-06i	-3.48726654607223e-07 + 4.29484732653943e-07i	3.62041195478251e-07 - 1.57592806615043e-07i	-3.02933813333439e-07 + 6.48406499165354e-07i	-1.53665394460741e-06 - 3.74006828256884e-07i	2.24953621990824e-06 - 8.63489791847958e-07i	-5.24704530895190e-07 - 3.58203103004156e-07i	-6.01941291265629e-07 - 7.15663428500801e-07i	4.41127382506591e-07 + 3.69210845881978e-07i	2.64497040571957e-07 + 1.04735436526821e-06i	6.19904330786416e-07 - 1.93264812346706e-06i	-1.84975519328025e-06 + 5.22412984343559e-07i	2.27599667146814e-07 + 6.11806165834514e-08i	-1.61329030662033e-07 - 5.46937651192566e-08i	1.56332983876086e-06 + 3.88100942423875e-08i	-7.30357183945097e-08 + 1.45301359154410e-06i	9.49150871424080e-07 + 1.33551383415534e-07i	8.22776940358967e-07 - 1.51052840345260e-06i	2.57943190506870e-07 - 2.78417091423829e-06i	1.39951244620622e-06 + 1.11911818092121e-06i	5.75052207269743e-08 - 1.71931700369897e-07i	-1.74541398311628e-06 - 6.05532308445500e-07i	-3.42486893946549e-07 + 1.03559447092783e-07i];

%% 生成无线信道
% LoS链路信道
for k = 1:K
    for b = 1:B
        h{k,b} = sparse(M,1);%%%%%%%%%%%%%%%%%%%%%注意
            e0{k} = [ sin(phi(k)) * cos(theta(k)) ; sin(phi(k)) * sin(theta(k)) ; cos(phi(k)) ];
            % e = Rot_Matrix{b}.' * e0;
            if dot( normal_vector{b} , e0{k} ) > 0
                Lambda_LoS(k,b) = 1;
            else
                Lambda_LoS(k,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(K_rice/(K_rice+1)) * sqrt(M) * sqrt(Omega(k,b)) * Lambda_LoS(k,b) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e0{k} ) );
    end
end

%% 测试
for b = 1:B
    Px{b}    = dx * Rot_Matrix{b} * [1;0;0];
    Py{b}    = dy * Rot_Matrix{b} * [0;1;0];
    T{b}     = exp( 1j * 2*pi/lambda * ( kron( delta_x * ( Px{b}.' * e0{1} ) , ones(1,My) ) + kron( ones(Mx,1) , delta_y.' * ( Py{b}.' * e0{1} ) ) ) );

end








for k = 1:K
    for b = 1:B
        % h{k,b} = 0;%%%%%%%%%%%%%%%%%%%%%注意
        for iota = 1:IOTA
            % eta(k,iota,b) = 1/sqrt(IOTA) * Omega(k,b) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
            e1{k,b} = [ sin(phi_scatterer(k)) * cos(theta_scatterer(k)) ; sin(phi_scatterer(k)) * sin(theta_scatterer(k)) ; cos(phi_scatterer(k)) ];
            % e = Rot_Matrix{b}.' * e;
            if dot( normal_vector{b} , e1{k,b} ) > 0
                Lambda(k,iota,b) = 1;
            else
                Lambda(k,iota,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(1/(K_rice+1)) * sqrt(M) * sqrt(Omega(k,b)) * Lambda(k,iota,b) * eta(k,iota) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e1{k,b} ) );
        end
    end
end
% for k = 1:K
%     H{k} = [];
%     for b = 1:B
%         H{k} = [H{k} ; h{k,b} ];
%     end
% end








end