% 6DMA
clc;clear;

parfor i = 1:10000

Pt = 40;
Ptx = 10^( (Pt - 30)/10 ); sigma0 = 1e-8; R00 = 1;


format long

% %% ****************************************初始化参数************************************************************************************************************************************************************
for nummmmmm = 1
    % Ptx = 10;
    fc = 30e9;   %载波频率
    c = 3e8;      %光速
    lambda = c/fc;   %波长；
    dx = lambda/4;   %x轴方向天线间隔
    dy = lambda/4;  %y轴方向天线间隔
    Mx = 32; My = 32; M = Mx * My;
    Q  = 1; %每个全息超表面馈源个数
    Dx = Mx * dx;   Dy = My * dy;
    K_rice = 5;
    K = 7; %用户个数
    B = 7; %全息超表面个数，每个全息超表面上配备有M个元素
    NUM_Position = 100; %6DMA空间位置
    delta_x = ( 2 * [0:(Mx-1)].' - Mx + 1 )/2; delta_y = ( 2 * [ 0 : ( My - 1 ) ].' - My + 1 )/2;
    % delta_x = [0:(Mx-1)].';   delta_y = [0:(My-1)].';
    % Coor_Ele_init = [ kron( ones(My,1) , delta_x*dx ) , kron( delta_y*dy , ones(Mx,1) ) , zeros(M,1)  ];  %辐射元素坐标
    Coor_Ele_init = [ kron( delta_x*dx , ones(My,1) ) , kron( ones(Mx,1) , delta_y*dy ) , zeros(M,1)  ];  %辐射元素坐标
    dmin = 0.1;
% figure(1); plot( Coor_Ele_init(:,1) , Coor_Ele_init(:,2) , 'o' )
% % 
%% 引入全息超表面传输模型
Coor_Feed    = [ 0.002984305671304 , 0.001586131606604 , 0 ];   %馈源坐标
% Coor_Feed    = [ 0 , 3.838239570983593e-04 , 0 ];
Dis_Feed2Ele = sqrt( ( Coor_Ele_init - Coor_Feed ).^2 * ones(3,1) );    %馈源到元素的距离
V_F          = exp( - 1j * 2*pi*sqrt(3)/lambda * Dis_Feed2Ele );    %馈源响应向量
end



for  num = 1 : 1
%% 6DMA初始空间姿态
% Coor_Ele表示6DMA天线坐标，normal_vector是UPA的法向量
[ Coor_Ele , normal_vector , Rot_Matrix ] = Orientation_Initial(B,Coor_Ele_init,0);
%% 针对初始6DMA位置，生成无线信道
[ h , e0 , theta0, phi0 , theta_scatterer0 , phi_scatterer0 , Iota , eta , Omega ] = Channel_Generation_init( K,B,M,Mx,My,normal_vector,K_rice,Coor_Ele,lambda , Rot_Matrix );
%% 生成全息感知
[ error_theta , error_phi , error_varphi , est_direc_vector_rec , Rot_Matrix , normal_vector_rot ] = Sensing_Holographic_HalfWave1(B,M,Mx,My,lambda,delta_x,delta_y,dx,dy,K,h,Rot_Matrix,e0);
% est_direc_vector_rec：指向用户的方向向量
% normal_vector_rot：全息超表面的法向量
% Rot_Matrix：旋转矩阵
end

error_theta0(:,i) = error_theta;
error_phi0(:,i) = error_phi;
error_varphi0(:,i) = error_varphi;
for k00 = 1:K
    error0(k00,i) = norm([ error_theta0(k00,i) , error_phi0(k,i) , error_varphi0(k,i) ]);
end

end

% ( sum(sum( error_theta0.^2 )) + sum(sum( error_phi0.^2 )) + sum(sum( error_varphi0.^2 )) ) / ( numel(error_theta0) + numel(error_phi0) + numel(error_varphi0) )
% error_sen = [ error_theta0 + error_phi0 + error_varphi0 ];
% error_sen = norm([ error_theta0 , error_phi0 , error_varphi0 ]);
error_sen = error0;
num = 1;
Fre = [];
for epsilon = 0 : pi/128 : pi
    Fre(num) = numel( find( abs(error_sen) <= epsilon ) );
    num = num + 1;
end
Fre = Fre / numel( error_sen )
figure;plot( 0 : pi/128 : pi , Fre , '-' , 'linewidth' , 2 )









% 
% 
% 
% %B=7
% Fre0 = [0	0.208000000000000	0.374071428571429	0.508642857142857	0.607928571428571	0.680571428571429	0.733785714285714	0.769500000000000	0.790214285714286	0.807642857142857	0.819428571428571	0.830071428571429	0.838714285714286	0.845428571428571	0.851857142857143	0.857785714285714	0.863428571428571	0.867928571428571	0.872500000000000	0.876642857142857	0.880071428571429	0.884571428571429	0.887357142857143	0.891571428571429	0.894928571428571	0.898357142857143	0.902071428571429	0.906142857142857	0.909071428571429	0.913142857142857	0.917071428571429	0.921357142857143	0.924785714285714	0.929071428571429	0.932357142857143	0.935000000000000	0.937071428571429	0.939571428571429	0.941500000000000	0.942785714285714	0.944000000000000	0.945714285714286	0.947642857142857	0.948500000000000	0.950428571428571	0.952214285714286	0.953785714285714	0.955500000000000	0.957000000000000	0.958571428571429	0.959571428571429	0.960285714285714	0.960928571428572	0.961500000000000	0.962285714285714	0.963000000000000	0.964285714285714	0.965071428571429	0.967142857142857	0.968000000000000	0.969214285714286	0.970071428571429	0.970571428571429	0.971214285714286	0.971357142857143	0.971714285714286	0.972071428571429	0.972714285714286	0.973642857142857	0.974714285714286	0.975428571428571	0.976928571428572	0.977428571428571	0.978285714285714	0.978642857142857	0.979285714285714	0.979928571428572	0.980571428571429	0.981071428571429	0.981500000000000	0.982357142857143	0.983071428571429	0.983857142857143	0.984285714285714	0.984714285714286	0.985428571428571	0.986285714285714	0.986571428571429	0.987071428571429	0.987500000000000	0.988214285714286	0.988571428571429	0.989142857142857	0.989714285714286	0.990214285714286	0.990714285714286	0.991000000000000	0.991500000000000	0.992071428571429	0.992714285714286	0.993357142857143	0.993785714285714	0.994357142857143	0.994714285714286	0.994714285714286	0.995285714285714	0.995785714285714	0.996285714285714	0.997357142857143	0.998000000000000	0.998285714285714	0.998785714285714	0.999285714285714	0.999642857142857	0.999857142857143	1	1	1	1	1	1	1	1	1	1	1	1	1	1];
% Fre1 = [0	0.526666666666667	0.811547619047619	0.942500000000000	0.987142857142857	0.994285714285714	0.995476190476191	0.995714285714286	0.995833333333333	0.995833333333333	0.995833333333333	0.995952380952381	0.996071428571429	0.996190476190476	0.996190476190476	0.996309523809524	0.996428571428571	0.996547619047619	0.996666666666667	0.996666666666667	0.997023809523810	0.997023809523810	0.997023809523810	0.997261904761905	0.997380952380952	0.997380952380952	0.997500000000000	0.997738095238095	0.997857142857143	0.997857142857143	0.997857142857143	0.997857142857143	0.997857142857143	0.997857142857143	0.997857142857143	0.997857142857143	0.997857142857143	0.997857142857143	0.997976190476191	0.997976190476191	0.998095238095238	0.998095238095238	0.998095238095238	0.998214285714286	0.998214285714286	0.998214285714286	0.998214285714286	0.998214285714286	0.998214285714286	0.998333333333333	0.998333333333333	0.998452380952381	0.998571428571429	0.998571428571429	0.998571428571429	0.998571428571429	0.998571428571429	0.998690476190476	0.998809523809524	0.998809523809524	0.998928571428571	0.998928571428571	0.998928571428571	0.998928571428571	0.999047619047619	0.999047619047619	0.999047619047619	0.999047619047619	0.999047619047619	0.999047619047619	0.999047619047619	0.999285714285714	0.999285714285714	0.999404761904762	0.999404761904762	0.999404761904762	0.999404761904762	0.999523809523810	0.999523809523810	0.999523809523810	0.999523809523810	0.999523809523810	0.999523809523810	0.999523809523810	0.999523809523810	0.999523809523810	0.999523809523810	0.999523809523810	0.999523809523810	0.999523809523810	0.999523809523810	0.999523809523810	0.999523809523810	0.999523809523810	0.999642857142857	0.999642857142857	0.999642857142857	0.999642857142857	0.999642857142857	0.999642857142857	0.999642857142857	0.999642857142857	0.999642857142857	0.999642857142857	0.999642857142857	0.999642857142857	0.999642857142857	0.999642857142857	0.999642857142857	0.999642857142857	0.999642857142857	0.999642857142857	0.999642857142857	0.999761904761905	0.999761904761905	0.999761904761905	0.999761904761905	0.999761904761905	0.999761904761905	0.999761904761905	0.999761904761905	0.999761904761905	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952];
% Fre2 = [0	0.516309523809524	0.808571428571429	0.940952380952381	0.980833333333333	0.986547619047619	0.989047619047619	0.989761904761905	0.990000000000000	0.990238095238095	0.990357142857143	0.990476190476191	0.990595238095238	0.990952380952381	0.991071428571429	0.991071428571429	0.991428571428571	0.991785714285714	0.991904761904762	0.992142857142857	0.992261904761905	0.992261904761905	0.992380952380952	0.992500000000000	0.992738095238095	0.992976190476191	0.993095238095238	0.993095238095238	0.993452380952381	0.993809523809524	0.993928571428571	0.994047619047619	0.994047619047619	0.994523809523810	0.994642857142857	0.994761904761905	0.995000000000000	0.995000000000000	0.995119047619048	0.995119047619048	0.995119047619048	0.995238095238095	0.995476190476191	0.995595238095238	0.995595238095238	0.995595238095238	0.995714285714286	0.995952380952381	0.996071428571429	0.996190476190476	0.996190476190476	0.996190476190476	0.996190476190476	0.996190476190476	0.996309523809524	0.996309523809524	0.996547619047619	0.996666666666667	0.996904761904762	0.996904761904762	0.997142857142857	0.997261904761905	0.997261904761905	0.997380952380952	0.997380952380952	0.997500000000000	0.997738095238095	0.997738095238095	0.997857142857143	0.997976190476191	0.998095238095238	0.998095238095238	0.998095238095238	0.998214285714286	0.998214285714286	0.998333333333333	0.998452380952381	0.998690476190476	0.998690476190476	0.998690476190476	0.998809523809524	0.998809523809524	0.998809523809524	0.998809523809524	0.998809523809524	0.998928571428571	0.998928571428571	0.998928571428571	0.999166666666667	0.999404761904762	0.999404761904762	0.999404761904762	0.999404761904762	0.999404761904762	0.999404761904762	0.999404761904762	0.999404761904762	0.999404761904762	0.999404761904762	0.999404761904762	0.999404761904762	0.999404761904762	0.999404761904762	0.999642857142857	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952	0.999880952380952	1	1	1	1	1	1	1	1];
% Fre3 = [0	0.0108857142857143	0.0209142857142857	0.0309142857142857	0.0426000000000000	0.0577428571428571	0.0715714285714286	0.0847857142857143	0.0976571428571429	0.110257142857143	0.122100000000000	0.133971428571429	0.146271428571429	0.156271428571429	0.167057142857143	0.178614285714286	0.190857142857143	0.202228571428571	0.214357142857143	0.226757142857143	0.238514285714286	0.249657142857143	0.260000000000000	0.268400000000000	0.277128571428571	0.285285714285714	0.293571428571429	0.301528571428571	0.309300000000000	0.317657142857143	0.326085714285714	0.333457142857143	0.343057142857143	0.352342857142857	0.361271428571429	0.370328571428571	0.378542857142857	0.386557142857143	0.394200000000000	0.402400000000000	0.410342857142857	0.419242857142857	0.427542857142857	0.435300000000000	0.443557142857143	0.450214285714286	0.456900000000000	0.463185714285714	0.470128571428571	0.476542857142857	0.482800000000000	0.488728571428571	0.494100000000000	0.499742857142857	0.505100000000000	0.510928571428571	0.516871428571429	0.523100000000000	0.528857142857143	0.536328571428571	0.543185714285714	0.550485714285714	0.558085714285714	0.565100000000000	0.573100000000000	0.580914285714286	0.589757142857143	0.598285714285714	0.606342857142857	0.615014285714286	0.623157142857143	0.632185714285714	0.641871428571429	0.652357142857143	0.662057142857143	0.672271428571429	0.681528571428572	0.690800000000000	0.700657142857143	0.710228571428571	0.719328571428571	0.727657142857143	0.736471428571429	0.745357142857143	0.753885714285714	0.761414285714286	0.769885714285714	0.778271428571429	0.786114285714286	0.794057142857143	0.800885714285714	0.807600000000000	0.815057142857143	0.822085714285714	0.829185714285714	0.835328571428571	0.842700000000000	0.849457142857143	0.855671428571429	0.862200000000000	0.869128571428572	0.874885714285714	0.880871428571429	0.887171428571429	0.893714285714286	0.900471428571429	0.907300000000000	0.914885714285714	0.921057142857143	0.926628571428572	0.933871428571429	0.940342857142857	0.946357142857143	0.952214285714286	0.957300000000000	0.961971428571429	0.965857142857143	0.969157142857143	0.972414285714286	0.975785714285714	0.979285714285714	0.982228571428572	0.984028571428572	0.985385714285714	0.986900000000000	0.988028571428572	0.989628571428571	0.990857142857143	0.991628571428571];
% Fre4 = [0	0.0140285714285714	0.0279857142857143	0.0405000000000000	0.0532000000000000	0.0657285714285714	0.0776714285714286	0.0909714285714286	0.104614285714286	0.117585714285714	0.128857142857143	0.139942857142857	0.151085714285714	0.160828571428571	0.171171428571429	0.181957142857143	0.192128571428571	0.203171428571429	0.214371428571429	0.225414285714286	0.236442857142857	0.246871428571429	0.258685714285714	0.270271428571429	0.281628571428571	0.292185714285714	0.302085714285714	0.311871428571429	0.320985714285714	0.330600000000000	0.339971428571429	0.349600000000000	0.358628571428571	0.367600000000000	0.376614285714286	0.385000000000000	0.393600000000000	0.402157142857143	0.410742857142857	0.420000000000000	0.430042857142857	0.440557142857143	0.449742857142857	0.459314285714286	0.467900000000000	0.476300000000000	0.485400000000000	0.493800000000000	0.501857142857143	0.509400000000000	0.516514285714286	0.524900000000000	0.532671428571429	0.541371428571429	0.549457142857143	0.557600000000000	0.566385714285714	0.574342857142857	0.582128571428571	0.589871428571429	0.597971428571429	0.606157142857143	0.613971428571429	0.621557142857143	0.629657142857143	0.639242857142857	0.648900000000000	0.657985714285714	0.666642857142857	0.675257142857143	0.683385714285714	0.691542857142857	0.698242857142857	0.704771428571429	0.711700000000000	0.718557142857143	0.725571428571429	0.732471428571429	0.739157142857143	0.746028571428571	0.752742857142857	0.759900000000000	0.767457142857143	0.774671428571429	0.782014285714286	0.789542857142857	0.796600000000000	0.803842857142857	0.811128571428571	0.817957142857143	0.825271428571429	0.833228571428571	0.841557142857143	0.848685714285714	0.855342857142857	0.861714285714286	0.867771428571429	0.873928571428571	0.879942857142857	0.885842857142857	0.892485714285714	0.898157142857143	0.903471428571429	0.908600000000000	0.912842857142857	0.918071428571429	0.922700000000000	0.926700000000000	0.930471428571429	0.934771428571429	0.938728571428572	0.942428571428571	0.946242857142857	0.950328571428571	0.954200000000000	0.957828571428572	0.960842857142857	0.964328571428571	0.967571428571429	0.970728571428571	0.973257142857143	0.975528571428571	0.977900000000000	0.980414285714286	0.982442857142857	0.984371428571429	0.986228571428572	0.987971428571429	0.989628571428571];
% Fre5 = [0	0.0130285714285714	0.0263571428571429	0.0394428571428571	0.0533000000000000	0.0654142857142857	0.0776714285714286	0.0906571428571429	0.102328571428571	0.114185714285714	0.127271428571429	0.140257142857143	0.153100000000000	0.166471428571429	0.179057142857143	0.191485714285714	0.204571428571429	0.217557142857143	0.230714285714286	0.241871428571429	0.253614285714286	0.264671428571429	0.276071428571429	0.288342857142857	0.299828571428571	0.311085714285714	0.322957142857143	0.334614285714286	0.346142857142857	0.357385714285714	0.368757142857143	0.379900000000000	0.391171428571429	0.401157142857143	0.411142857142857	0.420814285714286	0.430085714285714	0.439600000000000	0.449285714285714	0.459200000000000	0.468485714285714	0.477685714285714	0.486828571428571	0.495885714285714	0.504885714285714	0.513585714285714	0.522571428571429	0.531257142857143	0.540071428571429	0.548228571428571	0.556371428571429	0.564328571428571	0.572414285714286	0.580542857142857	0.588885714285714	0.597214285714286	0.605871428571429	0.614714285714286	0.622728571428571	0.630771428571429	0.639285714285714	0.647257142857143	0.655128571428571	0.663071428571429	0.671414285714286	0.679785714285714	0.688457142857143	0.696671428571429	0.704871428571429	0.712042857142857	0.720185714285714	0.727685714285714	0.734428571428571	0.742100000000000	0.749142857142857	0.756042857142857	0.762828571428571	0.769885714285714	0.778342857142857	0.785771428571429	0.792385714285714	0.798757142857143	0.806214285714286	0.813514285714286	0.820257142857143	0.827328571428571	0.833714285714286	0.839700000000000	0.846014285714286	0.852057142857143	0.857614285714286	0.863428571428571	0.868657142857143	0.875271428571429	0.881542857142857	0.887214285714286	0.892414285714286	0.897557142857143	0.902485714285714	0.907242857142857	0.911885714285714	0.916228571428571	0.920442857142857	0.924471428571429	0.928142857142857	0.932357142857143	0.936571428571429	0.940714285714286	0.945171428571429	0.949014285714286	0.952657142857143	0.956371428571429	0.960142857142857	0.963014285714286	0.965571428571429	0.968228571428571	0.970514285714286	0.972500000000000	0.974600000000000	0.976800000000000	0.978757142857143	0.980871428571429	0.982757142857143	0.984642857142857	0.986485714285714	0.988371428571429	0.989828571428571	0.991342857142857	0.992700000000000];
% 
% figure(5); 
% plot( 0 : pi/128 : pi , Fre1 , '-' , 'color' , [25 72 156]/256 , 'linewidth' , 2 )
% hold on; plot( 0 : pi/128 : pi , Fre2 , '-' , 'color' , [113 193 147]/256 , 'linewidth' , 2 )
% hold on; plot( 0 : pi/128 : pi , Fre3 , '-' , 'color' , [185 159 201]/256 , 'linewidth' , 2 )
% hold on; plot( 0 : pi/128 : pi , Fre4 , '-' , 'color' , [228 101 100]/256 , 'linewidth' , 2 )
% hold on; plot( 0 : pi/128 : pi , Fre5 , '-' , 'color' , [84 138 202]/256 , 'linewidth' , 2 )
% hold on; plot( 0 : pi/128 : pi , Fre0 , '--' , 'color' , [231 37 25]/256 , 'linewidth' , 2 )
% 
% axis([0,2,0,1])
% grid on;
% xlabel('Sensing error','fontsize',12,'fontname','timesnewroman');
% ylabel('CDF','fontsize',12,'fontname','timesnewroman');
% legend( 'Proposed sensing method, $\kappa=0$' , 'Proposed sensing method, $\kappa=1$' , 'Proposed sensing method, $\kappa=2$' , 'Proposed sensing method, $\kappa=3$' , 'Proposed sensing method, $\kappa=4$' , 'LS-based sensing method' , 'fontsize' , 12 , 'interpreter' , 'latex' , 'location' , 'southeast' )
