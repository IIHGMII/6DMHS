function [ h , e0 , theta, phi , theta_scatterer , phi_scatterer , IOTA , eta , Omega ] = Channel_Generation_init( K,B,M,Mx,My,normal_vector,K_rice,Coor_Ele,lambda , Rot_Matrix )

    dx = lambda/4;   %x轴方向天线间隔
    dy = lambda/4;  %y轴方向天线间隔
    delta_x = ( 2 * [0:(Mx-1)].' - Mx + 1 )/2; delta_y = ( 2 * [0:( My-1)].' - My + 1 )/2;
%% 针对初始6DMA位置，生成无线信道
PL    = 32.4 + 17.3 * log10( 6.5 ) + 20 * log10( 30 ) - 26 ; % Path-loss,包含20dB天线增益
Omega = 10^( -PL/10 ) * ones(K,B);  % path-loss
IOTA  = 10;         % 散射体数量
theta =  rand(K,1) * 2 * pi; phi = rand(K,1) * 2 * pi; % K个用户的水平角和俯仰角
% theta = 5.263863993147139 ; phi =  1.057064847365129;
theta_scatterer = rand(K,IOTA) * 2 * pi; phi_scatterer = rand(K,IOTA) * 2 * pi; % K个用户的水平角和俯仰角
% NLoS链路信道
for k = 1:K
    for iota = 1:IOTA
        eta(k,iota) = 1/sqrt(IOTA) * Omega(1) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
    end
end

 theta = [5.56150567746355
0.544618616193327
3.76957278852643
6.18889329855181
5.41609631831957
3.18024248225098
1.07202202092093];
phi = [1.30441357562691
2.49965327527655
0.0973964446520828
3.10543240316852
5.50933879826271
0.394253894614149
1.65833593392141];
theta_scatterer = [1.91590425158871	0.265338348866427	2.04914054462908	2.79862688767983	4.42758805666191	1.09301317589277	1.07102450055012	2.22634443102480	2.74072915768529	2.99345483845754
4.33128950963036	2.97876329813868	2.76087386796630	4.75423470591590	2.10434185452095	0.320256542091208	5.29204516489173	2.73889344513458	5.54674812315223	5.79189736422242
5.52085085232285	3.59681797097374	1.24980796207364	2.84319584456490	0.124628184958360	4.09042143303886	2.31467642713703	3.46383189737913	1.26562114186101	5.90213551673225
5.15281718544948	0.188066881439789	3.90378138827372	3.43521236239143	4.14657726597974	2.55916702508237	0.153915455275897	4.03981022275273	0.792660992821542	1.80591713784213
4.19077777951697	2.16263421068109	5.59142549390012	2.14422507307298	5.01729596650904	0.652868913151321	5.65233033958489	5.32718011525534	6.05282372538921	1.17814713882395
4.78451461789179	5.28057591032302	2.39278727418083	3.36032434971745	2.14251045267839	1.40748283078989	4.13704665187027	3.52451980383951	2.98137827830127	5.21905279326013
1.86091292919777	0.677879890472584	2.32412201607231	2.40711342177947	3.12154374099883	0.873311418121603	4.53049183980813	3.76090479999273	2.37871106067626	5.90305831535779];
phi_scatterer = [0.209582806217147	1.27876454554395	5.18392856014415	0.581327272131381	4.25501600907151	1.66649141421846	4.83985981897832	4.87712300424821	4.50443451677538	4.02592132227322
2.88476501529348	1.26015161517709	2.67233109016678	3.94557615916233	4.49819052336078	2.00665648779557	5.47914603604942	3.80750084263426	0.470217266842246	3.33986114990073
1.31740737173775	3.90879190919652	2.35308951047829	4.58186315476696	1.97344290001256	0.862919053582447	5.80027669471882	1.22706119493031	0.962711030390937	3.06022536888049
5.13122203182582	5.62793294636875	5.37732174036540	5.09008451245570	5.05405188916222	4.78108044351591	4.76728462844063	4.06305316827628	5.52743697038817	4.02563723728344
4.72943345466788	3.42436011975110	2.85808869250311	4.66717299829237	3.95762064474512	4.92979075584389	3.46099166038106	0.118111812203389	5.13319397962768	4.90925988188596
3.16606064155775	1.98190762191186	1.34537129220607	3.45078508760621	3.72863512220067	5.25538442954615	3.87986576237456	5.05623280579102	0.476899232984900	5.89042440633360
1.24263511301963	0.985809124549047	4.21560621184937	2.98961872370659	5.65163857313305	2.59381656447147	1.91845678656719	4.61057984795201	0.611604029937364	3.96138057674274];

eta = [-1.05826308810623e-06 - 3.72574349642599e-06i	4.26734242822332e-08 - 1.86025304223247e-07i	-9.39767437599891e-07 - 2.06019085831655e-06i	8.64709967465329e-07 + 2.31656095983513e-06i	3.12206454799390e-06 + 3.92064785317038e-06i	1.33716542405542e-06 - 7.12855834379150e-07i	2.15844265164858e-06 + 1.07100822693715e-06i	-1.03355042649328e-06 - 3.09386115592473e-07i	1.69961823946369e-06 + 8.39846342114877e-08i	-4.52114239196950e-07 - 4.44494720015707e-07i
-1.14179293837707e-07 + 2.07239386539456e-06i	-3.67435764097636e-06 + 1.36212875039304e-06i	1.60012140072686e-06 - 3.95775374697642e-06i	2.64278933600546e-06 + 2.96372161635348e-06i	2.71869873140286e-07 - 2.49505032421484e-08i	2.21657546642086e-06 - 2.11646828212523e-06i	-6.10699462223100e-07 + 1.82368708655613e-06i	-2.47116274169708e-06 + 3.82866881915961e-07i	3.88983052058085e-06 - 8.81161802032074e-07i	1.65159888295294e-06 - 3.52253746338817e-06i
1.76030016727609e-06 - 4.53771598287714e-06i	-1.71283766735954e-06 - 6.80816400448172e-08i	2.15692302831017e-06 - 3.21582117641093e-06i	9.69692498596426e-07 + 1.94465284596939e-06i	-5.46727367824145e-07 + 1.02513988033808e-06i	-2.52961285480812e-06 - 1.90387483889199e-06i	-3.12321868810101e-06 + 1.78736597890018e-06i	-3.39038396555443e-06 + 4.02762498518474e-07i	8.51985083395914e-07 - 2.49078783345994e-07i	4.35428217551392e-06 - 2.27121407183285e-06i
4.41830042903718e-06 + 9.69616331497167e-07i	1.97875018171762e-06 - 1.00858676043361e-06i	3.67763776890432e-06 - 1.77675798951967e-06i	-1.53671397696752e-06 + 4.14697547607000e-07i	1.05887081920914e-06 + 2.04206869676843e-06i	-1.90150571662594e-06 + 2.69311885387957e-06i	-3.43418003713019e-06 + 6.38996516685624e-07i	-3.82223528023512e-06 + 1.38015338826667e-06i	-5.04615469467543e-07 + 5.30876741008420e-07i	-2.70341732680187e-06 - 1.70598816510794e-06i
1.43885441858590e-06 + 7.86248734756384e-07i	-2.96592471628399e-09 - 1.78814162777040e-06i	-1.94710167840217e-06 + 9.06185409322598e-07i	-1.98098680772962e-06 - 6.10321293756286e-07i	7.37618004437341e-07 - 1.98749635203151e-06i	-5.39902549960628e-06 + 1.30990382885860e-06i	2.06081600859269e-06 - 5.31164317727420e-07i	-4.18214192666012e-07 + 1.50750005823689e-06i	1.42015205001935e-06 - 6.48921667875968e-07i	4.80163674731740e-06 + 3.07097971808673e-06i
1.82257723981370e-06 + 2.12998958187655e-06i	1.49840852293034e-06 - 5.73591425943034e-07i	-1.23666514186077e-06 + 2.95490429410012e-07i	3.59665328207211e-06 - 3.30748521427993e-06i	2.00185881660316e-06 + 1.96556657342576e-06i	5.15144542929968e-06 + 2.30865655786300e-06i	2.45031056053056e-06 - 2.57097557888445e-06i	3.35481717494946e-06 + 1.92034597108236e-06i	-1.05891164360178e-06 - 2.38023271121215e-06i	-2.45619893884420e-06 - 1.68311706075022e-06i
-3.41749859346504e-06 - 3.34467923690868e-06i	-1.68318719016904e-06 - 2.33703756002814e-06i	2.19698997126081e-06 + 8.73636047498078e-07i	-4.53764361195302e-06 - 7.47382490933467e-07i	-8.65238281623844e-07 - 2.62821494773777e-07i	2.57016194304689e-06 + 1.04197111429365e-07i	2.88171137943057e-07 + 2.22276498023611e-06i	-7.81696871779412e-07 - 1.77869842288910e-06i	1.77601122732819e-06 - 1.43007682728833e-06i	1.78412474625487e-06 - 1.50746252154402e-06i];

%% 生成无线信道
% LoS链路信道
for k = 1:K
    for b = 1:B
        h{k,b} = sparse(M,1);%%%%%%%%%%%%%%%%%%%%%注意
            e0{k} = [ sin(phi(k)) * cos(theta(k)) ; sin(phi(k)) * sin(theta(k)) ; cos(phi(k)) ];
            % e = Rot_Matrix{b}.' * e0;
            if dot( normal_vector{b} , e0{k} ) > 0
                Lambda_LoS(k,b) = 1;
            else
                Lambda_LoS(k,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(K_rice/(K_rice+1)) * sqrt(M) * sqrt(Omega(k,b)) * Lambda_LoS(k,b) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e0{k} ) );
    end
end

%% 测试
for b = 1:B
    Px{b}    = dx * Rot_Matrix{b} * [1;0;0];
    Py{b}    = dy * Rot_Matrix{b} * [0;1;0];
    T{b}     = exp( 1j * 2*pi/lambda * ( kron( delta_x * ( Px{b}.' * e0{1} ) , ones(1,My) ) + kron( ones(Mx,1) , delta_y.' * ( Py{b}.' * e0{1} ) ) ) );

end








for k = 1:K
    for b = 1:B
        % h{k,b} = 0;%%%%%%%%%%%%%%%%%%%%%注意
        for iota = 1:IOTA
            % eta(k,iota,b) = 1/sqrt(IOTA) * Omega(k,b) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
            e1{k,b} = [ sin(phi_scatterer(k)) * cos(theta_scatterer(k)) ; sin(phi_scatterer(k)) * sin(theta_scatterer(k)) ; cos(phi_scatterer(k)) ];
            % e = Rot_Matrix{b}.' * e;
            if dot( normal_vector{b} , e1{k,b} ) > 0
                Lambda(k,iota,b) = 1;
            else
                Lambda(k,iota,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(1/(K_rice+1)) * sqrt(M) * Lambda(k,iota,b) * eta(k,iota) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e1{k,b} ) );
        end
    end
end
% for k = 1:K
%     H{k} = [];
%     for b = 1:B
%         H{k} = [H{k} ; h{k,b} ];
%     end
% end








end