% 6DMA,使用全息感知方法
clc;clear;

Pt = 40;
Ptx = 10^( (Pt - 30)/10 ); sigma0 = 1e-7; R00 = 1;
kappa0 = 3; % 2 3 5 9 17

format long

% %% ****************************************初始化参数************************************************************************************************************************************************************

for nummmmmm = 1:1
    % Ptx = 10;
    fc = 30e9;   %载波频率
    c = 3e8;      %光速
    lambda = c/fc;   %波长
    dx = lambda/4;   %x轴方向天线间隔
    dy = lambda/4;  %y轴方向天线间隔
    Mx = 32; My = 32; M = Mx * My;
    Q  = 1; %每个全息超表面馈源个数
    Dx = Mx * dx;   Dy = My * dy;
    K_rice = 3.16;
    K = 6; %用户个数
    B = 6; %全息超表面个数，每个全息超表面上配备有M个元素
    NUM_Position = 100; %6DMA空间位置
    delta_x = ( 2 * [0:(Mx-1)].' - Mx + 1 )/2; delta_y = ( 2 * [ 0 : ( My - 1 ) ].' - My + 1 )/2;
    % delta_x = [0:(Mx-1)].';   delta_y = [0:(My-1)].';
    % Coor_Ele_init = [ kron( ones(My,1) , delta_x*dx ) , kron( delta_y*dy , ones(Mx,1) ) , zeros(M,1)  ];  %辐射元素坐标
    Coor_Ele_init = [ kron( delta_x*dx , ones(My,1) ) , kron( ones(Mx,1) , delta_y*dy ) , zeros(M,1)  ];  %辐射元素坐标
    dmin = 0.1;
% figure(1); plot( Coor_Ele_init(:,1) , Coor_Ele_init(:,2) , 'o' )
% % 
%% 引入全息超表面传输模型
Coor_Feed    = [ 0.002984305671304 , 0.001586131606604 , 0 ];   %馈源坐标
% Coor_Feed    = [ 0 , 3.838239570983593e-04 , 0 ];
Dis_Feed2Ele = sqrt( ( Coor_Ele_init - Coor_Feed ).^2 * ones(3,1) );    %馈源到元素的距离
V_F0          = exp( - 1j * 2*pi*sqrt(3)/lambda * Dis_Feed2Ele );    %馈源响应向量
eta0 = 8/3/M;
V_F = sqrt(eta0) * V_F0;

end


NUM = 1000;
parfor  num = 1 : NUM
%% 6DMA初始空间姿态
% Coor_Ele表示6DMA天线坐标，normal_vector是UPA的法向量
[ Coor_Ele , normal_vector , Rot_Matrix ] = Orientation_Initial(B,Coor_Ele_init,0);
%% 针对初始6DMA位置，生成无线信道
[ h , e0 , theta0, phi0 , theta_scatterer0 , phi_scatterer0 , Iota , eta , Omega ] = Channel_Generation_init( K,B,M,Mx,My,normal_vector,K_rice,Coor_Ele,lambda , Rot_Matrix );
%% 生成全息感知
[ error_theta , error_phi , error_varphi , est_direc_vector_rec , Rot_Matrix , normal_vector_rot ] = Sensing_Holographic_HalfWave1(B,M,Mx,My,lambda,delta_x,delta_y,dx,dy,K,h,Rot_Matrix,e0,kappa0);
% est_direc_vector_rec：指向用户的方向向量
% normal_vector_rot：全息超表面的法向量
% Rot_Matrix：旋转矩阵
E(:,:,num) = [error_theta , error_phi , error_varphi];
E1(:,num) = ( error_theta.^2 + error_phi.^2 + error_varphi.^2 );
end

RMSE = sqrt(E1);
RMSE = vec(RMSE);

% MSE = (sum( E.^2 , 'all' )) / NUM / 3 / K ;
% disp( MSE );
% fprintf('\n');
% disp('Running Over!');
% fprintf('\n');
% % []
% 
% E_vec = reshape(E,3*B*NUM,1);
% E_vec = sqrt(E_vec);
% f0=0;
% f=[];
% for num = 1:128
%     f(1,num) = length(  find( abs(E_vec) <= ( num * pi/128 )  ) );
% %     f0 = f(1,num);
% end
% 
% f = [0,f]/(3*B*NUM);
% figure(1); plot( [0:128]/128*pi , f , '-' )

% 
f1= [];
for num = 1:128
    f1(1,num) = length(  find( abs(RMSE) <= ( num * pi/128 )  ) );
%     f0 = f(1,num);
end
f1 = [0,f1]/(NUM*K);


figure(1); plot( [0:128]/128*pi , f1 , '-' )


% f1 = [0	0.756476190476191	0.969571428571429	0.995714285714286	0.996476190476191	0.996761904761905	0.996904761904762	0.996952380952381	0.997000000000000	0.997000000000000	0.997142857142857	0.997285714285714	0.997476190476191	0.997571428571429	0.997857142857143	0.998000000000000	0.998047619047619	0.998142857142857	0.998238095238095	0.998285714285714	0.998333333333333	0.998428571428571	0.998476190476191	0.998523809523810	0.998523809523810	0.998666666666667	0.998761904761905	0.998761904761905	0.998761904761905	0.998904761904762	0.998904761904762	0.999047619047619	0.999095238095238	0.999095238095238	0.999095238095238	0.999190476190476	0.999285714285714	0.999333333333333	0.999333333333333	0.999380952380952	0.999380952380952	0.999380952380952	0.999380952380952	0.999428571428571	0.999428571428571	0.999476190476191	0.999476190476191	0.999476190476191	0.999523809523810	0.999619047619048	0.999619047619048	0.999619047619048	0.999666666666667	0.999761904761905	0.999761904761905	0.999761904761905	0.999857142857143	0.999857142857143	0.999857142857143	0.999857142857143	0.999857142857143	0.999857142857143	0.999857142857143	0.999904761904762	0.999952380952381	0.999952380952381	0.999952380952381	0.999952380952381	0.999952380952381	0.999952380952381	0.999952380952381	0.999952380952381	0.999952380952381	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1];
% f2 = [0	0.752666666666667	0.960333333333333	0.986714285714286	0.987952380952381	0.988380952380952	0.989238095238095	0.989809523809524	0.990714285714286	0.991095238095238	0.991666666666667	0.991904761904762	0.992380952380952	0.992666666666667	0.993000000000000	0.993476190476191	0.993714285714286	0.994142857142857	0.994476190476191	0.994619047619048	0.994809523809524	0.995047619047619	0.995238095238095	0.995380952380952	0.995476190476191	0.995619047619048	0.995761904761905	0.996000000000000	0.996095238095238	0.996095238095238	0.996380952380952	0.996523809523810	0.996714285714286	0.996904761904762	0.997142857142857	0.997333333333333	0.997571428571429	0.997714285714286	0.997761904761905	0.997761904761905	0.997857142857143	0.998000000000000	0.998142857142857	0.998285714285714	0.998523809523810	0.998761904761905	0.998761904761905	0.998761904761905	0.998857142857143	0.998857142857143	0.998904761904762	0.998952380952381	0.999000000000000	0.999000000000000	0.999000000000000	0.999000000000000	0.999047619047619	0.999142857142857	0.999190476190476	0.999190476190476	0.999190476190476	0.999238095238095	0.999571428571429	0.999714285714286	0.999761904761905	0.999809523809524	0.999809523809524	0.999809523809524	0.999809523809524	0.999857142857143	0.999857142857143	0.999904761904762	0.999904761904762	0.999952380952381	0.999952380952381	0.999952380952381	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1];
% f3 = [0	0.0237619047619048	0.0469047619047619	0.0695238095238095	0.0935714285714286	0.114952380952381	0.135000000000000	0.158333333333333	0.178761904761905	0.197285714285714	0.217476190476191	0.238952380952381	0.258714285714286	0.279285714285714	0.297857142857143	0.315523809523810	0.331238095238095	0.346428571428571	0.362619047619048	0.378809523809524	0.395333333333333	0.409142857142857	0.423238095238095	0.437952380952381	0.451571428571429	0.463000000000000	0.475523809523810	0.487809523809524	0.499047619047619	0.511095238095238	0.522571428571429	0.533571428571429	0.544190476190476	0.554809523809524	0.567190476190476	0.577857142857143	0.589190476190476	0.600857142857143	0.613857142857143	0.625523809523810	0.637857142857143	0.650285714285714	0.661047619047619	0.674285714285714	0.684285714285714	0.696619047619048	0.711571428571429	0.721333333333333	0.731714285714286	0.744190476190476	0.757904761904762	0.772952380952381	0.785000000000000	0.797190476190476	0.809285714285714	0.820952380952381	0.832142857142857	0.842333333333333	0.852619047619048	0.861428571428571	0.872285714285714	0.880952380952381	0.888857142857143	0.897476190476190	0.904714285714286	0.912666666666667	0.919095238095238	0.927190476190476	0.933571428571429	0.940000000000000	0.945904761904762	0.951190476190476	0.955857142857143	0.961285714285714	0.966333333333333	0.971761904761905	0.979238095238095	0.983190476190476	0.989523809523810	0.993857142857143	0.996809523809524	0.998952380952381	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1];
% f4 = [0	0.0236190476190476	0.0457142857142857	0.0674285714285714	0.0877619047619048	0.108380952380952	0.129523809523810	0.151047619047619	0.172714285714286	0.192142857142857	0.212666666666667	0.234333333333333	0.256238095238095	0.275619047619048	0.296190476190476	0.314857142857143	0.332857142857143	0.351809523809524	0.371333333333333	0.388761904761905	0.405952380952381	0.423000000000000	0.438619047619048	0.455047619047619	0.470476190476191	0.486761904761905	0.501428571428571	0.517666666666667	0.533904761904762	0.551095238095238	0.568761904761905	0.585714285714286	0.601428571428571	0.617238095238095	0.630285714285714	0.644238095238095	0.659190476190476	0.672333333333333	0.684190476190476	0.697666666666667	0.708952380952381	0.720428571428571	0.732380952380952	0.743190476190476	0.753952380952381	0.764666666666667	0.774571428571429	0.784142857142857	0.794571428571429	0.805523809523810	0.816047619047619	0.825952380952381	0.835714285714286	0.846428571428571	0.855142857142857	0.864238095238095	0.871714285714286	0.879857142857143	0.888190476190476	0.895761904761905	0.903095238095238	0.909571428571429	0.916285714285714	0.921904761904762	0.927714285714286	0.934904761904762	0.941333333333333	0.948047619047619	0.954571428571429	0.961095238095238	0.966857142857143	0.972047619047619	0.976666666666667	0.980857142857143	0.985238095238095	0.988476190476191	0.991619047619048	0.994523809523810	0.996571428571429	0.998523809523810	0.999571428571429	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1];
% f5 = [0	0.0241904761904762	0.0472380952380952	0.0708571428571429	0.0963333333333333	0.120238095238095	0.142047619047619	0.163285714285714	0.184571428571429	0.208476190476190	0.230952380952381	0.252190476190476	0.274904761904762	0.295666666666667	0.316523809523810	0.336809523809524	0.355380952380952	0.375047619047619	0.396238095238095	0.414476190476191	0.434190476190476	0.451190476190476	0.468238095238095	0.486190476190476	0.505285714285714	0.520761904761905	0.538047619047619	0.554428571428571	0.571714285714286	0.586952380952381	0.602761904761905	0.618904761904762	0.633904761904762	0.648285714285714	0.662476190476190	0.676380952380952	0.690333333333333	0.704428571428571	0.717238095238095	0.729428571428571	0.741238095238095	0.753333333333333	0.764476190476191	0.776476190476190	0.787142857142857	0.797857142857143	0.808333333333333	0.818523809523810	0.828476190476191	0.837952380952381	0.846428571428571	0.853666666666667	0.862095238095238	0.869238095238095	0.877238095238095	0.884857142857143	0.891761904761905	0.898238095238095	0.904904761904762	0.911714285714286	0.917285714285714	0.922571428571429	0.929619047619048	0.934952380952381	0.941095238095238	0.947761904761905	0.953238095238095	0.958095238095238	0.962904761904762	0.967523809523810	0.971285714285714	0.975095238095238	0.978142857142857	0.981190476190476	0.983857142857143	0.987333333333333	0.990952380952381	0.994095238095238	0.996047619047619	0.997333333333333	0.999142857142857	0.999619047619048	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1];
% 
% figure; plot( 0:pi/128:pi , f1 , '-' , 0:pi/128:pi , f2 , '--'  );
% 
% axis([0 0.5 0 1]);









