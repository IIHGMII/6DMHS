function [ h , e0 , theta, phi , theta_scatterer , phi_scatterer , IOTA , eta , Omega ] = Channel_Generation_init( K,B,M,Mx,My,normal_vector,K_rice,Coor_Ele,lambda , Rot_Matrix )

    dx = lambda/4;   %x轴方向天线间隔
    dy = lambda/4;  %y轴方向天线间隔
    delta_x = ( 2 * [0:(Mx-1)].' - Mx + 1 )/2; delta_y = ( 2 * [0:( My-1)].' - My + 1 )/2;
%% 针对初始6DMA位置，生成无线信道
PL    = 32.4 + 17.3 * log10( 6.5 ) + 20 * log10( 30 ) - 26 ; % Path-loss,包含20dB天线增益
Omega = 10^( -PL/10 ) * ones(K,B);  % path-loss
IOTA  = 10;         % 散射体数量
theta =  rand(K,1) * 2 * pi; phi = rand(K,1) * 2 * pi; % K个用户的水平角和俯仰角
% theta = 5.263863993147139 ; phi =  1.057064847365129;
theta_scatterer = rand(K,IOTA) * 2 * pi; phi_scatterer = rand(K,IOTA) * 2 * pi; % K个用户的水平角和俯仰角
% NLoS链路信道
for k = 1:K
    for iota = 1:IOTA
        eta(k,iota) = 1/sqrt(IOTA) * Omega(1) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
    end
end


theta = [0.0838472878242815
3.96011810366780
4.25941459860818
1.37928341855050
0.848734778059603
5.58889295195453
5.28436453333539];
phi = [2.82577683616904
1.84326571494913
4.66960452970709
3.52999738478666
4.15663581291932
2.55672854356294
4.29965939850484];
theta_scatterer = [6.07195861402081	3.18506759392930	2.49941534018178	4.31085775772239	3.90452911458214	4.37897318611470	5.63564916305958	3.51739300009435	2.26025817475106	1.13796972496217
6.07576117189340	4.73712373710213	0.172795817092508	3.85113362569317	3.86440990479253	0.751805447555838	1.68699672674607	2.21900715873659	1.30763903792238	3.42641779361426
2.90377861887914	1.87512434626038	5.30175247718397	5.48861506728826	2.28262370804627	3.79589895089841	5.79396501460165	0.198321861913254	4.54708422913727	3.38834050595088
0.270852298949120	5.36368607211719	0.682322518727661	0.674566083201947	1.24924891890594	1.51249461541003	5.39112212482625	2.96008865365368	3.76209901599179	4.17719866239946
5.85625054804672	0.490126621919387	2.78105841710706	0.983665714568692	0.346542594258751	1.28227557747579	2.51599014477300	2.24008516554948	3.67420077233268	4.69689450763807
4.26035223718423	0.555050025091997	0.823487271921480	3.21636673872541	5.14694867272879	0.0849551519916050	2.34026654407829	5.59486212832619	1.38155488479250	3.24614730765811
0.374964520377603	2.57107164598794	3.07068219117814	3.37097872762062	1.77367426852402	0.787452724691584	2.30807971657348	0.0348164119813104	1.74344069084805	5.11598465673519];
phi_scatterer  = [2.72636033591023	0.304338059860813	6.09001817914705	4.18876936777923	0.733081760500872	1.34038420214200	5.74382300848221	1.71821143722361	0.0936678514603466	2.44412545047254
3.39266918959637	1.31897128200522	4.75128361413264	3.74308728513866	4.26514234140973	0.115951069168985	2.20715343695350	2.49146555630698	3.83705023772867	3.68234645701858
1.43132392709323	0.386278331637603	3.56453551022264	1.61218611061349	3.58557640708587	5.88796428592122	1.34425643734509	4.90800229013873	4.63499681757859	3.26965756527863
2.70327076570231	3.93862924186160	3.06008466239320	1.46535191116332	3.23683732683858	3.26452586013122	3.68902597327066	3.96803760560202	0.191336046475123	5.01821446119910
1.66784124368170	0.560114894011827	1.17335922417998	1.68781375865237	4.06067242594103	0.247563436877876	1.90504100778722	2.71117934193301	1.80621451331238	1.47815857693184
0.159229615700266	4.24903929407678	6.17762438609193	5.73708716480537	0.0631562583946007	2.11006630623836	2.55011292568862	3.32586364046888	2.70476987808869	5.68855970355720
5.63121381606275	4.44576361132800	1.15630168169452	1.89953671325371	4.08007994434718	1.45699041320537	1.28930881402380	5.00018952703162	2.11510531890347	4.35630363534031];
eta = [3.49771466507418e-06 + 1.60019488844790e-06i	-3.33062204570746e-06 - 3.23364151739972e-06i	2.89996537466280e-06 + 4.62944541201617e-07i	2.43233673353300e-06 - 5.50965237109260e-07i	2.07906893110098e-06 + 1.27005791087736e-08i	4.82581816596713e-06 + 1.92772022489947e-06i	-2.22306732417021e-06 + 2.43659263527263e-06i	-4.19049239682482e-08 - 4.22240167882933e-07i	2.08627537729352e-06 - 3.67113183697451e-06i	-3.45070947062821e-07 + 3.06224211197158e-06i
-1.24969255700024e-06 + 9.09945658923377e-07i	2.57591380361350e-06 - 9.86407719952672e-07i	-6.30135877540986e-07 - 3.76560615057920e-06i	4.07355246487376e-06 + 7.57456734614710e-07i	-2.66822995233558e-06 - 3.90344807704259e-06i	-6.32047968824070e-08 - 2.58124804131972e-06i	4.80149330300926e-07 + 1.12215567874040e-06i	1.05297877852704e-06 + 1.86924934453913e-06i	8.45582000246554e-07 - 2.69757214822245e-07i	7.01119653113084e-06 - 2.44553319620277e-06i
1.81889354935699e-07 + 4.86707490695602e-06i	1.52066949489527e-06 + 2.30214059197950e-06i	-3.06276994416009e-06 - 3.70337686884151e-07i	2.70142939366612e-06 + 1.10524210267553e-06i	2.01386870362593e-06 + 1.29141221620335e-06i	-2.78218730464935e-06 + 9.73506441484608e-07i	5.63347471133838e-08 - 2.40893023390159e-07i	4.76719723399958e-07 + 1.42073536990367e-06i	-1.40272947256649e-06 + 1.69913751847973e-07i	-1.87318729194438e-07 + 2.26630398372391e-06i
-4.00989297385232e-06 + 1.02803414833954e-06i	1.72904820304781e-07 - 6.11189730511856e-07i	-8.58217721172574e-07 + 6.18261486560074e-06i	-1.59016096599654e-06 + 2.90461401282103e-06i	4.45214191734871e-06 + 2.99970763090929e-07i	-5.00127101237451e-06 - 3.12218936732173e-06i	1.21695052860260e-06 + 2.81087660729998e-07i	-3.41767737186682e-07 + 3.33870030587273e-07i	3.89905024218520e-06 + 1.24633508916405e-06i	3.41786797363232e-07 - 1.14600106691948e-06i
-7.00562384265041e-07 + 7.60810174448889e-08i	-2.38794653469756e-06 - 1.80816578349132e-06i	-3.96523924844036e-06 - 4.50154470116226e-06i	9.45730935000928e-07 + 1.85304409076662e-06i	6.23559382402282e-07 + 1.62947195773686e-06i	1.67750684079815e-06 - 3.32237098672612e-06i	1.06585963305717e-06 - 2.01007180053423e-06i	1.23975070335187e-07 - 7.83770063930482e-07i	2.23277161333903e-06 + 7.39922065389190e-07i	-4.17133086544327e-07 + 2.08122279993412e-06i
-4.73814817934272e-06 + 3.99173693109589e-06i	4.25485244623940e-07 + 3.88720072434092e-06i	2.02526447139190e-06 + 1.98319674177314e-07i	-6.17780097884695e-07 - 8.10286357350906e-07i	-1.35345118703485e-06 + 2.34128213620994e-06i	3.99985621486158e-06 - 3.43126577827961e-07i	3.05501675327388e-06 - 3.73248295073736e-06i	-3.66071683078375e-06 - 1.37781316350819e-06i	7.06332059172770e-08 - 2.71269614099430e-06i	-3.57597226599656e-07 + 2.24532187134771e-06i
3.30744813697824e-06 - 3.58290480504988e-06i	7.96347890905572e-07 - 5.12155745173416e-07i	-1.92927266787060e-06 - 2.24891344388082e-07i	2.47836961920453e-06 - 6.45376663768425e-07i	-5.43345752957291e-07 - 3.45595379416254e-06i	-1.68294078915533e-06 - 1.93507162885177e-06i	-2.44936882942332e-07 + 2.25540324900807e-06i	-1.72297551343933e-06 - 6.95263848375250e-07i	-7.85923467962211e-07 - 3.79403624349967e-06i	-1.68972584273376e-06 + 4.24852980543885e-07i];



%% 生成无线信道
% LoS链路信道
for k = 1:K
    for b = 1:B
        h{k,b} = sparse(M,1);%%%%%%%%%%%%%%%%%%%%%注意
            e0{k} = [ sin(phi(k)) * cos(theta(k)) ; sin(phi(k)) * sin(theta(k)) ; cos(phi(k)) ];
            % e = Rot_Matrix{b}.' * e0;
            if dot( normal_vector{b} , e0{k} ) > 0
                Lambda_LoS(k,b) = 1;
            else
                Lambda_LoS(k,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(K_rice/(K_rice+1)) * sqrt(M) * sqrt(Omega(k,b)) * Lambda_LoS(k,b) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e0{k} ) );
    end
end

%% 测试
for b = 1:B
    Px{b}    = dx * Rot_Matrix{b} * [1;0;0];
    Py{b}    = dy * Rot_Matrix{b} * [0;1;0];
    T{b}     = exp( 1j * 2*pi/lambda * ( kron( delta_x * ( Px{b}.' * e0{1} ) , ones(1,My) ) + kron( ones(Mx,1) , delta_y.' * ( Py{b}.' * e0{1} ) ) ) );

end








for k = 1:K
    for b = 1:B
        % h{k,b} = 0;%%%%%%%%%%%%%%%%%%%%%注意
        for iota = 1:IOTA
            % eta(k,iota,b) = 1/sqrt(IOTA) * Omega(k,b) * 1/sqrt(2) * ( randn(1) + 1j*randn(1) );
            e1{k,b} = [ sin(phi_scatterer(k)) * cos(theta_scatterer(k)) ; sin(phi_scatterer(k)) * sin(theta_scatterer(k)) ; cos(phi_scatterer(k)) ];
            % e = Rot_Matrix{b}.' * e;
            if dot( normal_vector{b} , e1{k,b} ) > 0
                Lambda(k,iota,b) = 1;
            else
                Lambda(k,iota,b) = 0;
            end
            h{k,b} = sparse( h{k,b} + sqrt(1/(K_rice+1)) * sqrt(M) * Lambda(k,iota,b) * eta(k,iota) * 1/sqrt(M) * exp( 1j * 2*pi/lambda * Coor_Ele{b} * e1{k,b} ) );
        end
    end
end
% for k = 1:K
%     H{k} = [];
%     for b = 1:B
%         H{k} = [H{k} ; h{k,b} ];
%     end
% end








end